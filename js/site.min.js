window.TimeMapUtilities={getBoundengRectOffset:function(n){const t=document.getElementById(n).getBoundingClientRect();return{left:t.left+window.scrollX,top:t.top+window.scrollY}},saveAsFile:function(n,t){var r=prompt("Please enter a file name",n),i;r&&(i=document.createElement("a"),i.download=r+".json",i.href="data:application/octet-stream;base64,"+t,document.body.appendChild(i),i.click(),document.body.removeChild(i),DotNet.invokeMethod("MapMyTime","UpdateText",0,r))},openURL:function(){return prompt("Enter a link to Json file to dowload","https://MapMyTime/MapMyTime.json")},runFileInput:function(n){n.value="";n.click()},alertMessage:function(n){alert(n)},unsavedChangesOK:function(){return window.mapHasChanged?confirm("You have unsaved changes, do you want to continue?"):!0},updateURLwithoutReload:function(n){window.history.pushState("data","Map My Time",n)}};window.D3TimeMapUtilities={positionIcons:function(){var n=document.getElementById("svg");if(n){var t=n.getBoundingClientRect(),r=document.getElementById("saveIcon"),u=r.getBoundingClientRect(),i=n.createSVGPoint();if(i.y=t.top+4,i.x=t.right-u.width-4,r.setAttribute("x",i.matrixTransform(n.getScreenCTM().inverse()).x),r.setAttribute("y",i.matrixTransform(n.getScreenCTM().inverse()).y),window.touchTrigger){let i=d3.zoomTransform(n),r=i.x+window.touchedData.x0*i.k+t.width/2,u=i.y+window.touchedData.y0*i.k+t.width/2;d3.select("topGroup").transition().duration(500).attr("transform","translate("+r+","+u+") scale("+i.k+")");window.touchTrigger=!1}}window.D3TimeMapUtilities.setSmallScreen()},setSmallScreen:function(){window.isScreenSmall=document.body.clientWidth<768?!0:!1},isFirstVisit:function(){return window.D3TimeMapUtilities.getCookie("firstvisit")!=""?!1:!0},setFirstVisit:function(){window.D3TimeMapUtilities.setCookie("firstvisit",!0,90)},getCookie:function(n){for(var t,r=n+"=",f=decodeURIComponent(document.cookie),u=f.split(";"),i=0;i<u.length;i++){for(t=u[i];t.charAt(0)==" ";)t=t.substring(1);if(t.indexOf(r)==0)return t.substring(r.length,t.length)}return""},setCookie:function(n,t,i){var r=new Date,u;r.setTime(r.getTime()+i*864e5);u="expires="+r.toUTCString();document.cookie=n+"="+t+";"+u+";path=/"},createD3Tree:function(n){async function at(n,i){let o=await p(!0,"AddNewNodeAsync",i,n,h);var r=d3.hierarchy(JSON.parse(o)),u,f=d3.select("#node"+r.data.parentNodeId);u=f.empty()?t:f.datum();r.x0=r.x=r.data.xCoordinate;r.y0=r.y=r.data.yCoordinate;r.depth=r.data.nodedepth;r.parent=u;u.children||(u.children=[],u.data.children=[]);u.children.push(r);u.data.children.push(r.data);e();s();nt||d(r);nt=!1}function dt(n){var t=d3.selectAll(".show");(t.size()!==1||t.datum().data.nodeid!==n)&&d3.selectAll(".asyncflag").empty()&&(t.classed("show",!1),d3.select("#highlightRect"+n).classed("show",!0))}function pi(){function h(t){d3.select(".node-menu").remove();let h=t.data.autosize;c||l(t.data.nodeid,10);var i=ni(t.data.nodeid);ft.append("g").attr("class","node-menu").on("click",function(){d3.event.stopPropagation()}).on("mouseleave",()=>{d3.select(".node-menu").remove(),d3.selectAll(".nodetobechanged").classed("nodetobechanged",!1)}).attr("transform",()=>`translate(${t.x+t.data.width-20},${t.y})`).selectAll("tmp").data(d3.entries(s).filter(function(n){return n.value.attributename==="autosize"?!h:!0}),n=>n.value.menutext).join(function(s){var h=s.append("g").attr("class","menu-entry"),c,l;h.append("rect").attr("id",n=>"menurect"+n.value.attributename).attr("y",function(t,i){return i*n}).attr("width",r+o).attr("height",n).attr("data-fillcolour",t.data.fill).attr("data-nodeid",t.data.nodeid).classed("menurect",!0);h.append("text").text(n=>n.value.menutext).attr("y",function(t,i){return i*n}).attr("dy",(n-f/2)*.75).attr("dx",f).classed("menutext",!0);c=h.append("foreignObject").attr("id",n=>n.value.attributename).on("keyup",function(n){nr(n,t.data.nodeid)}).attr("x",function(n){if(n.value.attributename!=="deletebutton")return r}).attr("y",function(t,i){return i*n}).attr("width",function(n){return n.value.attributename==="deletebutton"?r+o:o}).attr("height",n).attr("data-menuparent",n=>n.value.menuparent);l=c.append(c.attr("data-menuparent")).attr("data-menuelement",n=>n.value.menuelement).attr("class","contextmenudiv");l.append(l.attr("data-menuelement")).attr("type",n=>n.value.menutype).attr("id",n=>"menuel"+n.value.attributename).classed("menuerange",n=>n.value.menutype==="range").classed("menucheckbox",n=>n.value.menutype==="checkbox").classed("trashbutton",n=>n.value.attributename==="deletebutton").attr("width",function(n){return n.value.menutype==="color"?o:n.value.menutype==="button"?o:null}).text(function(n){return n.value.menutype==="button"?"Delete":null}).attr("value",function(n){return n.value.menutype==="checkbox"?null:n.value.menutype==="button"?"Delete":Reflect.get(t.data,n.value.attributename)}).property("checked",function(n){return n.value.menutype==="checkbox"?Reflect.get(t.data,n.value.attributename):!1}).attr("min",function(n){return n.value.menutype==="range"?n.value.minvalue:null}).attr("max",function(n){return n.value.menutype==="range"?n.value.maxvalue:null}).attr("step",function(n){return n.value.menutype==="range"?1:null}).attr("data-nodeid",()=>t.data.nodeid).on("input",function(n){d3.event.stopPropagation();n.value.menutype==="checkbox"?(u(!0,n.value.dotnetmethod,this.dataset.nodeid,this.checked),Reflect.set(d3.select("#node"+this.dataset.nodeid).datum().data,n.value.attributename,this.checked),i=ni(this.dataset.nodeid)):(ur(n.value.dotnetmethod,i,this.value),n.value.menutype==="color"&&tr(i,this.value),n.value.attributename==="fontsizepx"?ri(i,parseInt(this.value)):(gt(),e()))}).on("keydown",function(){(d3.event.key==="ArrowUp"||d3.event.key==="ArrowDown")&&d3.event.preventDefault()}).on("mousedown",function(){d3.event.stopPropagation()}).on("change",function(n){n.value.attributename==="fontsizepx"&&ri(i,parseInt(this.value))}).on("mouseenter focus",function(n){if(d3.select("#menurect"+n.value.attributename).attr("filter","url(#makebrighterfilter)"),n.value.attributename==="deletebutton")ei(i,!0);else return null}).on("mouseleave blur",function(n){if(d3.select("#menurect"+n.value.attributename).attr("filter",null),n.value.attributename==="deletebutton")ei(i,!1);else return null}).on("mouseup",function(n){if(n.value.attributename==="deletebutton")fr(this.dataset.nodeid);else return null})})}function l(i,u){var e,h,l;f=.1;d3.select("#node"+i).selectAll("temptext").data(d3.entries(s)).enter().append("text").text(function(n){return n.value.menutext}).attr("x",-1e3).attr("y",-1e3).attr("class","temptext").style("font-size",u);e=d3.selectAll(".temptext").nodes().map(function(n){return n.getBBox()});r=d3.max(e.map(function(n){return n.width}));f=f*r;r=r+2*f;n=d3.max(e.map(function(n){return(n.height+f/2)*2}));h=d3.select("#node"+i).append("foreignObject").attr("width",r*.5).attr("height",n).attr("class","tempfo");l=h.append("xhtml:div").attr("class","contexmenuflexdiv");l.append("xhtml:input").attr("type","color").attr("value","#007BFF").attr("class","tempinput");o=d3.select(".tempinput").node().getBoundingClientRect().width/t.data.scale;d3.selectAll(".temptext,.tempfo").remove();c=!0}var n,r,f=.1,s=[],o,c=!1;return h.items=function(){if(!arguments.length)return s;for(i in arguments[0])s.push(arguments[0][i]);return rescale=!0,h},h}async function wi(){var n=document.getElementById("svg");n&&document.getElementById("d3SVGdiv").removeChild(n);await ki();kt=pi().items(l);h=bi();window.D3TimeMapUtilities.setSmallScreen();window.isScreenSmall&&(h=h*2);e();document.getElementById("d3SVGdiv").appendChild(f.node());f.call(ct.transform,d3.zoomIdentity.translate(t.data.xTranslate,t.data.yTranslate).scale(t.data.scale));gi();window.D3TimeMapUtilities.positionIcons();st||e();yt(!1)}function bi(){var t=ft.append("foreignObject").attr("height",20).attr("width",60).attr("x",-1e3).attr("y",-1e3).classed("tempfo nodefo",!0);t.append("xhtml:div").attr("id","defaultnodeheightdiv").attr("contenteditable","true").text("temp").classed("flexdiv tempdiv",!0).style("font-size",wt);document.getElementById("d3SVGdiv").appendChild(f.node());let n=d3.select("#defaultnodeheightdiv").node().scrollHeight;return d3.selectAll(".tempdiv, .tempfo").remove(),document.getElementById("d3SVGdiv").removeChild(f.node()),u(window.mapHasChanged,"SetCalculatedNodeHeight",n),n}async function ki(){hi=await y("defaultwidth");g=await y("highlightrectboundary");wt=await y("defaultfontsize");ht=await y("defaultnodetext");o=await y("proximityrectheight");c=await y("proximityrectwidth");l=await y("contextmenuitems")}async function y(n){return await p(window.mapHasChanged,"GetConstantAsync",n)}function gt(){t=d3.hierarchy(JSON.parse(u(window.mapHasChanged,"GetTimeMapJson")));tt(t)}async function ni(n){return await p(window.mapHasChanged,"ReturnNodesToChangeAsync",n)}function di(n){let t=[];n.forEach(n=>{let i={nodeid:n.nodeid,height:n.height,width:n.width,autosize:n.autosize};t.push(i)});vt(t)}async function vt(n){let t=await p(!0,"UpdateNodeDimensionsAsync",n);t.forEach(n=>{var t=d3.select("#node"+n.nodeid).datum().data;t.midpointconnections=n.midpointconnections;t.parentNodeConnection=n.parentnodeconnection;t.connection=n.connection});oi()}function tt(n){n.descendants().forEach(n=>{n.data.nodeid===0&&t.data.children.length===0?(n.x0=n.x=350,n.y0=n.y=255,st=!0):(n.x0=n.x=n.data.xCoordinate,n.y0=n.y=n.data.yCoordinate,n.depth=n.data.nodedepth,st=!1)})}function gi(){f.append("image").attr("id","saveIcon").classed("saveicon img-responsive",!0).attr("width",function(){return window.isScreenSmall?"35":"25"}).attr("height",function(){return window.isScreenSmall?"35":"25"}).attr("cursor","pointer").attr("xlink:href","./css/open-iconic/icons/data-transfer-download.svg").attr("alt","download").on("click",function(){u(!1,"DownloadMap");d3.event.stopPropagation()})}function ti(n){var i=d3.select("#node"+n.data.nodeid).append("g").attr("class","nodecontextmenu").attr("id","contextmenu"+n.data.nodeid),t;i.append("rect").attr("transform",()=>`translate(${0},${-20})`).attr("width",()=>n.data.width).attr("height",20).attr("opacity",0).on("click",function(){d3.event.stopPropagation()});t=i.append("g");t.append("path").attr("id","contextmenuicon").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("fill","#a1d7ce").attr("class","contextmenuicon").attr("stroke-width","0.0").attr("d","M 3.12,8.33 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 C 17.67,6.52 17.17,6 16.55,6 H 3.12 C 2.50,6 2,6.52 2,7.17 c 0,0.64 0.5,1.17 1.12,1.17 z M 16.55,10.67 H 3.12 C 2.5,10.67 2,11.19 2,11.83 2,12.48 2.5,13 3.12,13 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 0,-0.64 -0.5,-1.17 -1.12,-1.17 z m 0,4.67 H 3.12 C 2.5,15.33 2,15.856 2,16.5 c 0,0.64 0.5,1.17 1.12,1.17 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 0,-0.64 -0.5,-1.17 -1.12,-1.17 z");t.append("rect").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("width","20").attr("height","20").attr("fill","none").attr("pointer-events","visible").on("mouseenter",function(){ii(n)}).on("touchstart",function(){if(d3.select("#contextmenuicon").classed("closeicon"))s();else{const n=new Event("mouseenter");this.dispatchEvent(n)}d3.event.preventDefault();d3.event.stopPropagation()}).on("mousedown",function(){d3.select("#contextmenuicon").classed("closeicon")&&s();d3.event.stopPropagation()})}function ii(n){d3.select(".node-menu").empty()&&(d3.select("#contextmenuicon").attr("d","M 2.4803522,7.9936028 14.980252,17.295964 c 0.577062,0.429447 1.526422,0.415594 2.131407,-0.03464 0.595676,-0.4433 0.614291,-1.149809 0.03723,-1.579254 L 4.6489879,6.3797158 C 4.0719266,5.9502695 3.1225664,5.9641226 2.5175821,6.4143486 1.9219052,6.857648 1.8939827,7.5710831 2.4710447,8.0005294 Z M 15.028871,6.3866424 2.5289651,15.689003 c -0.5770619,0.429447 -0.558447,1.135955 0.046537,1.586182 0.5956768,0.443299 1.5450368,0.457152 2.1220988,0.02771 L 17.197508,8.0005294 C 17.774571,7.5710831 17.755956,6.8645746 17.150971,6.4143486 16.555294,5.9710491 15.596625,5.9502695 15.019564,6.3797158 Z"),d3.select("#contextmenuicon").classed("closeicon",!0),kt(n),document.getElementById("menuel"+l[0].attributename).focus());d3.event.stopPropagation()}function nr(n,t){if(d3.event.key==="ArrowUp"){let i=l.findIndex(t=>t.attributename===n.value.attributename);i===0?(s(),document.getElementById("divid"+t).focus()):document.getElementById("menuel"+l[i-1].attributename).focus()}if(d3.event.key==="ArrowDown"){let r=l.findIndex(t=>t.attributename===n.value.attributename),i=document.getElementById("menuel"+l[r+1].attributename);i?i.focus():(s(),document.getElementById("divid"+t).focus())}}function tr(n,t){n.then(function(n){n.forEach(n=>{d3.select("#node"+n).attr("fill",t).datum().data.fill=t})})}function ri(n,t){n.then(function(n){n.forEach(n=>{var i=d3.select("#node"+n);i.datum().data.fontsizepx=t});e()})}function ir(n,t,i){let f=u(!0,"SwitchParent",[n,t,i]),r=d3.hierarchy(JSON.parse(f));r.data.parentNodeId===i?rr(n,t,i,r):e()}function ui(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();r.children.splice(r.children.findIndex(t=>t.data.nodeid===parseInt(n)),1);r.data.children.splice(r.data.children.findIndex(t=>t.nodeid===parseInt(n)),1)}function fi(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();n.parent=r;r.children||(r.children=[]);r.children.push(n);r.data.children.push(n.data)}function rr(n,t,i,r){tt(r);ui(n,t);fi(r,i);e()}async function ur(n,t,i){let r=await t;await DotNet.invokeMethodAsync("MapMyTime",n,r,i)}function u(n,t,...i){return n!==window.mapHasChanged&&yt(n),DotNet.invokeMethod("MapMyTime",t,...i)}async function p(n,t,...i){return n!==window.mapHasChanged&&yt(n),await DotNet.invokeMethodAsync("MapMyTime",t,...i)}function yt(n){window.mapHasChanged=n;n?d3.select("#saveIcon").attr("filter","url(#redfilter"):d3.select("#saveIcon").attr("filter",null)}function ei(n,t){n.then(function(n){n.forEach(n=>{t?d3.select("#node"+n).attr("filter","url(#deletenodefilter)"):d3.select("#node"+n).attr("filter",null)})})}function fr(n){let t=d3.select("#node"+n).datum().data.parentNodeId,i=u(!0,"DeleteNode",n);ui(n,t);i.length>0&&i.forEach(n=>{let i=d3.hierarchy(JSON.parse(n));tt(i);fi(i,t)});s();e()}function s(){d3.selectAll(".node-menu").remove();d3.selectAll(".nodecontextmenu").remove()}function er(n){if(n.data.name.startsWith(ht)){d(n);return}let t,i,u,f,r;if(document.caretPositionFromPoint?(t=document.caretPositionFromPoint(d3.event.clientX,d3.event.clientY),i=t.offsetNode,u=t.offset):document.caretRangeFromPoint&&(t=document.caretRangeFromPoint(d3.event.clientX,d3.event.clientY),i=t.startContainer,u=t.startOffset),i)r=document.createRange(),f=window.getSelection(),r.setStart(i,u),r.collapse(!0),f.removeAllRanges(),f.addRange(r);else{d(n);document.getElementById("divid"+n.data.nodeid).focus();return}}function d(n){var t=document.getElementById("divid"+n.data.nodeid),r=window.getSelection(),i=document.createRange(),u=1;n.data.name.startsWith(ht)&&(u=0);i.setStart(t,u);i.setEnd(t,1);r.removeAllRanges();r.addRange(i);t.focus()}function or(n){if(d3.event.altKey&&d3.event.shiftKey&&d3.event.key.startsWith("Arrow")){let t=u(window.mapHasChanged,"ProcessArrowEvent",d3.event.key,n.data.nodeid);if(t.navigatetoid>0){let n=d3.select("#node"+t.navigatetoid).datum();d(n)}else if(t.navigatetoid===0&&t.newnodeparentid!=0){let n=[t.x,t.y];at(t.newnodeparentid,n)}}d3.event.altKey&&d3.event.key==="m"&&ii(n)}function e(){const i=t.descendants(),r=a.transition().duration(si);var n=[];ft.selectAll(".standardNode").data(i.filter(n=>n.depth),n=>n.data.nodeid).join(function(t){var i=t.append("g").call(nodeDragListener).attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill-opacity",1).attr("stroke-opacity",1).attr("id",n=>"node"+n.data.nodeid).attr("fill",n=>n.data.fill).attr("cursor","pointer").classed("standardNode",!0).on("mouseenter",function(n){d3.select("#contextmenu"+n.data.nodeid).empty()&&!b&&(s(),ti(n),document.activeElement!==document.getElementById("divid"+n.data.nodeid)&&d(n))}).on("mouseleave",function(){d3.selectAll(".nodecontextmenu").remove()}).on("touchend",function(n){window.touchTrigger=!0;window.touchedData=n}).on("click",function(n){d3.event.srcElement.id.startsWith("divid")||d(n);d3.event.stopPropagation()}),r;i.append("rect").attr("id",n=>"rectid"+n.data.nodeid).attr("class","noderect").attr("width",n=>n.data.width).attr("height",n=>n.data.height).attr("rx",2).attr("ry",2).attr("stroke","#cce9e5");r=i.append("foreignObject").attr("id",n=>"foid"+n.data.nodeid).attr("class","nodefo").attr("width",n=>n.data.width).attr("height",n=>n.data.height);r.append("xhtml:div").attr("id",n=>"divid"+n.data.nodeid).attr("tabindex",n=>n.data.nodeid).attr("contenteditable","true").attr("class","flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif").html(n=>n.data.name).on("touchend",function(n){window.touchTrigger=!0;window.touchedData=n}).on("mousedown",function(){w===this.id&&d3.event.stopPropagation()}).on("click",function(n){!w===this.id&&er(n);w=this.id}).on("blur",function(n){w="";n.data.name!==this.innerHTML&&(n.data.name=this.innerHTML,p(!0,"UpdateText",n.data.nodeid,this.innerHTML))}).on("keydown",function(n){or(n);d3.event.stopPropagation()}).on("keyup",function(n){if(n.data.autosize){var t=this.scrollHeight,i=!1;window.isScreenSmall?t>h&&n.data.height!==t&&(i=!0):n.data.height!==t&&(i=!0);i&&(n.data.height=t,vt([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}]),d3.select("#rectid"+n.data.nodeid).attr("height",n.data.height),d3.select("#foid"+n.data.nodeid).attr("height",n.data.height),d3.select("#highlightRect"+n.data.nodeid).attr("height",n.data.height+g),d3.select("#resizehandle"+n.data.nodeid).attr("cy",n.data.height),d3.select("#proximityrect"+n.data.nodeid).attr("height",n.data.height+o))}}).on("paste",function(n){if(n.data.autosize){var t=this;setTimeout(function(){t.dispatchEvent(new Event("keyup"))})}});return i.append("circle").attr("id",n=>"resizehandle"+n.data.nodeid).attr("cx",n=>n.data.width).attr("cy",n=>n.data.height).attr("class","resizehandle").attr("r",7).attr("fill",n=>n.data.fill).call(ai),i.append("rect").attr("class","highlightRect").attr("id",n=>"highlightRect"+n.data.nodeid).attr("transform","translate(-3,-3)").attr("width",n=>n.data.width+6).attr("height",function(t){if(t.data.autosize&&d3.select("#divid"+t.data.nodeid).node()){var i=d3.select("#divid"+t.data.nodeid).node().scrollHeight,r=!1;window.isScreenSmall?i>h&&t.data.height!==i&&(r=!0):t.data.height!==i&&(r=!0);r&&(t.data.height=i,n.push(t.data),d3.select("#rectid"+t.data.nodeid).attr("height",t.data.height),d3.select("#resizehandle"+t.data.nodeid).attr("cy",t.data.height),d3.select("#foid"+t.data.nodeid).attr("height",t.data.height))}return t.data.height+g}).attr("rx",2).attr("ry",2).attr("opacity",.2).style("fill","red").attr("pointer-events","none"),i},function(t){t.attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill",n=>n.data.fill).attr("class",n=>n.data.cssClass);t.select(".flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif");t.select(".noderect").attr("height",function(t){if(t.data.autosize){var i=d3.select("#divid"+t.data.nodeid).node().scrollHeight,r=!1;window.isScreenSmall?i>h&&t.data.height!==i&&(r=!0):t.data.height!==i&&(r=!0);r&&(t.data.height=i,n.push(t.data))}return t.data.height}).attr("width",n=>n.data.width);t.select(".nodefo").attr("height",n=>n.data.height).attr("width",n=>n.data.width);t.select(".resizehandle").attr("cx",n=>n.data.width).attr("cy",n=>n.data.height);t.select(".highlightRect").attr("height",n=>n.data.height+g).attr("width",n=>n.data.width+g);t.select(".linklump").attr("cx",n=>n.data.width/2)},n=>n.call(n=>n.transition(r).remove().attr("transform",()=>`translate(${pt-24},${4})`).attr("fill-opacity",0).attr("stroke-opacity",0)));n.length>0&&di(n);oi();hr(i)}function sr(n){li.selectAll(".linklump").data(n.filter(n=>n.target.depth===1),n=>n.target.data.nodeid).join(function(n){n.append("image").call(linkDragListener).attr("transform",n=>`translate(${n.target.x+n.target.data.width/2-4},${n.target.y-8})`).attr("width",9).attr("height",9).attr("class","linklump").attr("id",n=>"linklump"+n.target.data.nodeid).style("color",n=>n.target.data.fill).attr("xlink:href","./css/open-iconic/icons/caret-top.svg")},function(n){n.attr("transform",n=>`translate(${n.target.x+n.target.data.width/2+-4},${n.target.y-8})`)},function(n){n.remove()})}function oi(){const n=t.links();lt.selectAll("path").data(n,n=>n.target.id).join(function(n){n.append("path").call(linkDragListener).classed("link",!0).attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));n.append("path").call(linkDragListener).classed("linkborder",!0).attr("id",n=>"linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},function(n){n.attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},n=>n.call(n=>n.attr("d",n=>{const t={x:n.source.x,y:n.source.y};return r({source:t,target:t})}).remove()));sr(n)}function hr(n){ci.selectAll(".proximityRect").data(n.filter(n=>n.depth),n=>n.data.nodeid).join(function(n){n.append("rect").classed("proximityRect",!0).attr("id",n=>"proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-c/2},${n.y-o/2})`).attr("width",n=>n.data.width+c).attr("height",n=>n.data.height+o).attr("opacity",0).style("fill","grey").on("mousemove",function(n){vi(n.data.nodeid)}).on("mouseout",function(){d3.event.relatedTarget?d3.select(d3.event.relatedTarget).classed("proximityRect")||(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1)):(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1))}).on("mouseenter",function(){d3.select(".node-menu").remove();d3.selectAll(".asyncflag").classed("asyncflag",!1)})},function(n){n.attr("transform",n=>`translate(${n.x-c/2},${n.y-o/2})`).attr("width",n=>n.data.width+c).attr("height",n=>n.data.height+o)},function(n){n.remove()})}var t=d3.hierarchy(JSON.parse(n)),r,ct,v;const si=d3.event&&d3.event.altKey?2500:250;r=d3.linkHorizontal().x(function(n){return n.x}).y(function(n){return n.y});const pt=700;tt(t);window.mapHasChanged=!1;var st,h,hi,c,o,wt,g,nt=!1,w="",bt,ht,l,kt,it=!1,b=!1,k=!1,rt,ut;const f=d3.create("svg").attr("id","svg").attr("viewBox",[0,0,pt,700]).style("font",t.data.fontsizepx+"px sans-serif").style("user-select","none").on("click",function(){var t,n;if(w!==""){document.getElementById(w).blur();return}t=d3.mouse(document.getElementsByTagName("g")[0]);d3.event.stopPropagation();let i=d3.select(".show");n=0;i.empty()||(n=i.datum().data.nodeid);at(n,t)}).on("touchstart",function(){d3.event.touches.length===1&&(d3.event.touches[0].target.id.includes("svg")||d3.event.touches[0].target.id.includes("proximityrect"))&&(nt=!0,bt=d3.mouse(document.getElementsByTagName("g")[0]))}).on("touchmove",function(){nt=!1}).on("touchend",function(){if(nt){var n=0;if(d3.event.changedTouches[0].target.id.includes("proximityrect")){let t=d3.select(d3.event.changedTouches[0].target).datum().data.nodeid;n=u(window.mapHasChanged,"GetParentNodeIdFromProximalNode",t,d3.mouse(document.getElementsByTagName("g")[0]))}at(n,bt);d3.event.preventDefault()}});f.append("filter").attr("id","deletenodefilter").append("feGaussianBlur").attr("stdDeviation","5");f.append("filter").attr("id","makebrighterfilter").append("feColorMatrix").attr("type","matrix").attr("values","1.2 0 0 0 0 0 1.2 0 0 0 0 0 1.2 0 0 0 0 0 1 0");f.append("filter").attr("id","redfilter").append("feColorMatrix").attr("type","matrix").attr("values","0 0 0 1 0 0 0 0 0 0 1 1 1 0 0 0 0 0 1.5 0");const a=f.append("g").attr("fill","none").attr("width","100%").attr("height","100%").attr("id","topGroup").attr("class","topGroup").on("mouseleave",function(){var n=d3.selectAll(".show");n.empty()||n.classed("show",!1)});ct=d3.zoom().clickDistance(10).on("zoom",function(){k||d3.event.target.nodeName!=="PATH"&&a.attr("transform",d3.event.transform)}).on("end",function(){k||d3.event.target.nodeName!=="PATH"&&(d3.event.transform.k===1&&d3.event.transform.x===0&&d3.event.transform.y===0||(u(!0,"UpdateTranslation",d3.event.transform),t.data.scale=d3.event.transform.k))});f.call(ct).on("dblclick.zoom",null);const ci=a.append("g").attr("id","proximityrect"),lt=a.append("g").attr("id","linkgroup").attr("class","glink"),ft=a.append("g").attr("id","nodegroup"),li=a.append("g").attr("id","lumpgroup");nodeDragListener=d3.drag().on("start",function(n){var t,i,r;k=!0;b=!1;t=!1;d3.touches(this).length>1&&(t=!0,d3.event.sourceEvent.preventDefault());(d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey||t)&&(it=!0,rt=0,ut=0,i=a.append("g").attr("id","draggroup"),r=i.append("g").attr("id","linkdraggroup").attr("class","glink"),n.descendants().forEach(t=>{n.data.nodeid!=t.data.nodeid&&(i.append(function(){return d3.select("#node"+t.data.nodeid).remove().node()}),r.append(function(){return d3.select("#link-"+t.data.parentNodeId+"-"+t.data.nodeid).remove().node()}),r.append(function(){return d3.select("#linkborder-"+t.data.parentNodeId+"-"+t.data.nodeid).remove().node()}))}));d3.event.sourceEvent.stopPropagation()}).on("drag",function(n){if(window.touchTrigger=!1,k){b||(s(),b=!0);n.x+=d3.event.dx;n.y+=d3.event.dy;var t=d3.select("#node"+n.data.nodeid);if(t.attr("transform","translate("+n.x+","+n.y+")"),it){if(n.data.parentNodeId!==0){let t=u(!0,"UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0);d3.select("#link-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>r({source:t.linkendpoints[1],target:t.linkendpoints[0]}))}rt+=d3.event.dx;ut+=d3.event.dy;d3.select("#draggroup").attr("transform","translate("+rt+","+ut+")")}else{let t=DotNet.invokeMethod("MapMyTime","RecalculateMovedNodeLinks",n.data.nodeid,n.x,n.y);t.forEach(t=>{t.nodeid!==n.data.nodeid?d3.select("#link-"+n.data.nodeid+"-"+t.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]})):n.data.parentNodeId!==0&&d3.select("#link-"+n.data.parentNodeId+"-"+t.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]}))})}}}).on("end",function(n){var i,f;if(k&&(k=!1,b)){b=!1;n.data.xCoordinate=n.x0=n.x;n.data.yCoordinate=n.y0=n.y;let t=u(!0,"UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0);n.data.midpointconnections=JSON.parse(JSON.stringify(t.midpointconnections));n.data.parentNodeConnection=t.parentnodeconnection;n.data.connection=t.connection;n.data.parentNodeId===0?d3.select("#linklump"+n.data.nodeid).attr("transform",()=>`translate(${n.x+n.data.width/2-4}, ${n.y-8})`):d3.select("#linkborder-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]}));it?(i=[],n.descendants().forEach(t=>{if(i.push(t.data.nodeid),n.data.nodeid!=t.data.nodeid){t.x=t.data.xCoordinate+=rt;t.y=t.data.yCoordinate+=ut;let n=u(!0,"UpdateImpactedNode",t.data.nodeid,t.x,t.y,!0);t.data.midpointconnections=JSON.parse(JSON.stringify(n.midpointconnections));t.data.parentNodeConnection=n.parentnodeconnection;t.data.connection=n.connection;lt.append(function(){var i=d3.select("#link-"+t.data.parentNodeId+"-"+t.data.nodeid);return i.attr("d",r({source:n.linkendpoints[0],target:n.linkendpoints[1]})),i.remove().node()});lt.append(function(){var i=d3.select("#linkborder-"+t.data.parentNodeId+"-"+t.data.nodeid);return i.attr("d",r({source:n.linkendpoints[0],target:n.linkendpoints[1]})),i.remove().node()});ft.append(function(){var n=d3.select("#node"+t.data.nodeid);return n.attr("transform","translate("+t.x+","+t.y+")"),n.remove().node()})}p(!0,"UpdateProximityMapAsync",i);d3.select("#proximityrect"+t.data.nodeid).attr("transform",()=>`translate(${t.x-c/2},${t.y-o/2})`)}),d3.select("#draggroup").remove(),it=!1):(f=d3.selectAll("path").filter('[id^="link-'+n.data.nodeid+'-"]'),f.attr("d",n=>{let t=u(!0,"UpdateImpactedNode",n.target.data.nodeid,n.target.x,n.target.y,!1);n.target.data.parentNodeConnection=t.parentnodeconnection;n.target.data.connection=t.connection;var i=r({source:t.linkendpoints[0],target:t.linkendpoints[1]});return d3.select("#linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",i),i}),p(!0,"UpdateProximityMapAsync",[n.data.nodeid]),d3.select("#proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-c/2},${n.y-o/2})`));ti(n)}});v=-1;linkDragListener=d3.drag().on("start",function(n){d3.event.sourceEvent.type==="touchstart"&&d3.event.sourceEvent.preventDefault();const t=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid),i=n.target.data.midpointconnections[n.target.data.connection];t.classed("linkdragging",!0).attr("d",()=>{const n={x:d3.event.x,y:d3.event.y};return r({source:n,target:i})}).attr("pointer-events","none")}).on("drag",function(n){const u=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid);u.attr("d",()=>{const t={x:d3.event.x,y:d3.event.y};return r({source:t,target:n.target.data.midpointconnections[n.target.data.connection]})});var i=d3.mouse(d3.select("body").node()),t=document.elementFromPoint(i[0],i[1]);t&&t.id.includes("proximityrect")&&yi(d3.select(t).datum().data.nodeid,n.target.data.nodeid)}).on("end",function(n){const i=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid);i.classed("linkdragging",!1).attr("pointer-events","auto").attr("d",()=>{const t={x:d3.event.x,y:d3.event.y};return r({source:t,target:n.target.data.midpointconnections[n.target.data.connection]})});var t=d3.select(".show");if(t.empty()&&(t=d3.select(".nodecontextmenu")),v=t.empty()?0:t.datum().data.nodeid,v===n.target.data.nodeid&&(v=0),d3.selectAll(".show").classed("show",!1),v===n.source.data.nodeid){i.attr("d",()=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));return}ir(n.target.data.nodeid,n.source.data.nodeid,v)});var et,ot,ai=d3.drag().on("start",function(n){d3.event.sourceEvent.stopPropagation();n.data.autosize=!1;et=n.data.height;ot=n.data.width}).on("drag",function(n){et+=d3.event.dy;ot+=d3.event.dx;let t=!1;et>1&&(n.data.height=et,t=!0);ot>1&&(n.data.width=ot,t=!0);t&&(vt([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}]),d3.select("#foid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height),d3.select("#rectid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height))}).on("end",function(){gt();e()}),vi=function(n){DotNet.invokeMethodAsync("MapMyTime","GetParentNodeIdFromProximalNodeAsync",n,d3.mouse(document.getElementsByTagName("g")[0])).then(function(n){dt(n)})},yi=function(n,t){DotNet.invokeMethodAsync("MapMyTime","GetConnectionNodeId",n,d3.mouse(document.getElementsByTagName("g")[0]),t).then(function(n){dt(n)})};wi()}};window.addEventListener("resize",window.D3TimeMapUtilities.positionIcons);window.addEventListener("beforeunload",function(n){window.mapHasChanged&&(n.preventDefault(),n.returnValue="")});