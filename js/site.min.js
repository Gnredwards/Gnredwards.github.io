window.TimeMapUtilities={getBoundengRectOffset:function(n){const t=document.getElementById(n).getBoundingClientRect();return{left:t.left+window.scrollX,top:t.top+window.scrollY}},saveAsFile:function(n,t){var r=prompt("Please enter a file name",n),i;r&&(i=document.createElement("a"),i.download=r+".json",i.href="data:application/octet-stream;base64,"+t,document.body.appendChild(i),i.click(),document.body.removeChild(i),DotNet.invokeMethod("MapMyTime","UpdateText",0,r))},openURL:function(){return prompt("Enter a link to Json file to dowload","https://MapMyTime/MapMyTime.json")},cursorStyle:function(n){document.body.style.cursor=n},runFileInput:function(){fileInput.click()},alertMessage:function(n){alert(n)},unsavedChangesOK:function(){return window.mapHasChanged?confirm("You have unsaved changes, do you want to continue?"):!0},updateURLwithoutReload:function(n){window.history.pushState("data","Map My Time",n)}},function(){window.blazorLocalStorage={get:n=>n in localStorage?JSON.parse(localStorage[n]):null,set:(n,t)=>{localStorage[n]=JSON.stringify(t)},"delete":n=>{delete localStorage[n]}}}();window.D3TimeMapUtilities={positionIcons:function(){var n=document.getElementById("svg");if(n){var t=n.getBoundingClientRect(),r=document.getElementById("saveIcon"),u=r.getBoundingClientRect(),i=n.createSVGPoint();if(i.y=t.top+4,i.x=t.right-u.width-4,r.setAttribute("x",i.matrixTransform(n.getScreenCTM().inverse()).x),r.setAttribute("y",i.matrixTransform(n.getScreenCTM().inverse()).y),window.touchTrigger){let i=d3.zoomTransform(n),r=i.x+window.touchedData.x0*i.k+t.width/2,u=i.y+window.touchedData.y0*i.k+t.width/2;d3.select("topGroup").transition().duration(500).attr("transform","translate("+r+","+u+") scale("+i.k+")");window.touchTrigger=!1}}window.D3TimeMapUtilities.setSmallScreen()},setSmallScreen:function(){window.isScreenSmall=document.body.clientWidth<768?!0:!1},isFirstVisit:function(){return window.D3TimeMapUtilities.getCookie("firstvisit")!=""?!1:!0},setFirstVisit:function(){window.D3TimeMapUtilities.setCookie("firstvisit",!0,90)},getCookie:function(n){for(var t,r=n+"=",f=decodeURIComponent(document.cookie),u=f.split(";"),i=0;i<u.length;i++){for(t=u[i];t.charAt(0)==" ";)t=t.substring(1);if(t.indexOf(r)==0)return t.substring(r.length,t.length)}return""},setCookie:function(n,t,i){var r=new Date,u;r.setTime(r.getTime()+i*864e5);u="expires="+r.toUTCString();document.cookie=n+"="+t+";"+u+";path=/"},createD3Tree:function(n){function ur(n){ot=!0;ii(n)}function ii(n){a=!0;gi=0;nr=0;d3.select("#draggroup").remove();var t=y.append("g").attr("id","draggroup"),i=t.append("g").attr("id","linkdraggroup").attr("class","glink");sr(n.descendants());n.descendants().forEach(r=>{n.data.nodeid!=r.data.nodeid&&(t.append(function(){return d3.select("#node"+r.data.nodeid).remove().node()}),i.append(function(){return d3.select("#gpathlink-"+r.data.parentNodeId+"-"+r.data.nodeid).remove().node()}))})}function ui(n,t){bt([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}],t);d3.select("#foid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height);d3.select("#rectid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height)}async function wt(n,i){let e=await o(!0,"AddNewNodeAsync",i,n,h);var r=d3.hierarchy(JSON.parse(e)),u,f=d3.select("#node"+r.data.parentNodeId);u=f.empty()?t:f.datum();r.x0=r.x=r.data.xCoordinate;r.y0=r.y=r.data.yCoordinate;r.depth=r.data.nodedepth;r.parent=u;u.children||(u.children=[],u.data.children=[]);u.children.push(r);u.data.children.push(r.data);ft("enter");s();w||g(r);w=!1}function fr(n){var t=d3.select("#node"+n.data.nodeid);if(t.attr("transform","translate("+n.x+","+n.y+")"),a){if(n.data.parentNodeId!==0){let t=r(!0,"UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0);d3.select("#link-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>u({source:t.linkendpoints[1],target:t.linkendpoints[0]}))}d3.select("#draggroup").attr("transform","translate("+(n.x-initialX)+","+(n.y-initialY)+")")}else er(n)}function er(n){let t=r(!0,"RecalculateMovedNodeLinks",n.data.nodeid,n.x,n.y);t.forEach(t=>{t.nodeid!==n.data.nodeid?d3.select("#link-"+n.data.nodeid+"-"+t.nodeid).attr("d",()=>u({source:t.linkendpoints[0],target:t.linkendpoints[1]})):n.data.parentNodeId!==0&&d3.select("#link-"+n.data.parentNodeId+"-"+t.nodeid).attr("d",()=>u({source:t.linkendpoints[0],target:t.linkendpoints[1]}))})}function or(n){var t=d3.selectAll("path").filter('[id^="link-'+n.data.nodeid+'-"]');t.attr("d",n=>{let t=r(!0,"UpdateImpactedNode",n.target.data.nodeid,n.target.x,n.target.y,!1);n.target.data.parentNodeConnection=t.parentnodeconnection;n.target.data.connection=t.connection;var i=u({source:t.linkendpoints[0],target:t.linkendpoints[1]});return d3.select("#linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",i),i});o(!0,"UpdateProximityMapAsync",[n.data.nodeid]);d3.select("#proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-c/2},${n.y-e/2})`)}function oi(n){var t=d3.selectAll(".show");(t.size()!==1||t.datum().data.nodeid!==n)&&d3.selectAll(".asyncflag").empty()&&(t.classed("show",!1),d3.select("#highlightRect"+n).classed("show",!0))}function sr(n){var t=d3.selectAll(".show");t.classed("show",!1);n.forEach(n=>{d3.select("#highlightRect"+n.data.nodeid).classed("show",!0)})}function hr(){function s(t){d3.select(".node-menu").remove();let s=t.data.autosize;h||c(t.data.nodeid,10);var i=si(t.data.nodeid);it.append("g").attr("class","node-menu").on("click",function(n){n.stopPropagation()}).on("mouseleave",()=>{d3.select(".node-menu").remove(),d3.selectAll(".nodetobechanged").classed("nodetobechanged",!1)}).attr("transform",()=>`translate(${t.x+t.data.width-20},${t.y})`).selectAll("tmp").data(d3.filter(o,function(n){return n.attributename==="autosize"?!s:!0}),n=>n.menutext).join(function(o){var s=o.append("g").attr("class","menu-entry"),h,c;s.append("rect").attr("id",n=>"menurect"+n.attributename).attr("y",function(t,i){return i*n}).attr("width",u+e).attr("height",n).attr("data-fillcolour",t.data.fill).attr("data-nodeid",t.data.nodeid).classed("menurect",!0);s.append("text").text(n=>n.menutext).attr("y",function(t,i){return i*n}).attr("dy",(n-f/2)*.75).attr("dx",f).classed("menutext",!0);h=s.append("foreignObject").attr("id",n=>n.attributename).on("keyup",function(n){wr(n,t.data.nodeid)}).attr("x",function(n){if(n.attributename!=="deletebutton")return u}).attr("y",function(t,i){return i*n}).attr("width",function(n){return n.attributename==="deletebutton"?u+e:e}).attr("height",n).attr("data-menuparent",n=>n.menuparent);c=h.append(h.attr("data-menuparent")).attr("data-menuelement",n=>n.menuelement).attr("class","contextmenudiv");c.append(c.attr("data-menuelement")).attr("type",n=>n.menutype).attr("id",n=>"menuel"+n.attributename).classed("menuerange",n=>n.menutype==="range").classed("menucheckbox",n=>n.menutype==="checkbox").classed("trashbutton",n=>n.attributename==="deletebutton").attr("width",function(n){return n.menutype==="color"?e:n.menutype==="button"?e:null}).text(function(n){return n.menutype==="button"?"Delete":null}).attr("value",function(n){return n.menutype==="checkbox"?null:n.menutype==="button"?"Delete":Reflect.get(t.data,n.attributename)}).property("checked",function(n){return n.menutype==="checkbox"?Reflect.get(t.data,n.attributename):!1}).attr("min",function(n){return n.menutype==="range"?n.minvalue:null}).attr("max",function(n){return n.menutype==="range"?n.maxvalue:null}).attr("step",function(n){return n.menutype==="range"?1:null}).attr("data-nodeid",()=>t.data.nodeid).on("input",function(n,t){n.stopPropagation();t.menutype==="checkbox"?(r(!0,t.dotnetmethod,parseInt(this.dataset.nodeid),this.checked),Reflect.set(d3.select("#node"+this.dataset.nodeid).datum().data,t.attributename,this.checked),i=si(this.dataset.nodeid)):(gr(t.dotnetmethod,i,this.value),t.menutype==="color"?br(i,this.value):t.attributename==="fontsizepx"?li(i,parseInt(this.value)):(vr(),ft("update")))}).on("keydown",function(n){(n.key==="ArrowUp"||n.key==="ArrowDown")&&n.preventDefault()}).on("keyup",function(n,t){(n.key===" "||n.key==="Enter")&&t.attributename==="deletebutton"&&pi(parseInt(this.dataset.nodeid))}).on("mousedown",function(n){n.stopPropagation()}).on("change",function(n,t){t.attributename==="fontsizepx"&&li(i,parseInt(this.value))}).on("mouseenter focus",function(n,t){if(d3.select("#menurect"+t.attributename).attr("filter","url(#makebrighterfilter)"),t.attributename==="deletebutton")yi(i,!0);else return null}).on("mouseleave blur",function(n,t){if(d3.select("#menurect"+t.attributename).attr("filter",null),t.attributename==="deletebutton")yi(i,!1);else return null}).on("mouseup",function(n,t){if(t.attributename==="deletebutton")pi(parseInt(this.dataset.nodeid));else return null})})}function c(i,r){var s,c,l;f=.1;d3.select("#node"+i).selectAll("temptext").data(o).enter().append("text").text(function(n){return n.menutext}).attr("x",-1e3).attr("y",-1e3).attr("class","temptext").style("font-size",r);s=d3.selectAll(".temptext").nodes().map(function(n){return n.getBBox()});u=d3.max(s.map(function(n){return n.width}));f=f*u;u=u+2*f;n=d3.max(s.map(function(n){return(n.height+f/2)*2}));c=d3.select("#node"+i).append("foreignObject").attr("width",u*.5).attr("height",n).attr("class","tempfo");l=c.append("xhtml:div").attr("class","contexmenuflexdiv");l.append("xhtml:input").attr("type","color").attr("value","#007BFF").attr("class","tempinput");e=d3.select(".tempinput").node().getBoundingClientRect().width/t.data.scale;d3.selectAll(".temptext,.tempfo").remove();h=!0}var n,u,f=.1,o=[],e,h=!1;return s.items=function(){if(!arguments.length)return o;for(i in arguments[0])o.push(arguments[0][i]);return rescale=!0,s},s}async function cr(){var n=document.getElementById("svg");n&&document.getElementById("d3SVGdiv").removeChild(n);await ar();ni=hr().items(l);h=lr();window.D3TimeMapUtilities.setSmallScreen();window.isScreenSmall&&(h=h*2);et&&ft("all");document.getElementById("d3SVGdiv").appendChild(f.node());f.call(yt.transform,d3.zoomIdentity.translate(t.data.xTranslate,t.data.yTranslate).scale(t.data.scale));pr();window.D3TimeMapUtilities.positionIcons();et||ou();kt(!1)}function lr(){var t=it.append("foreignObject").attr("height",20).attr("width",60).attr("x",-1e3).attr("y",-1e3).classed("tempfo nodefo",!0);t.append("xhtml:div").attr("id","defaultnodeheightdiv").attr("contenteditable","true").text("temp").classed("flexdiv tempdiv",!0).style("font-size",gt);document.getElementById("d3SVGdiv").appendChild(f.node());let n=d3.select("#defaultnodeheightdiv").node().scrollHeight;return d3.selectAll(".tempdiv, .tempfo").remove(),document.getElementById("d3SVGdiv").removeChild(f.node()),r(window.mapHasChanged,"SetCalculatedNodeHeight",n),n}async function ar(){di=await d("defaultwidth");tt=await d("highlightrectboundary");gt=await d("defaultfontsize");vt=await d("defaultnodetext");e=await d("proximityrectheight");c=await d("proximityrectwidth");let n=await o(window.mapHasChanged,"GetContextMenuItems");l=JSON.parse(n)}async function d(n){return await o(window.mapHasChanged,"GetConstantAsync",n)}function vr(){t=d3.hierarchy(JSON.parse(r(window.mapHasChanged,"GetTimeMapJson")));rt(t)}async function si(n){return await o(window.mapHasChanged,"ReturnNodesToChangeAsync",parseInt(n))}function bt(n,t){let i=[];n.forEach(n=>{let t={nodeid:n.nodeid,height:n.height,width:n.width,autosize:n.autosize};i.push(t)});yr(JSON.stringify(i),n,t)}async function yr(n,t,i){let u=await o(!0,"UpdateNodeDimensionsAsync",n,i),r=[];u.forEach(n=>{let t=JSON.parse(n);d3.select("#node"+t.nodeid).datum().data.midpointconnections=t.midpointconnections;d3.select("#node"+t.nodeid).datum().data.parentNodeConnection=t.parentnodeconnection;d3.select("#node"+t.nodeid).datum().data.connection=t.connection;r.push(t.nodeid)});bi(r)}function rt(n){n.descendants().forEach(n=>{n.data.nodeid===0&&t.data.children.length===0?(n.x0=n.x=350,n.y0=n.y=255,et=!0):(n.x0=n.x=n.data.xCoordinate,n.y0=n.y=n.data.yCoordinate,n.depth=n.data.nodedepth,et=!1)})}function pr(){f.append("image").attr("id","saveIcon").classed("saveicon img-responsive",!0).attr("width",function(){return window.isScreenSmall?"35":"25"}).attr("height",function(){return window.isScreenSmall?"35":"25"}).attr("cursor","pointer").attr("xlink:href","./css/open-iconic/icons/data-transfer-download.svg").attr("alt","download").on("click",function(n){r(!1,"DownloadMap");n.stopPropagation()})}function hi(n){var i=d3.select("#node"+n.data.nodeid).append("g").attr("class","nodecontextmenu").attr("id","contextmenu"+n.data.nodeid),t;i.append("rect").attr("transform",()=>`translate(${0},${-20})`).attr("width",()=>n.data.width).attr("height",20).attr("opacity",0).on("click",function(n){n.stopPropagation()});t=i.append("g");t.append("path").attr("id","contextmenuicon").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("class","contextmenuicon").attr("d","M 0, 4 H 15 m -15, 6 H 15 m -15, 6 H 15");t.append("rect").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("width","20").attr("height","20").attr("fill","none").attr("pointer-events","visible").on("mouseenter",function(){ci(n)}).on("touchstart",function(n){if(d3.select("#contextmenuicon").classed("closeicon"))s();else{const n=new Event("mouseenter");this.dispatchEvent(n)}n.preventDefault();n.stopPropagation()}).on("mousedown",function(n){d3.select("#contextmenuicon").classed("closeicon")&&s();n.stopPropagation()})}function ci(n){d3.select(".node-menu").empty()&&(d3.select("#contextmenuicon").attr("d","M 0,4 L 12,16 M 0,16 L 12,4"),d3.select("#contextmenuicon").classed("closeicon",!0),ni(n),document.getElementById("menuel"+l[0].attributename).focus());event.stopPropagation()}function wr(n,t){if(event.key==="ArrowUp"){let i=l.findIndex(t=>t.attributename===n.value.attributename);i===0?(s(),document.getElementById("divid"+t).focus()):document.getElementById("menuel"+l[i-1].attributename).focus()}if(event.key==="ArrowDown"){let r=l.findIndex(t=>t.attributename===n.value.attributename),i=document.getElementById("menuel"+l[r+1].attributename);i?i.focus():(s(),document.getElementById("divid"+t).focus())}}function br(n,t){n.then(function(n){n.forEach(n=>{d3.select("#node"+n).attr("fill",t).datum().data.fill=t})})}function li(n,t){n.then(function(i){i.forEach(n=>{var i=d3.select("#node"+n);i.datum().data.fontsizepx=t});eu(n)})}function kr(n,t,i){let f=r(!0,"SwitchParent",[n,t,i]),u=d3.hierarchy(JSON.parse(f));if(u.data.parentNodeId===i)dr(n,t,i,u);else{const n=new Set(r(window.mapHasChanged,"GetChangedNodeSet").result);nt(ut(n),n)}}function ai(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();r.children.splice(r.children.findIndex(t=>t.data.nodeid===parseInt(n)),1);r.data.children.splice(r.data.children.findIndex(t=>t.nodeid===parseInt(n)),1)}function vi(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();n.parent=r;r.children||(r.children=[]);r.children.push(n);r.data.children.push(n.data)}function dr(n,t,i,r){rt(r);ai(n,t);vi(r,i);fu(n,t,i)}async function gr(n,t,i){let r=await t;await DotNet.invokeMethodAsync("MapMyTime",n,r,i)}function r(n,t,...i){return n!==window.mapHasChanged&&kt(n),DotNet.invokeMethod("MapMyTime",t,...i)}async function o(n,t,...i){return n!==window.mapHasChanged&&kt(n),DotNet.invokeMethodAsync("MapMyTime",t,...i)}function kt(n){window.mapHasChanged=n;n?d3.select("#saveIcon").attr("filter","url(#redfilter"):d3.select("#saveIcon").attr("filter",null)}function yi(n,t){n.then(function(n){n.forEach(n=>{t?d3.select("#node"+n).attr("filter","url(#deletenodefilter)"):d3.select("#node"+n).attr("filter",null)})})}function pi(n){let t=d3.select("#node"+n).datum().data.parentNodeId,i=r(!0,"DeleteNode",n);ai(n,t);i.length>0&&(i.forEach(n=>{let i=d3.hierarchy(JSON.parse(n));rt(i);vi(i,t)}),ft());s();ft()}function s(){d3.selectAll(".node-menu").remove();d3.selectAll(".nodecontextmenu").remove()}function nu(n){if(n.data.name.startsWith(vt)){g(n);return}let t,i,u,f,r;if(document.caretPositionFromPoint?(t=document.caretPositionFromPoint(event.clientX,event.clientY),i=t.offsetNode,u=t.offset):document.caretRangeFromPoint&&(t=document.caretRangeFromPoint(event.clientX,event.clientY),i=t.startContainer,u=t.startOffset),i)r=document.createRange(),f=window.getSelection(),r.setStart(i,u),r.collapse(!0),f.removeAllRanges(),f.addRange(r);else{g(n);document.getElementById("divid"+n.data.nodeid).focus();return}}function g(n){var t=document.getElementById("divid"+n.data.nodeid),r=window.getSelection(),i=document.createRange(),u=1;n.data.name.startsWith(vt)&&(u=0);i.setStart(t,u);i.setEnd(t,1);r.removeAllRanges();r.addRange(i);t.focus()}function tu(n){if(event.altKey&&event.shiftKey&&event.key.startsWith("Arrow")){let t=JSON.parse(r(window.mapHasChanged,"ProcessArrowEvent",event.key,n.data.nodeid));if(t.navigatetoid>0){let n=d3.select("#node"+t.navigatetoid).datum();g(n)}else if(t.navigatetoid===0&&t.newnodeparentid!=0){let n=[t.x,t.y];wt(t.newnodeparentid,n)}}event.altKey&&event.key==="m"&&ci(n)}function wi(n){return(r(window.mapHasChanged,"ClearChangedNodeSet"),n.size===0||n.size===1&&n.$0==="0")?t.descendants():t.descendants().filter(t=>n.has(t.data.nodeid))}function ut(n){return(r(window.mapHasChanged,"ClearChangedNodeSet"),n.size===0||n.size===1&&n.$0==="0")?t.links():t.links().filter(t=>n.has(t.source.data.nodeid)&&n.has(t.target.data.nodeid))}function iu(n){if(n.size===0||n.size===1&&n.$0==="0")return n;var i=t.descendants().filter(t=>n.has(t.data.nodeid)).map(n=>n.data.parentNodeId);return i.forEach(t=>n.add(t)),n}function ru(n){return n.size===0||n.size===1&&n.$0==="0"?t.links():t.links().filter(t=>n.has(t.target.data.nodeid)&&t.target.depth===1)}function uu(n,t){if(t.size===0||t.size===1&&t.$0==="0")return!0;return t.has(n.target.data.nodeid)&&t.has(n.source.data.nodeid)}function ft(){const n=new Set(r(window.mapHasChanged,"GetChangedNodeSet").result);let t=wi(n);ct(t,n);nt(ut(n),n);lt(t,n)}function fu(n,t,i){const u=new Set(r(window.mapHasChanged,"GetChangedNodeSet").result);let f=wi(u);ct(f,u);nt(ut((new Set).add(i).add(n).add(t)),(new Set).add(i).add(n).add(t));lt(f,u)}function eu(n){n.then(function(n){bi(n)})}function bi(n){nodesToUpdate=t.descendants().filter(t=>new Set(n).has(t.data.nodeid));ct(nodesToUpdate,new Set(n));const i=iu(new Set(n));nt(ut(i),i);lt(nodesToUpdate,new Set(n))}function ou(){const n=new Set;ct(t.descendants(),n);nt(t.links(),n);lt(t.descendants(),n);r(window.mapHasChanged,"ClearChangedNodeSet")}function ct(n,t){const r=y.transition().duration(ki);var i=[];it.selectAll(".standardNode").filter(function(n){return t.size===0?!0:t.has(n.data.nodeid)}).data(n.filter(n=>n.depth),n=>n.data.nodeid).join(n=>n.append("g").on("touchstart",function(n,t){ti=d3.timeout(()=>ur(t),500);n.preventDefault();ot=!1}).on("touchmove",function(){ti.stop()}).call(nodeDragListener).style("touch-action","auto").attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill-opacity",1).attr("stroke-opacity",1).attr("id",n=>"node"+n.data.nodeid).attr("fill",n=>n.data.fill).attr("cursor","pointer").classed("standardNode",!0).on("mouseenter",function(n,t){d3.select("#contextmenu"+t.data.nodeid).empty()&&!v&&(s(),hi(t),document.activeElement!==document.getElementById("divid"+t.data.nodeid)&&g(t))}).on("mouseleave",function(){d3.selectAll(".nodecontextmenu").remove()}).on("touchend",function(){ot=!1}).on("click",function(n,t){n.srcElement.id.startsWith("divid")||g(t);n.stopPropagation()}).each(function(){return d3.select(this).append("rect").attr("id",n=>"rectid"+n.data.nodeid).attr("class","noderect").attr("width",n=>n.data.width).attr("height",n=>n.data.height).attr("rx",2).attr("ry",2).attr("stroke","#cce9e5"),d3.select(this).append("foreignObject").attr("id",n=>"foid"+n.data.nodeid).attr("class","nodefo").attr("width",n=>n.data.width).attr("height",n=>n.data.height).each(function(){d3.select(this).append("xhtml:div").attr("id",n=>"divid"+n.data.nodeid).attr("tabindex",n=>n.data.nodeid).attr("contenteditable","true").attr("class","flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif").html(n=>n.data.name).on("touchend",function(n){window.touchTrigger=!0;window.touchedData=n}).on("mousedown",function(n){b===this.id&&n.stopPropagation()}).on("click",function(n,t){!b===this.id&&nu(t);b=this.id}).on("blur",function(n,t){b="";t.data.name!==this.innerHTML&&(t.data.name=this.innerHTML,o(!0,"UpdateText",t.data.nodeid,this.innerHTML))}).on("keydown",function(n,t){tu(t);n.stopPropagation()}).on("keyup",function(n,t){if(t.data.autosize){var i=this.scrollHeight,r=!1;window.isScreenSmall?i>h&&t.data.height!==i&&(r=!0):t.data.height!==i&&(r=!0);r&&(t.data.height=i,bt([{nodeid:t.data.nodeid,height:t.data.height,width:t.data.width,autosize:t.data.autosize}],!0),d3.select("#rectid"+t.data.nodeid).attr("height",t.data.height),d3.select("#foid"+t.data.nodeid).attr("height",t.data.height),d3.select("#highlightRect"+t.data.nodeid).attr("height",t.data.height+tt),d3.select("#resizehandle"+t.data.nodeid).attr("cy",t.data.height),d3.select("#proximityrect"+t.data.nodeid).attr("height",t.data.height+e))}}).on("paste",function(n,t){if(t.data.autosize){var i=this;setTimeout(function(){i.dispatchEvent(new Event("keyup"))})}})}),d3.select(this).append("circle").attr("id",n=>"resizehandle"+n.data.nodeid).attr("cx",n=>n.data.width).attr("cy",n=>n.data.height).attr("class","resizehandle").attr("r",7).attr("fill",n=>n.data.fill).call(ri),d3.select(this).append("rect").attr("class","highlightRect").attr("id",n=>"highlightRect"+n.data.nodeid).attr("transform","translate(-3,-3)").attr("width",n=>n.data.width+6).attr("height",function(n){if(n.data.autosize&&d3.select("#divid"+n.data.nodeid).node()){var t=d3.select("#divid"+n.data.nodeid).node().scrollHeight,r=!1;window.isScreenSmall?t>h&&n.data.height!==t&&(r=!0):n.data.height!==t&&(r=!0);r&&(n.data.height=t,i.push(n.data),d3.select("#rectid"+n.data.nodeid).attr("height",n.data.height),d3.select("#resizehandle"+n.data.nodeid).attr("cy",n.data.height),d3.select("#foid"+n.data.nodeid).attr("height",n.data.height))}return n.data.height+tt}).attr("rx",2).attr("ry",2).attr("opacity",.2).style("fill","red").attr("pointer-events","none"),n}),n=>n.attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill",n=>n.data.fill).attr("class",n=>n.data.cssClass).each(function(){d3.select(this).select(".flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif");d3.select(this).select(".noderect").attr("height",function(n){if(n.data.autosize){var t=d3.select("#divid"+n.data.nodeid).node().scrollHeight,r=!1;window.isScreenSmall?t>h&&n.data.height!==t&&(r=!0):n.data.height!==t&&(r=!0);r&&(n.data.height=t,i.push(n.data))}return n.data.height}).attr("width",n=>n.data.width);d3.select(this).select(".nodefo").attr("height",n=>n.data.height).attr("width",n=>n.data.width);d3.select(this).select(".resizehandle").attr("cx",n=>n.data.width).attr("cy",n=>n.data.height);d3.select(this).select(".highlightRect").attr("height",n=>n.data.height+tt).attr("width",n=>n.data.width+tt);d3.select(this).select(".linklump").attr("cx",n=>n.data.width/2)}),n=>{n.call(n=>n.transition(r).remove().attr("transform",()=>`translate(${dt-24},${4})`).attr("fill-opacity",0).attr("stroke-opacity",0))});i.length>0&&bt(i,!0)}function nt(n,t){pt.selectAll(".gpath").filter(function(n){return uu(n,t)}).data(n,n=>n).join(function(n){var t=n.append("g").attr("id",n=>"gpathlink-"+n.source.data.nodeid+"-"+n.target.data.nodeid).classed("gpath",!0);t.append("path").call(linkDragListener).classed("link",!0).attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));t.append("path").call(linkDragListener).classed("linkborder",!0).attr("id",n=>"linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},n=>{n.attr("id",n=>"gpathlink-"+n.source.data.nodeid+"-"+n.target.data.nodeid),n.select(".link").attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]})),n.select(".linkborder").attr("id",n=>"linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},n=>{n.call(n=>n.remove())});su(n,t)}function su(n,t){var i=ru(t);rr.selectAll(".linklump").filter(function(n){return t.size===0?!0:t.has(n.target.data.nodeid)}).data(i.filter(n=>n.target.data.nodeid)).join(n=>n.append("image").call(linkDragListener).attr("transform",n=>`translate(${n.target.x+n.target.data.width/2-4},${n.target.y-8})`).attr("width",9).attr("height",9).attr("class","linklump").attr("id",n=>"linklump"+n.target.data.nodeid).style("color",n=>n.target.data.fill).attr("xlink:href","./css/open-iconic/icons/caret-top.svg"),n=>n.attr("transform",n=>`translate(${n.target.x+n.target.data.width/2+-4},${n.target.y-8})`),n=>n.remove())}function lt(n,t){ir.selectAll(".proximityRect").filter(function(n){return t.size===0?!0:t.has(n.data.nodeid)}).data(n.filter(n=>n.depth),n=>n.data.nodeid).join(n=>n.append("rect").classed("proximityRect",!0).attr("id",n=>"proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-c/2},${n.y-e/2})`).attr("width",n=>n.data.width+c).attr("height",n=>n.data.height+e).attr("opacity",0).style("fill","grey").on("mousemove",function(n,t){fi(t.data.nodeid,n)}).on("mouseout",function(n){n.relatedTarget?d3.select(n.relatedTarget).classed("proximityRect")||(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1)):(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1))}).on("mouseenter",function(){d3.select(".node-menu").remove();d3.selectAll(".asyncflag").classed("asyncflag",!1)}),n=>n.attr("transform",n=>`translate(${n.x-c/2},${n.y-e/2})`).attr("width",n=>n.data.width+c).attr("height",n=>n.data.height+e),n=>n.remove())}var t=d3.hierarchy(JSON.parse(n)),u,yt,p,st,ht,ri,fi,ei;const ki=event&&event.altKey?2500:250;u=d3.linkHorizontal().x(function(n){return n.X??n.x}).y(function(n){return n.Y??n.y});const dt=700;rt(t);window.mapHasChanged=!1;var et,h,di,c,e,gt,tt,w=!1,b="",at,vt,l,ni,a=!1,ot=!1,v=!1,k=!1,gi,nr,ti,tr=_.throttle(fr,16);const f=d3.create("svg").attr("id","svg").attr("viewBox",[0,0,dt,700]).style("font",t.data.fontsizepx+"px sans-serif").style("user-select","none").on("click",function(n){var i,t;if(b!==""){document.getElementById(b).blur();return}i=d3.pointer(n,document.getElementsByTagName("g")[0]);n.stopPropagation();let r=d3.select(".show");t=0;r.empty()||(t=r.datum().data.nodeid);wt(t,i)}).on("touchstart",function(n){at=d3.pointers(n,document.getElementsByTagName("g")[0]);n.targetTouches.length===1&&(n.srcElement.id.includes("svg")||n.srcElement.id.includes("proximityrect"))&&(w=!0);n.target.localName!=="input"&&n.preventDefault()}).on("touchmove",function(){w=!1}).on("touchend",function(n){if(w){var t=0;if(n.changedTouches[0].target.id.includes("proximityrect")){let i=d3.select(n.changedTouches[0].target).datum().data.nodeid;t=r(window.mapHasChanged,"GetParentNodeIdFromProximalNode",i,at[0])}wt(t,at[0]);w=!1}n.target.localName!=="input"&&(n.preventDefault(),document.activeElement.blur())});f.append("filter").attr("id","deletenodefilter").append("feGaussianBlur").attr("stdDeviation","5");f.append("filter").attr("id","makebrighterfilter").append("feColorMatrix").attr("type","matrix").attr("values","1.2 0 0 0 0 0 1.2 0 0 0 0 0 1.2 0 0 0 0 0 1 0");f.append("filter").attr("id","redfilter").append("feColorMatrix").attr("type","matrix").attr("values","0 0 0 1 0 0 0 0 0 0 1 1 1 0 0 0 0 0 1.5 0");const y=f.append("g").attr("fill","none").attr("width","100%").attr("height","100%").attr("id","topGroup").attr("class","topGroup").on("mouseleave",function(){var n=d3.selectAll(".show");n.empty()||n.classed("show",!1)});yt=d3.zoom().clickDistance(10).on("zoom",function(n){k||n.target.nodeName!=="PATH"&&y.attr("transform",n.transform)}).on("end",function(n){k||n.target.nodeName!=="PATH"&&(n.transform.k===1&&n.transform.x===0&&n.transform.y===0||(r(!0,"UpdateTranslation",n.transform),t.data.scale=n.transform.k))});f.call(yt).on("dblclick.zoom",null);const ir=y.append("g").attr("id","proximityrect"),pt=y.append("g").attr("id","linkgroup").attr("class","glink"),it=y.append("g").attr("id","nodegroup"),rr=y.append("g").attr("id","lumpgroup");nodeDragListener=d3.drag().filter(!0).on("start",function(n,t){k=!0;v=!1;initialX=t.x;initialY=t.y;(n.sourceEvent.ctrlKey||n.sourceEvent.metaKey||ot)&&ii(t);n.sourceEvent.stopPropagation()}).on("drag",function(n,t){(window.touchTrigger=!1,k)&&(v||(s(),v=!0),t.x+=n.dx,t.y+=n.dy,tr(t))}).on("end",function(n,t){if((d3.selectAll(".highlightRect").classed("show",!1),k)&&(k=!1,v||a)){if(!v&&a){t.descendants().forEach(n=>{pt.append(function(){return d3.select("#gpathlink-"+n.data.parentNodeId+"-"+n.data.nodeid).remove().node()}),it.append(function(){return d3.select("#node"+n.data.nodeid).remove().node()})});a=!1;return}v=!1;t.data.xCoordinate=t.x0=t.x;t.data.yCoordinate=t.y0=t.y;let i=r(!0,"UpdateImpactedNode",t.data.nodeid,t.x,t.y,!0);if(t.data.midpointconnections=i.midpointconnections,t.data.parentNodeConnection=i.parentnodeconnection,t.data.connection=i.connection,t.data.parentNodeId===0?d3.select("#linklump"+t.data.nodeid).attr("transform",()=>`translate(${t.x+t.data.width/2-4}, ${t.y-8})`):d3.select("#linkborder-"+t.data.parentNodeId+"-"+t.data.nodeid).attr("d",()=>u({source:i.linkendpoints[0],target:i.linkendpoints[1]})),a){d3.select("#node"+t.data.nodeid).attr("cursor","wait");var f=[];t.descendants().forEach(n=>{if(f.push(n.data.nodeid),t.data.nodeid!=n.data.nodeid){n.x=n.data.xCoordinate+=t.x-initialX;n.y=n.data.yCoordinate+=t.y-initialY;let i=r(!0,"UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0);n.data.midpointconnections=i.midpointconnections;n.data.parentNodeConnection=i.parentnodeconnection;n.data.connection=i.connection;let f=d3.select("#gpathlink-"+n.data.parentNodeId+"-"+n.data.nodeid);pt.append(function(){return f.select(".link").attr("d",u({source:i.linkendpoints[0],target:i.linkendpoints[1]})),f.select(".linkborder").attr("d",u({source:i.linkendpoints[0],target:i.linkendpoints[1]})),f.remove().node()});it.append(function(){var t=d3.select("#node"+n.data.nodeid);return t.attr("transform","translate("+n.x+","+n.y+")"),t.remove().node()})}d3.select("#proximityrect"+n.data.nodeid).attr("transform",()=>`translate(${n.x-c/2},${n.y-e/2})`)});o(!0,"UpdateProximityMapAsync",f);d3.select("#draggroup").remove();a=!1;d3.select("#node"+t.data.nodeid).attr("cursor","pointer")}else or(t);hi(t);Object.prototype.toString.call(n.sourceEvent).includes("TouchEvent")&&document.activeElement.blur()}});p=-1;linkDragListener=d3.drag().on("start",function(n,t){n.sourceEvent.type==="touchstart"&&n.sourceEvent.preventDefault();const i=d3.select("#link-"+t.source.data.nodeid+"-"+t.target.data.nodeid),r=t.target.data.midpointconnections[t.target.data.connection];i.classed("linkdragging",!0).attr("d",()=>{const t={X:n.x,Y:n.y};return u({source:t,target:r})}).attr("pointer-events","none")}).on("drag",function(n,t){const f=d3.select("#link-"+t.source.data.nodeid+"-"+t.target.data.nodeid);f.attr("d",()=>{const i={x:n.x,y:n.y};return u({source:i,target:t.target.data.midpointconnections[t.target.data.connection]})});var r=d3.pointers(n,d3.select("body").node())[0],i=document.elementFromPoint(r[0],r[1]);i&&i.id.includes("proximityrect")&&ei(d3.select(i).datum().data.nodeid,t.target.data.nodeid,n)}).on("end",function(n,t){const r=d3.select("#link-"+t.source.data.nodeid+"-"+t.target.data.nodeid);r.classed("linkdragging",!1).attr("pointer-events","auto").attr("d",()=>{const i={x:n.x,y:n.y};return u({source:i,target:t.target.data.midpointconnections[t.target.data.connection]})});var i=d3.select(".show");if(i.empty()&&(i=d3.select(".nodecontextmenu")),p=i.empty()?0:i.datum().data.nodeid,p===t.target.data.nodeid&&(p=0),d3.selectAll(".show").classed("show",!1),p===t.source.data.nodeid){r.attr("d",()=>t.source.data.nodeid===0?null:u({source:t.source.data.midpointconnections[t.target.data.parentNodeConnection],target:t.target.data.midpointconnections[t.target.data.connection]}));return}kr(t.target.data.nodeid,t.source.data.nodeid,p)});ri=d3.drag().on("start",function(n,t){n.sourceEvent.stopPropagation();t.data.autosize=!1;st=t.data.height;ht=t.data.width}).on("drag",function(n,t){st+=n.dy;ht+=n.dx;let i=!1;st>1&&(t.data.height=st,i=!0);ht>1&&(t.data.width=ht,i=!0);i&&ui(t,!1)}).on("end",function(n,t){ui(t,!0)});fi=function(n,t){DotNet.invokeMethodAsync("MapMyTime","GetParentNodeIdFromProximalNodeAsync",n,d3.pointers(t,document.getElementsByTagName("g")[0])[0]).then(function(n){oi(n)})};ei=function(n,t,i){DotNet.invokeMethodAsync("MapMyTime","GetConnectionNodeId",n,d3.pointers(i,document.getElementsByTagName("g")[0])[0],t).then(function(n){oi(n)})};cr()}};window.addEventListener("resize",window.D3TimeMapUtilities.positionIcons);window.addEventListener("beforeunload",function(n){window.mapHasChanged&&(n.preventDefault(),n.returnValue="")});