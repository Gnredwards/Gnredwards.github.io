window.TimeMapUtilities={getBoundengRectOffset:function(n){const t=document.getElementById(n).getBoundingClientRect();return{left:t.left+window.scrollX,top:t.top+window.scrollY}},saveAsFile:function(n,t){var r=prompt("Please enter a file name",n),i;r&&(i=document.createElement("a"),i.download=r+".json",i.href="data:application/octet-stream;base64,"+t,document.body.appendChild(i),i.click(),document.body.removeChild(i),DotNet.invokeMethod("MapMyTime","UpdateText",0,r))},openURL:function(){return prompt("Enter a link to Json file to dowload","https://MapMyTime/MapMyTime.json")},cursorStyle:function(n){document.body.style.cursor=n},runFileInput:function(n){n.value="";n.click()},alertMessage:function(n){alert(n)},unsavedChangesOK:function(){return window.mapHasChanged?confirm("You have unsaved changes, do you want to continue?"):!0},updateURLwithoutReload:function(n){window.history.pushState("data","Map My Time",n)}},function(){window.blazorLocalStorage={get:n=>n in localStorage?JSON.parse(localStorage[n]):null,set:(n,t)=>{localStorage[n]=JSON.stringify(t)},"delete":n=>{delete localStorage[n]}}}();window.D3TimeMapUtilities={positionIcons:function(){var n=document.getElementById("svg");if(n){var t=n.getBoundingClientRect(),r=document.getElementById("saveIcon"),u=r.getBoundingClientRect(),i=n.createSVGPoint();if(i.y=t.top+4,i.x=t.right-u.width-4,r.setAttribute("x",i.matrixTransform(n.getScreenCTM().inverse()).x),r.setAttribute("y",i.matrixTransform(n.getScreenCTM().inverse()).y),window.touchTrigger){let i=d3.zoomTransform(n),r=i.x+window.touchedData.x0*i.k+t.width/2,u=i.y+window.touchedData.y0*i.k+t.width/2;d3.select("topGroup").transition().duration(500).attr("transform","translate("+r+","+u+") scale("+i.k+")");window.touchTrigger=!1}}window.D3TimeMapUtilities.setSmallScreen()},setSmallScreen:function(){window.isScreenSmall=document.body.clientWidth<768?!0:!1},isFirstVisit:function(){return window.D3TimeMapUtilities.getCookie("firstvisit")!=""?!1:!0},setFirstVisit:function(){window.D3TimeMapUtilities.setCookie("firstvisit",!0,90)},getCookie:function(n){for(var t,r=n+"=",f=decodeURIComponent(document.cookie),u=f.split(";"),i=0;i<u.length;i++){for(t=u[i];t.charAt(0)==" ";)t=t.substring(1);if(t.indexOf(r)==0)return t.substring(r.length,t.length)}return""},setCookie:function(n,t,i){var r=new Date,u;r.setTime(r.getTime()+i*864e5);u="expires="+r.toUTCString();document.cookie=n+"="+t+";"+u+";path=/"},createD3Tree:function(n){function ri(n,t){wt([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}],t);d3.select("#foid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height);d3.select("#rectid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height)}async function pt(n,i){let e=await o(!0,"AddNewNodeAsync",i,n,h);var r=d3.hierarchy(JSON.parse(e)),u,f=d3.select("#node"+r.data.parentNodeId);u=f.empty()?t:f.datum();r.x0=r.x=r.data.xCoordinate;r.y0=r.y=r.data.yCoordinate;r.depth=r.data.nodedepth;r.parent=u;u.children||(u.children=[],u.data.children=[]);u.children.push(r);u.data.children.push(r.data);rt("enter");s();nt||k(r);nt=!1}function nr(n){let t=r(!0,"RecalculateMovedNodeLinks",n.data.nodeid,n.x,n.y);t.forEach(t=>{let i=JSON.parse(t);i.nodeid!==n.data.nodeid?d3.select("#link-"+n.data.nodeid+"-"+i.nodeid).attr("d",()=>u({source:i.linkendpoints[0],target:i.linkendpoints[1]})):n.data.parentNodeId!==0&&d3.select("#link-"+n.data.parentNodeId+"-"+i.nodeid).attr("d",()=>u({source:i.linkendpoints[0],target:i.linkendpoints[1]}))})}function tr(n){var t=d3.selectAll("path").filter('[id^="link-'+n.data.nodeid+'-"]');t.attr("d",n=>{let t=JSON.parse(r(!0,"UpdateImpactedNode",n.target.data.nodeid,n.target.x,n.target.y,!1));n.target.data.parentNodeConnection=t.parentnodeconnection;n.target.data.connection=t.connection;var i=u({source:t.linkendpoints[0],target:t.linkendpoints[1]});return d3.select("#linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",i),i});o(!0,"UpdateProximityMapAsync",[n.data.nodeid]);d3.select("#proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-c/2},${n.y-e/2})`)}function ei(n){var t=d3.selectAll(".show");(t.size()!==1||t.datum().data.nodeid!==n)&&d3.selectAll(".asyncflag").empty()&&(t.classed("show",!1),d3.select("#highlightRect"+n).classed("show",!0))}function ir(){function s(t){d3.select(".node-menu").remove();let s=t.data.autosize;h||c(t.data.nodeid,10);var i=oi(t.data.nodeid);st.append("g").attr("class","node-menu").on("click",function(){d3.event.stopPropagation()}).on("mouseleave",()=>{d3.select(".node-menu").remove(),d3.selectAll(".nodetobechanged").classed("nodetobechanged",!1)}).attr("transform",()=>`translate(${t.x+t.data.width-20},${t.y})`).selectAll("tmp").data(d3.entries(o).filter(function(n){return n.value.attributename==="autosize"?!s:!0}),n=>n.value.menutext).join(function(o){var s=o.append("g").attr("class","menu-entry"),h,c;s.append("rect").attr("id",n=>"menurect"+n.value.attributename).attr("y",function(t,i){return i*n}).attr("width",u+e).attr("height",n).attr("data-fillcolour",t.data.fill).attr("data-nodeid",t.data.nodeid).classed("menurect",!0);s.append("text").text(n=>n.value.menutext).attr("y",function(t,i){return i*n}).attr("dy",(n-f/2)*.75).attr("dx",f).classed("menutext",!0);h=s.append("foreignObject").attr("id",n=>n.value.attributename).on("keyup",function(n){hr(n,t.data.nodeid)}).attr("x",function(n){if(n.value.attributename!=="deletebutton")return u}).attr("y",function(t,i){return i*n}).attr("width",function(n){return n.value.attributename==="deletebutton"?u+e:e}).attr("height",n).attr("data-menuparent",n=>n.value.menuparent);c=h.append(h.attr("data-menuparent")).attr("data-menuelement",n=>n.value.menuelement).attr("class","contextmenudiv");c.append(c.attr("data-menuelement")).attr("type",n=>n.value.menutype).attr("id",n=>"menuel"+n.value.attributename).classed("menuerange",n=>n.value.menutype==="range").classed("menucheckbox",n=>n.value.menutype==="checkbox").classed("trashbutton",n=>n.value.attributename==="deletebutton").attr("width",function(n){return n.value.menutype==="color"?e:n.value.menutype==="button"?e:null}).text(function(n){return n.value.menutype==="button"?"Delete":null}).attr("value",function(n){return n.value.menutype==="checkbox"?null:n.value.menutype==="button"?"Delete":Reflect.get(t.data,n.value.attributename)}).property("checked",function(n){return n.value.menutype==="checkbox"?Reflect.get(t.data,n.value.attributename):!1}).attr("min",function(n){return n.value.menutype==="range"?n.value.minvalue:null}).attr("max",function(n){return n.value.menutype==="range"?n.value.maxvalue:null}).attr("step",function(n){return n.value.menutype==="range"?1:null}).attr("data-nodeid",()=>t.data.nodeid).on("input",function(n){d3.event.stopPropagation();n.value.menutype==="checkbox"?(r(!0,n.value.dotnetmethod,parseInt(this.dataset.nodeid),this.checked),Reflect.set(d3.select("#node"+this.dataset.nodeid).datum().data,n.value.attributename,this.checked),i=oi(this.dataset.nodeid)):(vr(n.value.dotnetmethod,i,this.value),n.value.menutype==="color"?cr(i,this.value):n.value.attributename==="fontsizepx"?ci(i,parseInt(this.value)):(er(),rt("update")))}).on("keydown",function(){(d3.event.key==="ArrowUp"||d3.event.key==="ArrowDown")&&d3.event.preventDefault()}).on("keyup",function(n){(d3.event.key===" "||d3.event.key==="Enter")&&n.value.attributename==="deletebutton"&&yi(parseInt(this.dataset.nodeid))}).on("mousedown",function(){d3.event.stopPropagation()}).on("change",function(n){n.value.attributename==="fontsizepx"&&ci(i,parseInt(this.value))}).on("mouseenter focus",function(n){if(d3.select("#menurect"+n.value.attributename).attr("filter","url(#makebrighterfilter)"),n.value.attributename==="deletebutton")vi(i,!0);else return null}).on("mouseleave blur",function(n){if(d3.select("#menurect"+n.value.attributename).attr("filter",null),n.value.attributename==="deletebutton")vi(i,!1);else return null}).on("mouseup",function(n){if(n.value.attributename==="deletebutton")yi(parseInt(this.dataset.nodeid));else return null})})}function c(i,r){var s,c,l;f=.1;d3.select("#node"+i).selectAll("temptext").data(d3.entries(o)).enter().append("text").text(function(n){return n.value.menutext}).attr("x",-1e3).attr("y",-1e3).attr("class","temptext").style("font-size",r);s=d3.selectAll(".temptext").nodes().map(function(n){return n.getBBox()});u=d3.max(s.map(function(n){return n.width}));f=f*u;u=u+2*f;n=d3.max(s.map(function(n){return(n.height+f/2)*2}));c=d3.select("#node"+i).append("foreignObject").attr("width",u*.5).attr("height",n).attr("class","tempfo");l=c.append("xhtml:div").attr("class","contexmenuflexdiv");l.append("xhtml:input").attr("type","color").attr("value","#007BFF").attr("class","tempinput");e=d3.select(".tempinput").node().getBoundingClientRect().width/t.data.scale;d3.selectAll(".temptext,.tempfo").remove();h=!0}var n,u,f=.1,o=[],e,h=!1;return s.items=function(){if(!arguments.length)return o;for(i in arguments[0])o.push(arguments[0][i]);return rescale=!0,s},s}async function rr(){var n=document.getElementById("svg");n&&document.getElementById("d3SVGdiv").removeChild(n);await fr();ni=ir().items(l);h=ur();window.D3TimeMapUtilities.setSmallScreen();window.isScreenSmall&&(h=h*2);ut&&rt("all");document.getElementById("d3SVGdiv").appendChild(f.node());f.call(yt.transform,d3.zoomIdentity.translate(t.data.xTranslate,t.data.yTranslate).scale(t.data.scale));sr();window.D3TimeMapUtilities.positionIcons();ut||nu();bt(!1)}function ur(){var t=st.append("foreignObject").attr("height",20).attr("width",60).attr("x",-1e3).attr("y",-1e3).classed("tempfo nodefo",!0);t.append("xhtml:div").attr("id","defaultnodeheightdiv").attr("contenteditable","true").text("temp").classed("flexdiv tempdiv",!0).style("font-size",dt);document.getElementById("d3SVGdiv").appendChild(f.node());let n=d3.select("#defaultnodeheightdiv").node().scrollHeight;return d3.selectAll(".tempdiv, .tempfo").remove(),document.getElementById("d3SVGdiv").removeChild(f.node()),r(window.mapHasChanged,"SetCalculatedNodeHeight",n),n}async function fr(){ki=await b("defaultwidth");g=await b("highlightrectboundary");dt=await b("defaultfontsize");vt=await b("defaultnodetext");e=await b("proximityrectheight");c=await b("proximityrectwidth");let n=await o(window.mapHasChanged,"GetContextMenuItems");l=JSON.parse(n)}async function b(n){return await o(window.mapHasChanged,"GetConstantAsync",n)}function er(){t=d3.hierarchy(JSON.parse(r(window.mapHasChanged,"GetTimeMapJson")));tt(t)}async function oi(n){return await o(window.mapHasChanged,"ReturnNodesToChangeAsync",parseInt(n))}function wt(n,t){let i=[];n.forEach(n=>{let t={nodeid:n.nodeid,height:n.height,width:n.width,autosize:n.autosize};i.push(t)});or(JSON.stringify(i),n,t)}async function or(n,t,i){let u=await o(!0,"UpdateNodeDimensionsAsync",n,i),r=[];u.forEach(n=>{let t=JSON.parse(n);d3.select("#node"+t.nodeid).datum().data.midpointconnections=t.midpointconnections;d3.select("#node"+t.nodeid).datum().data.parentNodeConnection=t.parentnodeconnection;d3.select("#node"+t.nodeid).datum().data.connection=t.connection;r.push(t.nodeid)});wi(r)}function tt(n){n.descendants().forEach(n=>{n.data.nodeid===0&&t.data.children.length===0?(n.x0=n.x=350,n.y0=n.y=255,ut=!0):(n.x0=n.x=n.data.xCoordinate,n.y0=n.y=n.data.yCoordinate,n.depth=n.data.nodedepth,ut=!1)})}function sr(){f.append("image").attr("id","saveIcon").classed("saveicon img-responsive",!0).attr("width",function(){return window.isScreenSmall?"35":"25"}).attr("height",function(){return window.isScreenSmall?"35":"25"}).attr("cursor","pointer").attr("xlink:href","./css/open-iconic/icons/data-transfer-download.svg").attr("alt","download").on("click",function(){r(!1,"DownloadMap");d3.event.stopPropagation()})}function si(n){var i=d3.select("#node"+n.data.nodeid).append("g").attr("class","nodecontextmenu").attr("id","contextmenu"+n.data.nodeid),t;i.append("rect").attr("transform",()=>`translate(${0},${-20})`).attr("width",()=>n.data.width).attr("height",20).attr("opacity",0).on("click",function(){d3.event.stopPropagation()});t=i.append("g");t.append("path").attr("id","contextmenuicon").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("class","contextmenuicon").attr("d","M 0, 4 H 15 m -15, 6 H 15 m -15, 6 H 15");t.append("rect").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("width","20").attr("height","20").attr("fill","none").attr("pointer-events","visible").on("mouseenter",function(){hi(n)}).on("touchstart",function(){if(d3.select("#contextmenuicon").classed("closeicon"))s();else{const n=new Event("mouseenter");this.dispatchEvent(n)}d3.event.preventDefault();d3.event.stopPropagation()}).on("mousedown",function(){d3.select("#contextmenuicon").classed("closeicon")&&s();d3.event.stopPropagation()})}function hi(n){d3.select(".node-menu").empty()&&(d3.select("#contextmenuicon").attr("d","M 0,4 L 12,16 M 0,16 L 12,4"),d3.select("#contextmenuicon").classed("closeicon",!0),ni(n),document.getElementById("menuel"+l[0].attributename).focus());d3.event.stopPropagation()}function hr(n,t){if(d3.event.key==="ArrowUp"){let i=l.findIndex(t=>t.attributename===n.value.attributename);i===0?(s(),document.getElementById("divid"+t).focus()):document.getElementById("menuel"+l[i-1].attributename).focus()}if(d3.event.key==="ArrowDown"){let r=l.findIndex(t=>t.attributename===n.value.attributename),i=document.getElementById("menuel"+l[r+1].attributename);i?i.focus():(s(),document.getElementById("divid"+t).focus())}}function cr(n,t){n.then(function(n){n.forEach(n=>{d3.select("#node"+n).attr("fill",t).datum().data.fill=t})})}function ci(n,t){n.then(function(i){i.forEach(n=>{var i=d3.select("#node"+n);i.datum().data.fontsizepx=t});gr(n)})}function lr(n,t,i){let f=r(!0,"SwitchParent",[n,t,i]),u=d3.hierarchy(JSON.parse(f));if(u.data.parentNodeId===i)ar(n,t,i,u);else{const n=d3.set(r(window.mapHasChanged,"GetChangedNodeSet").result);d(it(n),n)}}function li(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();r.children.splice(r.children.findIndex(t=>t.data.nodeid===parseInt(n)),1);r.data.children.splice(r.data.children.findIndex(t=>t.nodeid===parseInt(n)),1)}function ai(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();n.parent=r;r.children||(r.children=[]);r.children.push(n);r.data.children.push(n.data)}function ar(n,t,i,r){tt(r);li(n,t);ai(r,i);dr(n,t,i)}async function vr(n,t,i){let r=await t;await DotNet.invokeMethodAsync("MapMyTime",n,r,i)}function r(n,t,...i){return n!==window.mapHasChanged&&bt(n),DotNet.invokeMethod("MapMyTime",t,...i)}async function o(n,t,...i){return n!==window.mapHasChanged&&bt(n),DotNet.invokeMethodAsync("MapMyTime",t,...i)}function bt(n){window.mapHasChanged=n;n?d3.select("#saveIcon").attr("filter","url(#redfilter"):d3.select("#saveIcon").attr("filter",null)}function vi(n,t){n.then(function(n){n.forEach(n=>{t?d3.select("#node"+n).attr("filter","url(#deletenodefilter)"):d3.select("#node"+n).attr("filter",null)})})}function yi(n){let t=d3.select("#node"+n).datum().data.parentNodeId,i=r(!0,"DeleteNode",n);li(n,t);i.length>0&&(i.forEach(n=>{let i=d3.hierarchy(JSON.parse(n));tt(i);ai(i,t)}),rt());s();rt()}function s(){d3.selectAll(".node-menu").remove();d3.selectAll(".nodecontextmenu").remove()}function yr(n){if(n.data.name.startsWith(vt)){k(n);return}let t,i,u,f,r;if(document.caretPositionFromPoint?(t=document.caretPositionFromPoint(d3.event.clientX,d3.event.clientY),i=t.offsetNode,u=t.offset):document.caretRangeFromPoint&&(t=document.caretRangeFromPoint(d3.event.clientX,d3.event.clientY),i=t.startContainer,u=t.startOffset),i)r=document.createRange(),f=window.getSelection(),r.setStart(i,u),r.collapse(!0),f.removeAllRanges(),f.addRange(r);else{k(n);document.getElementById("divid"+n.data.nodeid).focus();return}}function k(n){var t=document.getElementById("divid"+n.data.nodeid),r=window.getSelection(),i=document.createRange(),u=1;n.data.name.startsWith(vt)&&(u=0);i.setStart(t,u);i.setEnd(t,1);r.removeAllRanges();r.addRange(i);t.focus()}function pr(n){if(d3.event.altKey&&d3.event.shiftKey&&d3.event.key.startsWith("Arrow")){let t=JSON.parse(r(window.mapHasChanged,"ProcessArrowEvent",d3.event.key,n.data.nodeid));if(t.navigatetoid>0){let n=d3.select("#node"+t.navigatetoid).datum();k(n)}else if(t.navigatetoid===0&&t.newnodeparentid!=0){let n=[t.x,t.y];pt(t.newnodeparentid,n)}}d3.event.altKey&&d3.event.key==="m"&&hi(n)}function pi(n){return(r(window.mapHasChanged,"ClearChangedNodeSet"),n.size()===0||n.size()===1&&n.$0==="0")?t.descendants():t.descendants().filter(t=>n.has(t.data.nodeid))}function it(n){return(r(window.mapHasChanged,"ClearChangedNodeSet"),n.size()===0||n.size()===1&&n.$0==="0")?t.links():t.links().filter(t=>n.has(t.source.data.nodeid)&&n.has(t.target.data.nodeid))}function wr(n){if(n.size()===0||n.size()===1&&n.$0==="0")return n;var i=t.descendants().filter(t=>n.has(t.data.nodeid)).map(n=>n.data.parentNodeId);return i.forEach(t=>n.add(t)),n}function br(n){return n.size()===0||n.size()===1&&n.$0==="0"?t.links():t.links().filter(t=>n.has(t.target.data.nodeid)&&t.target.depth===1)}function kr(n,t){if(t.size()===0||t.size()===1&&t.$0==="0")return!0;return t.has(n.target.data.nodeid)&&t.has(n.source.data.nodeid)}function rt(){const n=d3.set(r(window.mapHasChanged,"GetChangedNodeSet").result);let t=pi(n);lt(t,n);d(it(n),n);at(t,n)}function dr(n,t,i){const u=d3.set(r(window.mapHasChanged,"GetChangedNodeSet").result);let f=pi(u);lt(f,u);d(it(d3.set().add(i).add(n).add(t)),d3.set().add(i).add(n).add(t));at(f,u)}function gr(n){n.then(function(n){wi(n)})}function wi(n){nodesToUpdate=t.descendants().filter(t=>d3.set(n).has(t.data.nodeid));lt(nodesToUpdate,d3.set(n));const i=wr(d3.set(n));d(it(i),i);at(nodesToUpdate,d3.set(n))}function nu(){const n=d3.set();lt(t.descendants(),n);d(t.links(),n);at(t.descendants(),n);r(window.mapHasChanged,"ClearChangedNodeSet")}function lt(n,t){const r=a.transition().duration(bi);var i=[];st.selectAll(".standardNode").filter(function(n){return t.size()===0?!0:t.has(n.data.nodeid)}).data(n.filter(n=>n.depth),n=>n.data.nodeid).join(n=>n.append("g").call(nodeDragListener).attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill-opacity",1).attr("stroke-opacity",1).attr("id",n=>"node"+n.data.nodeid).attr("fill",n=>n.data.fill).attr("cursor","pointer").classed("standardNode",!0).on("mouseenter",function(n){d3.select("#contextmenu"+n.data.nodeid).empty()&&!p&&(s(),si(n),document.activeElement!==document.getElementById("divid"+n.data.nodeid)&&k(n))}).on("mouseleave",function(){d3.selectAll(".nodecontextmenu").remove()}).on("touchend",function(n){window.touchTrigger=!0;window.touchedData=n}).on("click",function(n){d3.event.srcElement.id.startsWith("divid")||k(n);d3.event.stopPropagation()}).each(function(){return d3.select(this).append("rect").attr("id",n=>"rectid"+n.data.nodeid).attr("class","noderect").attr("width",n=>n.data.width).attr("height",n=>n.data.height).attr("rx",2).attr("ry",2).attr("stroke","#cce9e5"),d3.select(this).append("foreignObject").attr("id",n=>"foid"+n.data.nodeid).attr("class","nodefo").attr("width",n=>n.data.width).attr("height",n=>n.data.height).each(function(){d3.select(this).append("xhtml:div").attr("id",n=>"divid"+n.data.nodeid).attr("tabindex",n=>n.data.nodeid).attr("contenteditable","true").attr("class","flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif").html(n=>n.data.name).on("touchend",function(n){window.touchTrigger=!0;window.touchedData=n}).on("mousedown",function(){y===this.id&&d3.event.stopPropagation()}).on("click",function(n){!y===this.id&&yr(n);y=this.id}).on("blur",function(n){y="";n.data.name!==this.innerHTML&&(n.data.name=this.innerHTML,o(!0,"UpdateText",n.data.nodeid,this.innerHTML))}).on("keydown",function(n){pr(n);d3.event.stopPropagation()}).on("keyup",function(n){if(n.data.autosize){var t=this.scrollHeight,i=!1;window.isScreenSmall?t>h&&n.data.height!==t&&(i=!0):n.data.height!==t&&(i=!0);i&&(n.data.height=t,wt([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}],!0),d3.select("#rectid"+n.data.nodeid).attr("height",n.data.height),d3.select("#foid"+n.data.nodeid).attr("height",n.data.height),d3.select("#highlightRect"+n.data.nodeid).attr("height",n.data.height+g),d3.select("#resizehandle"+n.data.nodeid).attr("cy",n.data.height),d3.select("#proximityrect"+n.data.nodeid).attr("height",n.data.height+e))}}).on("paste",function(n){if(n.data.autosize){var t=this;setTimeout(function(){t.dispatchEvent(new Event("keyup"))})}})}),d3.select(this).append("circle").attr("id",n=>"resizehandle"+n.data.nodeid).attr("cx",n=>n.data.width).attr("cy",n=>n.data.height).attr("class","resizehandle").attr("r",7).attr("fill",n=>n.data.fill).call(ii),d3.select(this).append("rect").attr("class","highlightRect").attr("id",n=>"highlightRect"+n.data.nodeid).attr("transform","translate(-3,-3)").attr("width",n=>n.data.width+6).attr("height",function(n){if(n.data.autosize&&d3.select("#divid"+n.data.nodeid).node()){var t=d3.select("#divid"+n.data.nodeid).node().scrollHeight,r=!1;window.isScreenSmall?t>h&&n.data.height!==t&&(r=!0):n.data.height!==t&&(r=!0);r&&(n.data.height=t,i.push(n.data),d3.select("#rectid"+n.data.nodeid).attr("height",n.data.height),d3.select("#resizehandle"+n.data.nodeid).attr("cy",n.data.height),d3.select("#foid"+n.data.nodeid).attr("height",n.data.height))}return n.data.height+g}).attr("rx",2).attr("ry",2).attr("opacity",.2).style("fill","red").attr("pointer-events","none"),n}),n=>n.attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill",n=>n.data.fill).attr("class",n=>n.data.cssClass).each(function(){d3.select(this).select(".flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif");d3.select(this).select(".noderect").attr("height",function(n){if(n.data.autosize){var t=d3.select("#divid"+n.data.nodeid).node().scrollHeight,r=!1;window.isScreenSmall?t>h&&n.data.height!==t&&(r=!0):n.data.height!==t&&(r=!0);r&&(n.data.height=t,i.push(n.data))}return n.data.height}).attr("width",n=>n.data.width);d3.select(this).select(".nodefo").attr("height",n=>n.data.height).attr("width",n=>n.data.width);d3.select(this).select(".resizehandle").attr("cx",n=>n.data.width).attr("cy",n=>n.data.height);d3.select(this).select(".highlightRect").attr("height",n=>n.data.height+g).attr("width",n=>n.data.width+g);d3.select(this).select(".linklump").attr("cx",n=>n.data.width/2)}),n=>{n.call(n=>n.transition(r).remove().attr("transform",()=>`translate(${kt-24},${4})`).attr("fill-opacity",0).attr("stroke-opacity",0))});i.length>0&&wt(i,!0)}function d(n,t){ti.selectAll(".gpath").filter(function(n){return kr(n,t)}).data(n,n=>n).join(function(n){var t=n.append("g").attr("id",n=>"gpathlink-"+n.source.data.nodeid+"-"+n.target.data.nodeid).classed("gpath",!0);t.append("path").call(linkDragListener).classed("link",!0).attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));t.append("path").call(linkDragListener).classed("linkborder",!0).attr("id",n=>"linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},n=>{n.attr("id",n=>"gpathlink-"+n.source.data.nodeid+"-"+n.target.data.nodeid),n.select(".link").attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]})),n.select(".linkborder").attr("id",n=>"linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},n=>{n.call(n=>n.remove())});tu(n,t)}function tu(n,t){var i=br(t);gi.selectAll(".linklump").filter(function(n){return t.size()===0?!0:t.has(n.target.data.nodeid)}).data(i.filter(n=>n.target.data.nodeid)).join(n=>n.append("image").call(linkDragListener).attr("transform",n=>`translate(${n.target.x+n.target.data.width/2-4},${n.target.y-8})`).attr("width",9).attr("height",9).attr("class","linklump").attr("id",n=>"linklump"+n.target.data.nodeid).style("color",n=>n.target.data.fill).attr("xlink:href","./css/open-iconic/icons/caret-top.svg"),n=>n.attr("transform",n=>`translate(${n.target.x+n.target.data.width/2+-4},${n.target.y-8})`),n=>n.remove())}function at(n,t){di.selectAll(".proximityRect").filter(function(n){return t.size()===0?!0:t.has(n.data.nodeid)}).data(n.filter(n=>n.depth),n=>n.data.nodeid).join(n=>n.append("rect").classed("proximityRect",!0).attr("id",n=>"proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-c/2},${n.y-e/2})`).attr("width",n=>n.data.width+c).attr("height",n=>n.data.height+e).attr("opacity",0).style("fill","grey").on("mousemove",function(n){ui(n.data.nodeid)}).on("mouseout",function(){d3.event.relatedTarget?d3.select(d3.event.relatedTarget).classed("proximityRect")||(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1)):(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1))}).on("mouseenter",function(){d3.select(".node-menu").remove();d3.selectAll(".asyncflag").classed("asyncflag",!1)}),n=>n.attr("transform",n=>`translate(${n.x-c/2},${n.y-e/2})`).attr("width",n=>n.data.width+c).attr("height",n=>n.data.height+e),n=>n.remove())}var t=d3.hierarchy(JSON.parse(n)),u,yt,v,ht,ct,ii,ui,fi;const bi=d3.event&&d3.event.altKey?2500:250;u=d3.linkHorizontal().x(function(n){return n.x}).y(function(n){return n.y});const kt=700;tt(t);window.mapHasChanged=!1;var ut,h,ki,c,e,dt,g,nt=!1,y="",gt,vt,l,ni,ft=!1,p=!1,w=!1,et,ot;const f=d3.create("svg").attr("id","svg").attr("viewBox",[0,0,kt,700]).style("font",t.data.fontsizepx+"px sans-serif").style("user-select","none").on("click",function(){var t,n;if(y!==""){document.getElementById(y).blur();return}t=d3.mouse(document.getElementsByTagName("g")[0]);d3.event.stopPropagation();let i=d3.select(".show");n=0;i.empty()||(n=i.datum().data.nodeid);pt(n,t)}).on("touchstart",function(){d3.event.touches.length===1&&(d3.event.touches[0].target.id.includes("svg")||d3.event.touches[0].target.id.includes("proximityrect"))&&(nt=!0,gt=d3.mouse(document.getElementsByTagName("g")[0]))}).on("touchmove",function(){nt=!1}).on("touchend",function(){if(nt){var n=0;if(d3.event.changedTouches[0].target.id.includes("proximityrect")){let t=d3.select(d3.event.changedTouches[0].target).datum().data.nodeid;n=r(window.mapHasChanged,"GetParentNodeIdFromProximalNode",t,d3.mouse(document.getElementsByTagName("g")[0]))}pt(n,gt);d3.event.preventDefault()}});f.append("filter").attr("id","deletenodefilter").append("feGaussianBlur").attr("stdDeviation","5");f.append("filter").attr("id","makebrighterfilter").append("feColorMatrix").attr("type","matrix").attr("values","1.2 0 0 0 0 0 1.2 0 0 0 0 0 1.2 0 0 0 0 0 1 0");f.append("filter").attr("id","redfilter").append("feColorMatrix").attr("type","matrix").attr("values","0 0 0 1 0 0 0 0 0 0 1 1 1 0 0 0 0 0 1.5 0");const a=f.append("g").attr("fill","none").attr("width","100%").attr("height","100%").attr("id","topGroup").attr("class","topGroup").on("mouseleave",function(){var n=d3.selectAll(".show");n.empty()||n.classed("show",!1)});yt=d3.zoom().clickDistance(10).on("zoom",function(){w||d3.event.target.nodeName!=="PATH"&&a.attr("transform",d3.event.transform)}).on("end",function(){w||d3.event.target.nodeName!=="PATH"&&(d3.event.transform.k===1&&d3.event.transform.x===0&&d3.event.transform.y===0||(r(!0,"UpdateTranslation",d3.event.transform),t.data.scale=d3.event.transform.k))});f.call(yt).on("dblclick.zoom",null);const di=a.append("g").attr("id","proximityrect"),ti=a.append("g").attr("id","linkgroup").attr("class","glink"),st=a.append("g").attr("id","nodegroup"),gi=a.append("g").attr("id","lumpgroup");nodeDragListener=d3.drag().on("start",function(n){var t,i,r;w=!0;p=!1;t=!1;d3.touches(this).length>1&&(t=!0,d3.event.sourceEvent.preventDefault());(d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey||t)&&(ft=!0,et=0,ot=0,i=a.append("g").attr("id","draggroup"),r=i.append("g").attr("id","linkdraggroup").attr("class","glink"),n.descendants().forEach(t=>{n.data.nodeid!=t.data.nodeid&&(i.append(function(){return d3.select("#node"+t.data.nodeid).remove().node()}),r.append(function(){return d3.select("#gpathlink-"+t.data.parentNodeId+"-"+t.data.nodeid).remove().node()}))}));d3.event.sourceEvent.stopPropagation()}).on("drag",function(n){if(window.touchTrigger=!1,w){p||(s(),p=!0);n.x+=d3.event.dx;n.y+=d3.event.dy;var t=d3.select("#node"+n.data.nodeid);if(t.attr("transform","translate("+n.x+","+n.y+")"),ft){if(n.data.parentNodeId!==0){let t=JSON.parse(r(!0,"UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0));d3.select("#link-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>u({source:t.linkendpoints[1],target:t.linkendpoints[0]}))}et+=d3.event.dx;ot+=d3.event.dy;d3.select("#draggroup").attr("transform","translate("+et+","+ot+")")}else nr(n)}}).on("end",function(n){if(w&&(w=!1,p)){p=!1;n.data.xCoordinate=n.x0=n.x;n.data.yCoordinate=n.y0=n.y;let t=JSON.parse(r(!0,"UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0));if(n.data.midpointconnections=JSON.parse(JSON.stringify(t.midpointconnections)),n.data.parentNodeConnection=t.parentnodeconnection,n.data.connection=t.connection,n.data.parentNodeId===0?d3.select("#linklump"+n.data.nodeid).attr("transform",()=>`translate(${n.x+n.data.width/2-4}, ${n.y-8})`):d3.select("#linkborder-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>u({source:t.linkendpoints[0],target:t.linkendpoints[1]})),ft){var i=[];n.descendants().forEach(t=>{if(i.push(t.data.nodeid),n.data.nodeid!=t.data.nodeid){t.x=t.data.xCoordinate+=et;t.y=t.data.yCoordinate+=ot;let n=JSON.parse(r(!0,"UpdateImpactedNode",t.data.nodeid,t.x,t.y,!0));t.data.midpointconnections=JSON.parse(JSON.stringify(n.midpointconnections));t.data.parentNodeConnection=n.parentnodeconnection;t.data.connection=n.connection;let i=d3.select("#gpathlink-"+t.data.parentNodeId+"-"+t.data.nodeid);ti.append(function(){return i.select(".link").attr("d",u({source:n.linkendpoints[0],target:n.linkendpoints[1]})),i.select(".linkborder").attr("d",u({source:n.linkendpoints[0],target:n.linkendpoints[1]})),i.remove().node()});st.append(function(){var n=d3.select("#node"+t.data.nodeid);return n.attr("transform","translate("+t.x+","+t.y+")"),n.remove().node()})}d3.select("#proximityrect"+t.data.nodeid).attr("transform",()=>`translate(${t.x-c/2},${t.y-e/2})`)});o(!0,"UpdateProximityMapAsync",i);d3.select("#draggroup").remove();ft=!1}else tr(n);si(n)}});v=-1;linkDragListener=d3.drag().on("start",function(n){d3.event.sourceEvent.type==="touchstart"&&d3.event.sourceEvent.preventDefault();const t=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid),i=n.target.data.midpointconnections[n.target.data.connection];t.classed("linkdragging",!0).attr("d",()=>{const n={x:d3.event.x,y:d3.event.y};return u({source:n,target:i})}).attr("pointer-events","none")}).on("drag",function(n){const r=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid);r.attr("d",()=>{const t={x:d3.event.x,y:d3.event.y};return u({source:t,target:n.target.data.midpointconnections[n.target.data.connection]})});var i=d3.mouse(d3.select("body").node()),t=document.elementFromPoint(i[0],i[1]);t&&t.id.includes("proximityrect")&&fi(d3.select(t).datum().data.nodeid,n.target.data.nodeid)}).on("end",function(n){const i=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid);i.classed("linkdragging",!1).attr("pointer-events","auto").attr("d",()=>{const t={x:d3.event.x,y:d3.event.y};return u({source:t,target:n.target.data.midpointconnections[n.target.data.connection]})});var t=d3.select(".show");if(t.empty()&&(t=d3.select(".nodecontextmenu")),v=t.empty()?0:t.datum().data.nodeid,v===n.target.data.nodeid&&(v=0),d3.selectAll(".show").classed("show",!1),v===n.source.data.nodeid){i.attr("d",()=>n.source.data.nodeid===0?null:u({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));return}lr(n.target.data.nodeid,n.source.data.nodeid,v)});ii=d3.drag().on("start",function(n){d3.event.sourceEvent.stopPropagation();n.data.autosize=!1;ht=n.data.height;ct=n.data.width}).on("drag",function(n){ht+=d3.event.dy;ct+=d3.event.dx;let t=!1;ht>1&&(n.data.height=ht,t=!0);ct>1&&(n.data.width=ct,t=!0);t&&ri(n,!1)}).on("end",function(n){ri(n,!0)});ui=function(n){DotNet.invokeMethodAsync("MapMyTime","GetParentNodeIdFromProximalNodeAsync",n,d3.mouse(document.getElementsByTagName("g")[0])).then(function(n){ei(n)})};fi=function(n,t){DotNet.invokeMethodAsync("MapMyTime","GetConnectionNodeId",n,d3.mouse(document.getElementsByTagName("g")[0]),t).then(function(n){ei(n)})};rr()}};window.addEventListener("resize",window.D3TimeMapUtilities.positionIcons);window.addEventListener("beforeunload",function(n){window.mapHasChanged&&(n.preventDefault(),n.returnValue="")});