window.TimeMapUtilities={getBoundengRectOffset:function(n){const t=document.getElementById(n).getBoundingClientRect();return{left:t.left+window.scrollX,top:t.top+window.scrollY}},saveAsFile:function(n,t){var r=prompt("Please enter a file name",n),i;r&&(i=document.createElement("a"),i.download=r+".json",i.href="data:application/octet-stream;base64,"+t,document.body.appendChild(i),i.click(),document.body.removeChild(i),DotNet.invokeMethod("MapMyTime","UpdateText",0,r))},openURL:function(){return prompt("Enter a link to Json file to dowload","https://MapMyTime/MapMyTime.json")},runFileInput:function(n){n.value="";n.click()},alertMessage:function(n){alert(n)},updateURLwithoutReload:function(n){window.history.pushState("data","Map My Time",n)},positionIcons:function(){var n=document.getElementById("svg"),i=n.getBoundingClientRect(),t=n.createSVGPoint();t.y=i.top+4;t.x=i.right-24;document.getElementById("saveIcon").setAttribute("x",t.matrixTransform(n.getScreenCTM().inverse()).x);document.getElementById("saveIcon").setAttribute("y",t.matrixTransform(n.getScreenCTM().inverse()).y)}};window.D3TimeMapUtilities={createD3Tree:function(n){function g(n){var t=d3.selectAll(".show");(t.size()!==1||t.datum().data.nodeid!==n)&&d3.selectAll(".asyncflag").empty()&&(t.classed("show",!1),d3.select("#highlightRect"+n).classed("show",!0))}function pt(){function s(t){d3.select(".node-menu").remove();let s=t.data.autosize;h||c(t.data.nodeid,10);var i=it(t.data.nodeid);b.append("g").attr("class","node-menu").on("click",function(){d3.event.stopPropagation()}).on("mouseleave",()=>{d3.select(".node-menu").remove(),d3.selectAll(".nodetobechanged").classed("nodetobechanged",!1)}).attr("transform",()=>`translate(${t.x+t.data.width-20},${t.y})`).selectAll("tmp").data(d3.entries(o).filter(function(n){return n.value.attributename==="autosize"?!s:!0}),n=>n.value.menutext).join(function(o){var s=o.append("g").attr("class","menu-entry"),h,c;s.append("rect").attr("y",function(t,i){return i*n}).attr("width",r+e).attr("height",n).attr("data-fillcolour",t.data.fill).attr("data-nodeid",t.data.nodeid).classed("menurect",!0);s.append("text").text(n=>n.value.menutext).attr("y",function(t,i){return i*n}).attr("dy",(n-u/2)*.75).attr("dx",u).classed("menutext",!0);h=s.append("foreignObject").attr("id",n=>n.value.attributename).attr("x",function(n){if(n.value.attributename!=="deletebutton")return r}).attr("y",function(t,i){return i*n}).attr("width",function(n){return n.value.attributename==="deletebutton"?r+e:e}).attr("height",n).attr("data-menuparent",n=>n.value.menuparent);c=h.append(h.attr("data-menuparent")).attr("data-menuelement",n=>n.value.menuelement).attr("class","contextmenudiv");c.append(c.attr("data-menuelement")).attr("type",n=>n.value.menutype).classed("menuerange",n=>n.value.menutype==="range").classed("menucheckbox",n=>n.value.menutype==="checkbox").classed("trashbutton",n=>n.value.attributename==="deletebutton").attr("width",function(n){return n.value.menutype==="color"?e:n.value.menutype==="button"?e:null}).text(function(n){return n.value.menutype==="button"?"Delete":null}).attr("value",function(n){return n.value.menutype==="checkbox"?null:n.value.menutype==="button"?"Delete":Reflect.get(t.data,n.value.attributename)}).property("checked",function(n){return n.value.menutype==="checkbox"?Reflect.get(t.data,n.value.attributename):!1}).attr("min",function(n){return n.value.menutype==="range"?n.value.minvalue:null}).attr("max",function(n){return n.value.menutype==="range"?n.value.maxvalue:null}).attr("step",function(n){return n.value.menutype==="range"?1:null}).attr("data-nodeid",()=>t.data.nodeid).on("input",function(n){d3.event.stopPropagation();n.value.menutype==="checkbox"?(DotNet.invokeMethod("MapMyTime",n.value.dotnetmethod,this.dataset.nodeid,this.checked),Reflect.set(d3.select("#node"+this.dataset.nodeid).datum().data,n.value.attributename,this.checked),i=it(this.dataset.nodeid)):(ii(n.value.dotnetmethod,i,this.value),n.value.menutype==="color"&&gt(i,this.value),n.value.attributename==="fontsizepx"?ut(i,parseInt(this.value)):(tt(),f()))}).on("mousedown",function(){d3.event.stopPropagation()}).on("change",function(n){n.value.attributename==="fontsizepx"&&ut(i,parseInt(this.value))}).on("mouseenter",function(n){if(n.value.attributename==="deletebutton")ot(i,!0);else return null}).on("mouseleave",function(n){if(n.value.attributename==="deletebutton")ot(i,!1);else return null}).on("mouseup",function(n){if(n.value.attributename==="deletebutton")ri(this.dataset.nodeid);else return null})})}function c(i,f){var s,c,l;u=.1;d3.select("#node"+i).selectAll("temptext").data(d3.entries(o)).enter().append("text").text(function(n){return n.value.menutext}).attr("x",-1e3).attr("y",-1e3).attr("class","temptext").style("font-size",f);s=d3.selectAll(".temptext").nodes().map(function(n){return n.getBBox()});r=d3.max(s.map(function(n){return n.width}));u=u*r;r=r+2*u;n=d3.max(s.map(function(n){return(n.height+u/2)*2}));c=d3.select("#node"+i).append("foreignObject").attr("width",r*.5).attr("height",n).attr("class","tempfo");l=c.append("xhtml:div").attr("class","flexdiv");l.append("xhtml:input").attr("type","color").attr("value","#007BFF").attr("class","tempinput");e=d3.select(".tempinput").node().getBoundingClientRect().width/t.data.scale;d3.selectAll(".temptext,.tempfo").remove();h=!0}var n,r,u=.1,o=[],e,h=!1;return s.items=function(){if(!arguments.length)return o;for(i in arguments[0])o.push(arguments[0][i]);return rescale=!0,s},s}async function wt(){u=await DotNet.invokeMethodAsync("MapMyTime","GetConstantAsync","defaultwidth");p=await DotNet.invokeMethodAsync("MapMyTime","GetConstantAsync","defaultheight");f();var n=document.getElementById("d3SVGdiv");n.childElementCount>0?n.replaceChild(s.node(),n.childNodes[1]):n.appendChild(s.node());dt();window.TimeMapUtilities.positionIcons()}async function bt(n){return await DotNet.invokeMethodAsync("MapMyTime","GetConstantAsync",n)}function tt(){t=d3.hierarchy(JSON.parse(DotNet.invokeMethod("MapMyTime","GetTimeMapJson")));c(t)}async function it(n){return await DotNet.invokeMethodAsync("MapMyTime","ReturnNodesToChangeAsync",n)}function kt(n){let t=[];n.forEach(n=>{let i={nodeid:n.nodeid,height:n.height,width:n.width,autosize:n.autosize};t.push(i)});k(t)}async function k(n){let t=await DotNet.invokeMethodAsync("MapMyTime","UpdateNodeDimensionsAsync",n);t.forEach(n=>{var t=d3.select("#node"+n.nodeid).datum().data;t.midpointconnections=n.midpointconnections;t.parentNodeConnection=n.parentnodeconnection;t.connection=n.connection});st()}function c(n){n.descendants().forEach(n=>{n.data.nodeid===0&&t.data.children.length===0?(n.x0=n.x=350,n.y0=n.y=255):(n.x0=n.x=n.data.xCoordinate,n.y0=n.y=n.data.yCoordinate,n.depth=n.data.nodedepth)})}function dt(){s.append("image").attr("id","saveIcon").attr("width","20px").attr("height","20px").attr("cursor","pointer").attr("xlink:href","./css/open-iconic/icons/data-transfer-download.svg").attr("alt","download").on("click",function(){DotNet.invokeMethod("MapMyTime","DownloadMap");d3.event.stopPropagation()})}function rt(n){var t=d3.select("#node"+n.data.nodeid).append("g").attr("class","nodecontextmenu").attr("id","contextmenu"+n.data.nodeid);t.append("rect").attr("transform",()=>`translate(${0},${-20})`).attr("width",()=>n.data.width).attr("height",20).attr("opacity",0).on("click",function(){d3.event.stopPropagation()});t.append("path").attr("id","nodeburger").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("fill","black").attr("stroke-width","0.1").attr("d","M 3.12,8.33 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 C 17.67,6.52 17.17,6 16.55,6 H 3.12 C 2.50,6 2,6.52 2,7.17 c 0,0.64 0.5,1.17 1.12,1.17 z M 16.55,10.67 H 3.12 C 2.5,10.67 2,11.19 2,11.83 2,12.48 2.5,13 3.12,13 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 0,-0.64 -0.5,-1.17 -1.12,-1.17 z m 0,4.67 H 3.12 C 2.5,15.33 2,15.856 2,16.5 c 0,0.64 0.5,1.17 1.12,1.17 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 0,-0.64 -0.5,-1.17 -1.12,-1.17 z").on("mouseenter",function(){d3.select(".node-menu").empty()&&nt(n);d3.event.stopPropagation()}).on("click",function(){d3.event.stopPropagation()})}function gt(n,t){n.then(function(n){n.forEach(n=>{d3.select("#node"+n).attr("fill",t).datum().data.fill=t})})}function ut(n,t){n.then(function(n){n.forEach(n=>{var i=d3.select("#node"+n);i.datum().data.fontsizepx=t});f()})}function ni(n,t,i){let u=DotNet.invokeMethod("MapMyTime","SwitchParent",[n,t,i]),r=d3.hierarchy(JSON.parse(u));r.data.parentNodeId===i?ti(n,t,i,r):f()}function ft(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();r.children.splice(r.children.findIndex(t=>t.data.nodeid===parseInt(n)),1);r.data.children.splice(r.data.children.findIndex(t=>t.nodeid===parseInt(n)),1)}function et(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();n.parent=r;r.children||(r.children=[]);r.children.push(n);r.data.children.push(n.data)}function ti(n,t,i,r){c(r);ft(n,t);et(r,i);f()}async function ii(n,t,i){let r=await t;await DotNet.invokeMethodAsync("MapMyTime",n,r,i)}function ot(n,t){n.then(function(n){n.forEach(n=>{d3.select("#node"+n).classed("deleting",t)})})}function ri(n){let t=d3.select("#node"+n).datum().data.parentNodeId,i=DotNet.invokeMethod("MapMyTime","DeleteNode",n);ft(n,t);i.length>0&&i.forEach(n=>{let i=d3.hierarchy(JSON.parse(n));c(i);et(i,t)});f()}function f(){const i=t.descendants(),r=e.transition().duration(ht);var n=[];b.selectAll(".standardNode").data(i.filter(n=>n.depth),n=>n.data.nodeid).join(function(t){var i=t.append("g").call(nodeDragListener).attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill-opacity",1).attr("stroke-opacity",1).attr("id",n=>"node"+n.data.nodeid).attr("fill",n=>n.data.fill).attr("cursor","pointer").classed("standardNode",!0).on("mouseenter",function(n){d3.select("#contextmenu"+n.data.nodeid).empty()&&!h&&(d3.selectAll(".nodecontextmenu").remove(),rt(n))}).on("mouseleave",function(){d3.selectAll(".nodecontextmenu").remove()}),u=i.append("rect").attr("id",n=>"rectid"+n.data.nodeid).attr("class","noderect").attr("width",n=>n.data.width).attr("height",n=>n.data.height).attr("rx",2).attr("ry",2).attr("stroke","black"),r=i.append("foreignObject").attr("id",n=>"foid"+n.data.nodeid).attr("class","nodefo").attr("width",n=>n.data.width).attr("height",n=>n.data.height),f=r.append("xhtml:div").attr("id",n=>"divid"+n.data.nodeid).attr("tabindex",n=>n.data.nodeid).attr("contenteditable","true").attr("class","flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif").text(n=>n.data.name).on("click",function(n){var i=document.getElementById("divid"+n.data.nodeid),r=window.getSelection(),t=document.createRange();t.setStart(i,0);t.setEnd(i,1);r.removeAllRanges();r.addRange(t);d3.event.stopPropagation()}).on("blur",function(n){n.data.name!==this.innerText&&(n.data.name=this.innerText,DotNet.invokeMethod("MapMyTime","UpdateText",n.data.nodeid,this.innerText))}).on("keyup",function(n){var t=d3.select("#rectid"+n.data.nodeid);n.data.autosize&&parseInt(t.attr("height"),10)!==this.scrollHeight&&(n.data.height=this.scrollHeight,k([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}]),t.attr("height",n.data.height),d3.select("#foid"+n.data.nodeid).attr("height",n.data.height),d3.select("#highlightRect"+n.data.nodeid).attr("height",n.data.height+6),d3.select("#resizehandle"+n.data.nodeid).attr("cy",n.data.height))}).on("paste",function(n){if(n.data.autosize){var t=this;setTimeout(function(){t.dispatchEvent(new Event("keyup"))})}});return i.append("circle").attr("id",n=>"resizehandle"+n.data.nodeid).attr("cx",n=>n.data.width).attr("cy",n=>n.data.height).attr("class","resizehandle").attr("r",7).attr("fill",n=>n.data.fill).call(at),i.append("rect").attr("class","highlightRect").attr("id",n=>"highlightRect"+n.data.nodeid).attr("transform","translate(-3,-3)").attr("width",n=>n.data.width+6).attr("height",function(t){return t.data.autosize&&d3.select("#divid"+t.data.nodeid).node()&&t.data.height!==d3.select("#divid"+t.data.nodeid).node().scrollHeight&&(t.data.height=d3.select("#divid"+t.data.nodeid).node().scrollHeight,n.push(t.data),p=t.data.height,d3.select("#rectid"+t.data.nodeid).attr("height",t.data.height),d3.select("#resizehandle"+t.data.nodeid).attr("cy",t.data.height),d3.select("#foid"+t.data.nodeid).attr("height",t.data.height)),t.data.height+6}).attr("rx",2).attr("ry",2).attr("opacity",.2).style("fill","red").attr("pointer-events","none"),i},function(t){t.attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill",n=>n.data.fill).attr("class",n=>n.data.cssClass);t.select(".flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif");t.select(".noderect").attr("height",function(t){return t.data.autosize&&t.data.height!==d3.select("#divid"+t.data.nodeid).node().scrollHeight&&(t.data.height=d3.select("#divid"+t.data.nodeid).node().scrollHeight,n.push(t.data)),t.data.height}).attr("width",n=>n.data.width);t.select(".nodefo").attr("height",n=>n.data.height).attr("width",n=>n.data.width);t.select(".resizehandle").attr("cx",n=>n.data.width).attr("cy",n=>n.data.height);t.select(".highlightRect").attr("height",n=>n.data.height+6).attr("width",n=>n.data.width+6);t.select(".linklump").attr("cx",n=>n.data.width/2)},n=>n.call(n=>n.transition(r).remove().attr("transform",()=>`translate(${d-24},${4})`).attr("fill-opacity",0).attr("stroke-opacity",0)));n.length>0&&kt(n);st();fi(i)}function ui(n){lt.selectAll(".linklump").data(n.filter(n=>n.target.depth===1),n=>n.target.data.nodeid).join(function(n){n.append("rect").attr("transform",n=>`translate(${n.target.x+n.target.data.width/2-4},${n.target.y-8})`).attr("id",n=>"linklump"+n.target.data.nodeid).attr("width",8).attr("height",8).attr("class","linklump").attr("fill",n=>n.target.data.fill).call(linkDragListener)},function(n){n.attr("transform",n=>`translate(${n.target.x+n.target.data.width/2+-4},${n.target.y-8})`)},function(n){n.remove()})}function st(){const n=t.links();w.selectAll("path").data(n,n=>n.target.id).join(function(n){n.append("path").call(linkDragListener).classed("link",!0).attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));n.append("path").call(linkDragListener).classed("linkborder",!0).attr("id",n=>"linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},function(n){n.attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},n=>n.call(n=>n.attr("d",n=>{const t={x:n.source.x,y:n.source.y};return r({source:t,target:t})}).remove()));ui(n)}function fi(n){ct.selectAll(".proximityRect").data(n.filter(n=>n.depth),n=>n.data.nodeid).join(function(n){n.append("rect").classed("proximityRect",!0).attr("id",n=>"proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-u},${n.y-u})`).attr("width",n=>n.data.width+u*2).attr("height",n=>n.data.height+u*2).attr("opacity",0).style("fill","grey").on("mousemove",function(n){vt(n.data.nodeid)}).on("mouseout",function(){d3.event.relatedTarget?d3.select(d3.event.relatedTarget).classed("proximityRect")||(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1)):(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1))}).on("mouseenter",function(){d3.select(".node-menu").remove();d3.selectAll(".asyncflag").classed("asyncflag",!1)})},function(n){n.attr("transform",n=>`translate(${n.x-u},${n.y-u})`).attr("width",n=>n.data.width+u*2).attr("height",n=>n.data.height+u*2)},function(n){n.remove()})}var t=d3.hierarchy(JSON.parse(n)),r,p,o,nt,u;const ht=d3.event&&d3.event.altKey?2500:250;r=d3.linkHorizontal().x(function(n){return n.x}).y(function(n){return n.y});const d=700;c(t);const s=d3.create("svg").attr("id","svg").attr("viewBox",[0,0,d,700]).style("font",t.data.fontsizepx+"px sans-serif").style("user-select","none").on("click",function(){var r=d3.mouse(document.getElementsByTagName("g")[0]),n;d3.event.stopPropagation();let i=d3.select(".show");n=0;i.empty()||(n=i.datum().data.nodeid);DotNet.invokeMethodAsync("MapMyTime","AddNewNodeAsync",r,n,p).then(n=>{var i=d3.hierarchy(JSON.parse(n)),r,u=d3.select("#node"+i.data.parentNodeId);r=u.empty()?t:u.datum();i.x0=i.x=i.data.xCoordinate;i.y0=i.y=i.data.yCoordinate;i.depth=i.data.nodedepth;i.parent=r;r.children||(r.children=[],r.data.children=[]);r.children.push(i);r.data.children.push(i.data);f()})});s.append("filter").attr("id","deletefilter").append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation","5");const e=s.append("g").attr("fill","none").attr("width","100%").attr("height","100%").attr("transform","translate("+t.data.xTranslate+","+t.data.yTranslate+") scale("+t.data.scale+")").on("mouseleave",function(){var n=d3.selectAll(".show");n.empty()||n.classed("show",!1)});s.call(d3.zoom().clickDistance(10).on("zoom",function(){d3.event.target.nodeName!=="PATH"&&e.attr("transform",d3.event.transform)}).on("end",function(){d3.event.target.nodeName!=="PATH"&&(d3.event.transform.k===1&&d3.event.transform.x===0&&d3.event.transform.y===0||(DotNet.invokeMethod("MapMyTime","UpdateTranslation",d3.event.transform),t.data.scale=d3.event.transform.k))}));const ct=e.append("g").attr("id","proximityrect"),w=e.append("g").attr("id","linkgroup").attr("class","glink"),b=e.append("g").attr("id","nodegroup"),lt=e.append("g").attr("id","lumpgroup");var l=!1,h=!1,a=!1,v,y;nodeDragListener=d3.drag().on("start",function(n){if(a=!0,h=!1,d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey){l=!0;v=0;y=0;var t=e.append("g").attr("id","draggroup"),i=t.append("g").attr("id","linkdraggroup").attr("class","glink");n.descendants().forEach(r=>{n.data.nodeid!=r.data.nodeid&&(t.append(function(){return d3.select("#node"+r.data.nodeid).remove().node()}),i.append(function(){return d3.select("#link-"+r.data.parentNodeId+"-"+r.data.nodeid).remove().node()}),i.append(function(){return d3.select("#linkborder-"+r.data.parentNodeId+"-"+r.data.nodeid).remove().node()}))})}d3.event.sourceEvent.stopPropagation()}).on("drag",function(n){if(a){h||(d3.select(".nodecontextmenu").remove(),h=!0);n.x+=d3.event.dx;n.y+=d3.event.dy;var t=d3.select("#node"+n.data.nodeid);if(t.attr("transform","translate("+n.x+","+n.y+")"),l){if(n.data.parentNodeId!==0){let t=DotNet.invokeMethod("MapMyTime","UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0);d3.select("#link-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>r({source:t.linkendpoints[1],target:t.linkendpoints[0]}))}v+=d3.event.dx;y+=d3.event.dy;d3.select("#draggroup").attr("transform","translate("+v+","+y+")")}else{let t=DotNet.invokeMethod("MapMyTime","RecalculateMovedNodeLinks",n.data.nodeid,n.x,n.y);t.forEach(t=>{t.nodeid!==n.data.nodeid?d3.select("#link-"+n.data.nodeid+"-"+t.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]})):n.data.parentNodeId!==0&&d3.select("#link-"+n.data.parentNodeId+"-"+t.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]}))})}}}).on("end",function(n){var i,f;if(a&&(a=!1,h)){h=!1;n.data.xCoordinate=n.x;n.data.yCoordinate=n.y;let t=DotNet.invokeMethod("MapMyTime","UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0);n.data.midpointconnections=JSON.parse(JSON.stringify(t.midpointconnections));n.data.parentNodeConnection=t.parentnodeconnection;n.data.connection=t.connection;n.data.parentNodeId===0?d3.select("#linklump"+n.data.nodeid).attr("transform",()=>`translate(${n.x+n.data.width/2-4}, ${n.y-8})`):d3.select("#linkborder-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]}));l?(i=[],n.descendants().forEach(t=>{if(i.push(t.data.nodeid),n.data.nodeid!=t.data.nodeid){t.x=t.data.xCoordinate+=v;t.y=t.data.yCoordinate+=y;let n=DotNet.invokeMethod("MapMyTime","UpdateImpactedNode",t.data.nodeid,t.x,t.y,!0);t.data.midpointconnections=JSON.parse(JSON.stringify(n.midpointconnections));t.data.parentNodeConnection=n.parentnodeconnection;t.data.connection=n.connection;w.append(function(){var i=d3.select("#link-"+t.data.parentNodeId+"-"+t.data.nodeid);return i.attr("d",r({source:n.linkendpoints[0],target:n.linkendpoints[1]})),i.remove().node()});w.append(function(){var i=d3.select("#linkborder-"+t.data.parentNodeId+"-"+t.data.nodeid);return i.attr("d",r({source:n.linkendpoints[0],target:n.linkendpoints[1]})),i.remove().node()});b.append(function(){var n=d3.select("#node"+t.data.nodeid);return n.attr("transform","translate("+t.x+","+t.y+")"),n.remove().node()})}DotNet.invokeMethodAsync("MapMyTime","UpdateProximityMapAsync",i).then();d3.select("#proximityrect"+t.data.nodeid).attr("transform",()=>`translate(${t.x-u},${t.y-u})`)}),d3.select("#draggroup").remove(),l=!1):(f=d3.selectAll("path").filter('[id^="link-'+n.data.nodeid+'-"]'),f.attr("d",n=>{let t=DotNet.invokeMethod("MapMyTime","UpdateImpactedNode",n.target.data.nodeid,n.target.x,n.target.y,!1);n.target.data.parentNodeConnection=t.parentnodeconnection;n.target.data.connection=t.connection;var i=r({source:t.linkendpoints[0],target:t.linkendpoints[1]});return d3.select("#linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",i),i}),DotNet.invokeMethodAsync("MapMyTime","UpdateProximityMapAsync",[n.data.nodeid]).then(),d3.select("#proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-u},${n.y-u})`));rt(n)}});o=-1;linkDragListener=d3.drag().on("start",function(n){const t=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid),i=n.target.data.midpointconnections[n.target.data.connection];t.classed("linkdragging",!0).attr("d",()=>{const n={x:d3.event.x,y:d3.event.y};return r({source:n,target:i})}).attr("pointer-events","none")}).on("drag",function(n){const u=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid);u.attr("d",()=>{const t={x:d3.event.x,y:d3.event.y};return r({source:t,target:n.target.data.midpointconnections[n.target.data.connection]})});var i=d3.mouse(d3.select("body").node()),t=document.elementFromPoint(i[0],i[1]);t&&t.id.includes("proximityrect")&&yt(d3.select(t).datum().data.nodeid,n.target.data.nodeid)}).on("end",function(n){const i=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid);i.classed("linkdragging",!1).attr("pointer-events","auto").attr("d",()=>{const t={x:d3.event.x,y:d3.event.y};return r({source:t,target:n.target.data.midpointconnections[n.target.data.connection]})});var t=d3.select(".show");if(t.empty()&&(t=d3.select(".nodecontextmenu")),o=t.empty()?0:t.datum().data.nodeid,o===n.target.data.nodeid&&(o=0),o===n.source.data.nodeid){i.attr("d",()=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));return}ni(n.target.data.nodeid,n.source.data.nodeid,o)});var at=d3.drag().on("start",function(n){d3.event.sourceEvent.stopPropagation();n.data.autosize=!1}).on("drag",function(n){n.data.width+=d3.event.dx;n.data.height+=d3.event.dy;k([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}]);d3.select("#foid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height);d3.select("#rectid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height)}).on("end",function(){tt();f()}),vt=function(n){DotNet.invokeMethodAsync("MapMyTime","GetParentNodeIdFromProximalNode",n,d3.mouse(document.getElementsByTagName("g")[0])).then(function(n){g(n)})},yt=function(n,t){DotNet.invokeMethodAsync("MapMyTime","GetConnectionNodeId",n,d3.mouse(document.getElementsByTagName("g")[0]),t).then(function(n){g(n)})};bt("contextmenuitems").then(function(n){nt=pt().items(n)});wt()}};window.addEventListener("resize",window.TimeMapUtilities.positionIcons);