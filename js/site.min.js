window.TimeMapUtilities={getBoundengRectOffset:function(t){const e=document.getElementById(t).getBoundingClientRect();return{left:e.left+window.scrollX,top:e.top+window.scrollY}},saveAsFile:function(t,e){var n=prompt("Please enter a file name",t);if(n){var a=document.createElement("a");a.download=n+".json",a.href="data:application/octet-stream;base64,"+e,document.body.appendChild(a),a.click(),document.body.removeChild(a),DotNet.invokeMethod("MapMyTime","UpdateText",0,n)}},openURL:function(){return prompt("Enter a link to Json file to dowload","https://MapMyTime/MapMyTime.json")},cursorStyle:function(t){document.body.style.cursor=t},runFileInput:function(t){fileInput.click()},alertMessage:function(t){alert(t)},unsavedChangesOK:function(){return!window.mapHasChanged||confirm("You have unsaved changes, do you want to continue?")},updateURLwithoutReload:function(t){window.history.pushState("data","Map My Time",t)}},window.blazorLocalStorage={get:t=>t in localStorage?JSON.parse(localStorage[t]):null,set:(t,e)=>{localStorage[t]=JSON.stringify(e)},delete:t=>{delete localStorage[t]}},window.D3TimeMapUtilities={positionIcons:function(){var t=document.getElementById("svg");if(t){var e=t.getBoundingClientRect(),n=document.getElementById("saveIcon"),a=n.getBoundingClientRect(),d=t.createSVGPoint();if(d.y=e.top+4,d.x=e.right-a.width-4,n.setAttribute("x",d.matrixTransform(t.getScreenCTM().inverse()).x),n.setAttribute("y",d.matrixTransform(t.getScreenCTM().inverse()).y),window.touchTrigger){let n=d3.zoomTransform(t),a=n.x+window.touchedData.x0*n.k+e.width/2,d=n.y+window.touchedData.y0*n.k+e.width/2;d3.select("topGroup").transition().duration(500).attr("transform","translate("+a+","+d+") scale("+n.k+")"),window.touchTrigger=!1}}window.D3TimeMapUtilities.setSmallScreen()},setSmallScreen:function(){document.body.clientWidth<768?window.isScreenSmall=!0:window.isScreenSmall=!1},isFirstVisit:function(){return""==window.D3TimeMapUtilities.getCookie("firstvisit")},setFirstVisit:function(){window.D3TimeMapUtilities.setCookie("firstvisit",!0,90)},getCookie:function(t){for(var e=t+"=",n=decodeURIComponent(document.cookie).split(";"),a=0;a<n.length;a++){for(var d=n[a];" "==d.charAt(0);)d=d.substring(1);if(0==d.indexOf(e))return d.substring(e.length,d.length)}return""},setCookie:function(t,e,n){var a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3);var d="expires="+a.toUTCString();document.cookie=t+"="+e+";"+d+";path=/"},createD3Tree:function(t){var e=d3.hierarchy(JSON.parse(t));const n=event&&event.altKey?2500:250;var a=d3.linkHorizontal().x((function(t){return t.X??t.x})).y((function(t){return t.Y??t.y}));var d,o,r,s,c,l;J(e),window.mapHasChanged=!1;var u,p,h,m,f,g=!1,y="",w=!1,v=!1,x=!1,k=!1,A=_.throttle((function(t){if(d3.select("#node"+t.data.nodeid).attr("transform","translate("+t.x+","+t.y+")"),w){if(0!==t.data.parentNodeId){let e=K(!0,"UpdateImpactedNode",t.data.nodeid,t.x,t.y,!0);d3.select("#link-"+t.data.parentNodeId+"-"+t.data.nodeid).attr("d",(()=>a({source:e.linkendpoints[1],target:e.linkendpoints[0]})))}d3.select("#draggroup").attr("transform","translate("+(t.x-initialX)+","+(t.y-initialY)+")")}else!function(t){K(!0,"RecalculateMovedNodeLinks",t.data.nodeid,t.x,t.y).forEach((e=>{e.nodeid!==t.data.nodeid?d3.select("#link-"+t.data.nodeid+"-"+e.nodeid).attr("d",(()=>a({source:e.linkendpoints[0],target:e.linkendpoints[1]}))):0!==t.data.parentNodeId&&d3.select("#link-"+t.data.parentNodeId+"-"+e.nodeid).attr("d",(()=>a({source:e.linkendpoints[0],target:e.linkendpoints[1]})))}))}(t)}),16);const b=d3.create("svg").attr("id","svg").attr("viewBox",[0,0,700,700]).style("font",e.data.fontsizepx+"px sans-serif").style("user-select","none").on("click",(function(t){if(""!==y)return void document.getElementById(y).blur();var e=d3.pointer(t,document.getElementsByTagName("g")[0]);t.stopPropagation();let n=d3.select(".show");var a=0;n.empty()||(a=n.datum().data.nodeid),B(a,e)})).on("touchstart",(function(t){1===(u=d3.pointers(t,document.getElementsByTagName("g")[0])).length&&(t.srcElement.id.includes("svg")||t.srcElement.id.includes("proximityrect"))&&(g=!0),"input"!==t.target.localName&&t.preventDefault()})).on("touchmove",(function(){g=!1})).on("touchend",(function(t){if(g){var e=0;if(t.changedTouches[0].target.id.includes("proximityrect")){let n=d3.select(t.changedTouches[0].target).datum().data.nodeid;e=K(window.mapHasChanged,"GetParentNodeIdFromProximalNode",n,u[0])}B(e,u[0]),g=!1}"input"!==t.target.localName&&(t.preventDefault(),document.activeElement.blur())}));b.append("filter").attr("id","deletenodefilter").append("feGaussianBlur").attr("stdDeviation","5"),b.append("filter").attr("id","makebrighterfilter").append("feColorMatrix").attr("type","matrix").attr("values","1.2 0 0 0 0 0 1.2 0 0 0 0 0 1.2 0 0 0 0 0 1 0"),b.append("filter").attr("id","redfilter").append("feColorMatrix").attr("type","matrix").attr("values","0 0 0 1 0 0 0 0 0 0 1 1 1 0 0 0 0 0 1.5 0");const T=b.append("g").attr("fill","none").attr("width","100%").attr("height","100%").attr("id","topGroup").attr("class","topGroup").on("mouseleave",(function(){var t=d3.selectAll(".show");t.empty()||t.classed("show",!1)}));var C=d3.zoom().clickDistance(10).on("zoom",(function(t){k||"PATH"!==t.target.nodeName&&T.attr("transform",t.transform)})).on("end",(function(t){k||"PATH"!==t.target.nodeName&&(1===t.transform.k&&0===t.transform.x&&0===t.transform.y||(K(!0,"UpdateTranslation",t.transform),e.data.scale=t.transform.k)),g=!1}));b.call(C).on("dblclick.zoom",null);const E=T.append("g").attr("id","proximityrect"),I=T.append("g").attr("id","linkgroup").attr("class","glink"),N=T.append("g").attr("id","nodegroup"),S=T.append("g").attr("id","lumpgroup");function M(t){w=!0,0,0,d3.select("#draggroup").remove();var e,n=T.append("g").attr("id","draggroup"),a=n.append("g").attr("id","linkdraggroup").attr("class","glink");e=t.descendants(),d3.selectAll(".show").classed("show",!1),e.forEach((t=>{d3.select("#highlightRect"+t.data.nodeid).classed("show",!0)})),t.descendants().forEach((e=>{t.data.nodeid!=e.data.nodeid&&(n.append((function(){return d3.select("#node"+e.data.nodeid).remove().node()})),a.append((function(){return d3.select("#gpathlink-"+e.data.parentNodeId+"-"+e.data.nodeid).remove().node()})))}))}nodeDragListener=d3.drag().filter(!0).on("start",(function(t,e){k=!0,initialX=e.x,initialY=e.y,(t.sourceEvent.ctrlKey||t.sourceEvent.metaKey||v)&&M(e)})).on("drag",(function(t,e){window.touchTrigger=!1,k&&(x||(et(),x=!0),e.x+=t.dx,e.y+=t.dy,A(e))})).on("end",(function(t,e){if(d3.selectAll(".highlightRect").classed("show",!1),!k)return;if(k=!1,!x&&!w)return void at(e);if(!x&&w)return e.descendants().forEach((t=>{I.append((function(){return d3.select("#gpathlink-"+t.data.parentNodeId+"-"+t.data.nodeid).remove().node()})),N.append((function(){return d3.select("#node"+t.data.nodeid).remove().node()}))})),void(w=!1);e.data.xCoordinate=e.x0=e.x,e.data.yCoordinate=e.y0=e.y;let n=K(!0,"UpdateImpactedNode",e.data.nodeid,e.x,e.y,!0);if(e.data.midpointconnections=n.midpointconnections,e.data.parentNodeConnection=n.parentnodeconnection,e.data.connection=n.connection,0===e.data.parentNodeId?d3.select("#linklump"+e.data.nodeid).attr("transform",(()=>`translate(${e.x+e.data.width/2-4}, ${e.y-8})`)):d3.select("#linkborder-"+e.data.parentNodeId+"-"+e.data.nodeid).attr("d",(()=>a({source:n.linkendpoints[0],target:n.linkendpoints[1]}))),w){d3.select("#node"+e.data.nodeid).attr("cursor","wait");var d=[];e.descendants().forEach((t=>{if(d.push(t.data.nodeid),e.data.nodeid!=t.data.nodeid){t.x=t.data.xCoordinate+=e.x-initialX,t.y=t.data.yCoordinate+=e.y-initialY;let n=K(!0,"UpdateImpactedNode",t.data.nodeid,t.x,t.y,!0);t.data.midpointconnections=n.midpointconnections,t.data.parentNodeConnection=n.parentnodeconnection,t.data.connection=n.connection;let d=d3.select("#gpathlink-"+t.data.parentNodeId+"-"+t.data.nodeid);I.append((function(){return d.select(".link").attr("d",a({source:n.linkendpoints[0],target:n.linkendpoints[1]})),d.select(".linkborder").attr("d",a({source:n.linkendpoints[0],target:n.linkendpoints[1]})),d.remove().node()})),N.append((function(){var e=d3.select("#node"+t.data.nodeid);return e.attr("transform","translate("+t.x+","+t.y+")"),e.remove().node()}))}d3.select("#proximityrect"+t.data.nodeid).attr("transform",(e=>`translate(${t.x-r/2},${t.y-s/2})`))})),W(!0,"UpdateProximityMapAsync",d),d3.select("#draggroup").remove(),w=!1,d3.select("#node"+e.data.nodeid).attr("cursor","pointer")}else!function(t){d3.selectAll("path").filter('[id^="link-'+t.data.nodeid+'-"]').attr("d",(t=>{let e=K(!0,"UpdateImpactedNode",t.target.data.nodeid,t.target.x,t.target.y,!1);t.target.data.parentNodeConnection=e.parentnodeconnection,t.target.data.connection=e.connection;var n=a({source:e.linkendpoints[0],target:e.linkendpoints[1]});return d3.select("#linkborder-"+t.source.data.nodeid+"-"+t.target.data.nodeid).attr("d",n),n})),W(!0,"UpdateProximityMapAsync",[t.data.nodeid]),d3.select("#proximityrect"+t.data.nodeid).attr("transform",(t=>`translate(${t.x-r/2},${t.y-s/2})`))}(e);X(e),Object.prototype.toString.call(t.sourceEvent).includes("TouchEvent")&&document.activeElement.blur()}));var z,U,R=-1;linkDragListener=d3.drag().on("start",(function(t,e){"touchstart"===t.sourceEvent.type&&t.sourceEvent.preventDefault();const n=d3.select("#link-"+e.source.data.nodeid+"-"+e.target.data.nodeid),d=e.target.data.midpointconnections[e.target.data.connection];n.classed("linkdragging",!0).attr("d",(e=>{const n={X:t.x,Y:t.y};return a({source:n,target:d})})).attr("pointer-events","none")})).on("drag",(function(t,e){d3.select("#link-"+e.source.data.nodeid+"-"+e.target.data.nodeid).attr("d",(n=>{const d={x:t.x,y:t.y};return a({source:d,target:e.target.data.midpointconnections[e.target.data.connection]})}));var n=d3.pointers(t,d3.select("body").node())[0],d=document.elementFromPoint(n[0],n[1]);d&&d.id.includes("proximityrect")&&$(d3.select(d).datum().data.nodeid,e.target.data.nodeid,t)})).on("end",(function(t,e){const n=d3.select("#link-"+e.source.data.nodeid+"-"+e.target.data.nodeid);n.classed("linkdragging",!1).attr("pointer-events","auto").attr("d",(n=>{const d={x:t.x,y:t.y};return a({source:d,target:e.target.data.midpointconnections[e.target.data.connection]})}));var d=d3.select(".show");d.empty()&&(d=d3.select(".nodecontextmenu")),(R=d.empty()?0:d.datum().data.nodeid)===e.target.data.nodeid&&(R=0),d3.selectAll(".show").classed("show",!1),R!==e.source.data.nodeid?function(t,e,n){let a=K(!0,"SwitchParent",[t,e,n]),d=d3.hierarchy(JSON.parse(a));if(d.data.parentNodeId===n)!function(t,e,n,a){J(a),Y(t,e),V(a,n),function(t,e,n){const a=new Set(K(window.mapHasChanged,"GetChangedNodeSet").result);let d=ot(a);ct(d,a),lt(it((new Set).add(n).add(t).add(e)),(new Set).add(n).add(t).add(e)),ut(d,a)}(t,e,n)}(t,e,n,d);else{const t=new Set(K(window.mapHasChanged,"GetChangedNodeSet").result);lt(it(t),t)}}(e.target.data.nodeid,e.source.data.nodeid,R):n.attr("d",(t=>0===e.source.data.nodeid?null:a({source:e.source.data.midpointconnections[e.target.data.parentNodeConnection],target:e.target.data.midpointconnections[e.target.data.connection]})))}));var D=d3.drag().on("start",(function(t,e){t.sourceEvent.stopPropagation(),e.data.autosize=!1,z=e.data.height,U=e.data.width})).on("drag",(function(t,e){z+=t.dy,U+=t.dx;let n=!1;z>1&&(e.data.height=z,n=!0),U>1&&(e.data.width=U,n=!0),n&&H(e,!1)})).on("end",(function(t,e){H(e,!0)}));function H(t,e){L([{nodeid:t.data.nodeid,height:t.data.height,width:t.data.width,autosize:t.data.autosize}],e),d3.select("#foid"+t.data.nodeid).attr("width",t.data.width).attr("height",t.data.height),d3.select("#rectid"+t.data.nodeid).attr("width",t.data.width).attr("height",t.data.height)}var $=function(t,e,n){DotNet.invokeMethodAsync("MapMyTime","GetConnectionNodeId",t,d3.pointers(n,document.getElementsByTagName("g")[0])[0],e).then((function(t){P(t)}))};async function B(t,n){let a=await W(!0,"AddNewNodeAsync",n,t,o);var d,i=d3.hierarchy(JSON.parse(a)),r=d3.select("#node"+i.data.parentNodeId);d=r.empty()?e:r.datum(),i.x0=i.x=i.data.xCoordinate,i.y0=i.y=i.data.yCoordinate,i.depth=i.data.nodedepth,i.parent=d,d.children||(d.children=[],d.data.children=[]),d.children.push(i),d.data.children.push(i.data),rt(),et(),g||at(i),g=!1}function P(t){var e=d3.selectAll(".show");1===e.size()&&e.datum().data.nodeid===t||d3.selectAll(".asyncflag").empty()&&(e.classed("show",!1),d3.select("#highlightRect"+t).classed("show",!0))}function G(){var t,n,a,d=.1,o=[],r=!1;function s(i){d3.select(".node-menu").remove();let s=i.data.autosize;r||function(i,s){d=.1,d3.select("#node"+i).selectAll("temptext").data(o).enter().append("text").text((function(t){return t.menutext})).attr("x",-1e3).attr("y",-1e3).attr("class","temptext").style("font-size",s);var c=d3.selectAll(".temptext").nodes().map((function(t){return t.getBBox()}));n=(n=d3.max(c.map((function(t){return t.width}))))+2*(d*=n),t=d3.max(c.map((function(t){return 2*(t.height+d/2)}))),d3.select("#node"+i).append("foreignObject").attr("width",.5*n).attr("height",t).attr("class","tempfo").append("xhtml:div").attr("class","contexmenuflexdiv").append("xhtml:input").attr("type","color").attr("value","#007BFF").attr("class","tempinput"),a=d3.select(".tempinput").node().getBoundingClientRect().width/e.data.scale,d3.selectAll(".temptext,.tempfo").remove(),r=!0}(i.data.nodeid,10);var c=j(i.data.nodeid);N.append("g").attr("class","node-menu").on("click",(function(t){t.stopPropagation()})).on("mouseleave",(()=>{d3.select(".node-menu").remove(),d3.selectAll(".nodetobechanged").classed("nodetobechanged",!1)})).attr("transform",(t=>`translate(${i.x+i.data.width-20},${i.y})`)).selectAll("tmp").data(d3.filter(o,(function(t){return"autosize"!==t.attributename||!s})),(t=>t.menutext)).join((function(o){var r=o.append("g").attr("class","menu-entry");r.append("rect").attr("id",(t=>"menurect"+t.attributename)).attr("y",(function(e,n){return n*t})).attr("width",n+a).attr("height",t).attr("data-fillcolour",i.data.fill).attr("data-nodeid",i.data.nodeid).classed("menurect",!0),r.append("text").text((t=>t.menutext)).attr("y",(function(e,n){return n*t})).attr("dy",.75*(t-d/2)).attr("dx",d).classed("menutext",!0);var s=r.append("foreignObject").attr("id",(t=>t.attributename)).on("keyup",(function(t){!function(t,e){if("ArrowUp"===event.key){let n=h.findIndex((e=>e.attributename===t.value.attributename));0===n?(et(),document.getElementById("divid"+e).focus()):document.getElementById("menuel"+h[n-1].attributename).focus()}if("ArrowDown"===event.key){let n=h.findIndex((e=>e.attributename===t.value.attributename)),a=document.getElementById("menuel"+h[n+1].attributename);a?a.focus():(et(),document.getElementById("divid"+e).focus())}}(t,i.data.nodeid)})).attr("x",(function(t){if("deletebutton"!==t.attributename)return n})).attr("y",(function(e,n){return n*t})).attr("width",(function(t){return"deletebutton"===t.attributename?n+a:a})).attr("height",t).attr("data-menuparent",(t=>t.menuparent)),l=s.append(s.attr("data-menuparent")).attr("data-menuelement",(t=>t.menuelement)).attr("class","contextmenudiv");l.append(l.attr("data-menuelement")).attr("type",(t=>t.menutype)).attr("id",(t=>"menuel"+t.attributename)).classed("menuerange",(t=>"range"===t.menutype)).classed("menucheckbox",(t=>"checkbox"===t.menutype)).classed("trashbutton",(t=>"deletebutton"===t.attributename)).attr("width",(function(t){return"color"===t.menutype||"button"===t.menutype?a:null})).text((function(t){return"button"===t.menutype?"Delete":null})).attr("value",(function(t){return"checkbox"===t.menutype?null:"button"===t.menutype?"Delete":Reflect.get(i.data,t.attributename)})).property("checked",(function(t){return"checkbox"===t.menutype&&Reflect.get(i.data,t.attributename)})).attr("min",(function(t){return"range"===t.menutype?t.minvalue:null})).attr("max",(function(t){return"range"===t.menutype?t.maxvalue:null})).attr("step",(function(t){return"range"===t.menutype?1:null})).attr("data-nodeid",(t=>i.data.nodeid)).on("input",(function(t,n){var a,d;t.stopPropagation(),"checkbox"===n.menutype?(K(!0,n.dotnetmethod,parseInt(this.dataset.nodeid),this.checked),Reflect.set(d3.select("#node"+this.dataset.nodeid).datum().data,n.attributename,this.checked),c=j(this.dataset.nodeid)):(!async function(t,e,n){let a=await e;await DotNet.invokeMethodAsync("MapMyTime",t,a,n)}(n.dotnetmethod,c,this.value),"color"===n.menutype?(a=c,d=this.value,a.then((function(t){t.forEach((t=>{d3.select("#node"+t).attr("fill",d).datum().data.fill=d}))}))):"fontsizepx"===n.attributename?q(c,parseInt(this.value)):(J(e=d3.hierarchy(JSON.parse(K(window.mapHasChanged,"GetTimeMapJson")))),rt()))})).on("keydown",(function(t){"ArrowUp"!==t.key&&"ArrowDown"!==t.key||t.preventDefault()})).on("keyup",(function(t,e){" "!==t.key&&"Enter"!==t.key||"deletebutton"===e.attributename&&tt(parseInt(this.dataset.nodeid))})).on("mousedown",(function(t){t.stopPropagation()})).on("change",(function(t,e){"fontsizepx"===e.attributename&&q(c,parseInt(this.value))})).on("mouseenter focus",(function(t,e){if(d3.select("#menurect"+e.attributename).attr("filter","url(#makebrighterfilter)"),"deletebutton"!==e.attributename)return null;Q(c,!0)})).on("mouseleave blur",(function(t,e){if(d3.select("#menurect"+e.attributename).attr("filter",null),"deletebutton"!==e.attributename)return null;Q(c,!1)})).on("mouseup",(function(t,e){if("deletebutton"!==e.attributename)return null;tt(parseInt(this.dataset.nodeid))}))}))}return s.items=function(t){if(!arguments.length)return o;for(i in arguments[0])o.push(arguments[0][i]);return rescale=!0,s},s}async function O(t){return await W(window.mapHasChanged,"GetConstantAsync",t)}async function j(t){return await W(window.mapHasChanged,"ReturnNodesToChangeAsync",parseInt(t))}function L(t,e){let n=[];t.forEach((t=>{let e={nodeid:t.nodeid,height:t.height,width:t.width,autosize:t.autosize};n.push(e)})),async function(t,e,n){let a=await W(!0,"UpdateNodeDimensionsAsync",t,n),d=[];a.forEach((t=>{let e=JSON.parse(t);d3.select("#node"+e.nodeid).datum().data.midpointconnections=e.midpointconnections,d3.select("#node"+e.nodeid).datum().data.parentNodeConnection=e.parentnodeconnection,d3.select("#node"+e.nodeid).datum().data.connection=e.connection,d.push(e.nodeid)})),st(d)}(JSON.stringify(n),0,e)}function J(t){t.descendants().forEach(((t,n)=>{0===t.data.nodeid&&0===e.data.children.length?(t.x0=t.x=350,t.y0=t.y=255,d=!0):(t.x0=t.x=t.data.xCoordinate,t.y0=t.y=t.data.yCoordinate,t.depth=t.data.nodedepth,d=!1)}))}function X(t){var e=d3.select("#node"+t.data.nodeid).append("g").attr("class","nodecontextmenu").attr("id","contextmenu"+t.data.nodeid);e.append("rect").attr("transform",(t=>"translate(0,-20)")).attr("width",(e=>t.data.width)).attr("height",20).attr("opacity",0).on("click",(function(t){t.stopPropagation()}));var n=e.append("g");n.append("path").attr("id","contextmenuicon").attr("transform",(e=>`translate(${t.data.width-20},-20)`)).attr("class","contextmenuicon").attr("d","M 0, 4 H 15 m -15, 6 H 15 m -15, 6 H 15"),n.append("rect").attr("transform",(e=>`translate(${t.data.width-20},-20)`)).attr("width","20").attr("height","20").attr("fill","none").attr("pointer-events","visible").on("mouseenter",(function(e,n){F(t)})).on("touchstart",(function(t,e){if(d3.select("#contextmenuicon").classed("closeicon"))et();else{const t=new Event("mouseenter");this.dispatchEvent(t)}t.preventDefault(),t.stopPropagation()})).on("mousedown",(function(t,e){d3.select("#contextmenuicon").classed("closeicon")&&et(),t.stopPropagation()}))}function F(t){d3.select(".node-menu").empty()&&(d3.select("#contextmenuicon").attr("d","M 0,4 L 12,16 M 0,16 L 12,4"),d3.select("#contextmenuicon").classed("closeicon",!0),m(t),document.getElementById("menuel"+h[0].attributename).focus()),event.stopPropagation()}function q(t,e){t.then((function(n){n.forEach((t=>{d3.select("#node"+t).datum().data.fontsizepx=e})),t.then((function(t){st(t)}))}))}function Y(t,n){var a;(a=0===n?e:d3.select("#node"+n).datum()).children.splice(a.children.findIndex((e=>e.data.nodeid===parseInt(t))),1),a.data.children.splice(a.data.children.findIndex((e=>e.nodeid===parseInt(t))),1)}function V(t,n){var a;a=0===n?e:d3.select("#node"+n).datum(),t.parent=a,a.children||(a.children=[]),a.children.push(t),a.data.children.push(t.data)}function K(t,e,...n){return t!==window.mapHasChanged&&Z(t),DotNet.invokeMethod("MapMyTime",e,...n)}async function W(t,e,...n){return t!==window.mapHasChanged&&Z(t),DotNet.invokeMethodAsync("MapMyTime",e,...n)}function Z(t){window.mapHasChanged=t,t?d3.select("#saveIcon").attr("filter","url(#redfilter"):d3.select("#saveIcon").attr("filter",null)}function Q(t,e){t.then((function(t){t.forEach((t=>{e?d3.select("#node"+t).attr("filter","url(#deletenodefilter)"):d3.select("#node"+t).attr("filter",null)}))}))}function tt(t){let e=d3.select("#node"+t).datum().data.parentNodeId,n=K(!0,"DeleteNode",t);Y(t,e),n.length>0&&(n.forEach((t=>{let n=d3.hierarchy(JSON.parse(t));J(n),V(n,e)})),rt()),et(),rt()}function et(){d3.selectAll(".node-menu").remove(),d3.selectAll(".nodecontextmenu").remove()}function nt(t){if(t.data.name.startsWith(p))return void at(t);let e,n,a,d,o;if(document.caretPositionFromPoint?(e=document.caretPositionFromPoint(event.clientX,event.clientY),n=e.offsetNode,a=e.offset):document.caretRangeFromPoint&&(e=document.caretRangeFromPoint(event.clientX,event.clientY),n=e.startContainer,a=e.startOffset),!n)return at(t),void document.getElementById("divid"+t.data.nodeid).focus();o=document.createRange(),d=window.getSelection(),o.setStart(n,a),o.collapse(!0),d.removeAllRanges(),d.addRange(o)}function at(t){var e=document.getElementById("divid"+t.data.nodeid),n=window.getSelection(),a=document.createRange(),d=1;t.data.name.startsWith(p)&&(d=0),a.setStart(e,d),a.setEnd(e,1),n.removeAllRanges(),n.addRange(a),e.focus()}function dt(t){if(event.altKey&&event.shiftKey&&event.key.startsWith("Arrow")){let e=JSON.parse(K(window.mapHasChanged,"ProcessArrowEvent",event.key,t.data.nodeid));if(e.navigatetoid>0){at(d3.select("#node"+e.navigatetoid).datum())}else if(0===e.navigatetoid&&0!=e.newnodeparentid){let t=[e.x,e.y];B(e.newnodeparentid,t)}}event.altKey&&"m"===event.key&&F(t)}function ot(t){return K(window.mapHasChanged,"ClearChangedNodeSet"),0===t.size||1===t.size&&"0"===t.$0?e.descendants():e.descendants().filter((e=>t.has(e.data.nodeid)))}function it(t){return K(window.mapHasChanged,"ClearChangedNodeSet"),0===t.size||1===t.size&&"0"===t.$0?e.links():e.links().filter((e=>t.has(e.source.data.nodeid)&&t.has(e.target.data.nodeid)))}function rt(){const t=new Set(K(window.mapHasChanged,"GetChangedNodeSet").result);let e=ot(t);ct(e,t),lt(it(t),t),ut(e,t)}function st(t){nodesToUpdate=e.descendants().filter((e=>new Set(t).has(e.data.nodeid))),ct(nodesToUpdate,new Set(t));const n=(0===(a=new Set(t)).size||1===a.size&&"0"===a.$0||e.descendants().filter((t=>a.has(t.data.nodeid))).map((t=>t.data.parentNodeId)).forEach((t=>a.add(t))),a);var a;lt(it(n),n),ut(nodesToUpdate,new Set(t))}function ct(t,e){const a=T.transition().duration(n);var d=[];N.selectAll(".standardNode").filter((function(t,n){return 0===e.size||e.has(t.data.nodeid)})).data(t.filter((t=>t.depth)),(t=>t.data.nodeid)).join((t=>t.append("g").on("touchstart",(function(t,e){f=d3.timeout((()=>function(t){v=!0,M(t)}(e)),500),t.preventDefault(),v=!1,x=!1})).on("touchmove",(function(t,e){f.stop()})).on("touchend",(function(t,e){f.stop(),v=!1})).call(nodeDragListener).style("touch-action","auto").attr("transform",(t=>`translate(${t.x},${t.y})`)).attr("fill-opacity",1).attr("stroke-opacity",1).attr("id",(t=>"node"+t.data.nodeid)).attr("fill",(t=>t.data.fill)).attr("cursor","pointer").classed("standardNode",!0).on("mouseenter",(function(t,e){d3.select("#contextmenu"+e.data.nodeid).empty()&&!x&&(et(),X(e),document.activeElement!==document.getElementById("divid"+e.data.nodeid)&&at(e))})).on("mouseleave",(function(t){d3.selectAll(".nodecontextmenu").remove()})).on("click",(function(t,e){t.srcElement.id.startsWith("divid")||at(e),t.stopPropagation()})).each((function(e){return d3.select(this).append("rect").attr("id",(t=>"rectid"+t.data.nodeid)).attr("class","noderect").attr("width",(t=>t.data.width)).attr("height",(t=>t.data.height)).attr("rx",2).attr("ry",2).attr("stroke","#cce9e5"),d3.select(this).append("foreignObject").attr("id",(t=>"foid"+t.data.nodeid)).attr("class","nodefo").attr("width",(t=>t.data.width)).attr("height",(t=>t.data.height)).each((function(t){d3.select(this).append("xhtml:div").attr("id",(t=>"divid"+t.data.nodeid)).attr("tabindex",(t=>t.data.nodeid)).attr("contenteditable","true").attr("class","flexdiv").style("font",(t=>t.data.fontsizepx+"px sans-serif")).html((t=>t.data.name)).on("touchend",(function(t,e){window.touchTrigger=!0,window.touchedData=e,this.click(t,e)})).on("mousedown",(function(t){y===this.id&&t.stopPropagation()})).on("click",(function(t,e){!y===this.id&&nt(e),y=this.id})).on("blur",(function(t,e){y="",e.data.name!==this.innerHTML&&(e.data.name=this.innerHTML,W(!0,"UpdateText",e.data.nodeid,this.innerHTML))})).on("keydown",(function(t,e){dt(e),t.stopPropagation()})).on("keyup",(function(t,e){if(e.data.autosize){var n=this.scrollHeight,a=!1;window.isScreenSmall?n>o&&e.data.height!==n&&(a=!0):e.data.height!==n&&(a=!0),a&&(e.data.height=n,L([{nodeid:e.data.nodeid,height:e.data.height,width:e.data.width,autosize:e.data.autosize}],!0),d3.select("#rectid"+e.data.nodeid).attr("height",e.data.height),d3.select("#foid"+e.data.nodeid).attr("height",e.data.height),d3.select("#highlightRect"+e.data.nodeid).attr("height",e.data.height+l),d3.select("#resizehandle"+e.data.nodeid).attr("cy",e.data.height),d3.select("#proximityrect"+e.data.nodeid).attr("height",e.data.height+s))}})).on("paste",(function(t,e){if(e.data.autosize){var n=this;setTimeout((function(){n.dispatchEvent(new Event("keyup"))}))}}))})),d3.select(this).append("circle").attr("id",(t=>"resizehandle"+t.data.nodeid)).attr("cx",(t=>t.data.width)).attr("cy",(t=>t.data.height)).attr("class","resizehandle").attr("r",7).attr("fill",(t=>t.data.fill)).call(D),d3.select(this).append("rect").attr("class","highlightRect").attr("id",(t=>"highlightRect"+t.data.nodeid)).attr("transform","translate(-3,-3)").attr("width",(t=>t.data.width+6)).attr("height",(function(t){if(t.data.autosize&&d3.select("#divid"+t.data.nodeid).node()){var e=d3.select("#divid"+t.data.nodeid).node().scrollHeight,n=!1;window.isScreenSmall?e>o&&t.data.height!==e&&(n=!0):t.data.height!==e&&(n=!0),n&&(t.data.height=e,d.push(t.data),d3.select("#rectid"+t.data.nodeid).attr("height",t.data.height),d3.select("#resizehandle"+t.data.nodeid).attr("cy",t.data.height),d3.select("#foid"+t.data.nodeid).attr("height",t.data.height))}return t.data.height+l})).attr("rx",2).attr("ry",2).attr("opacity",.2).style("fill","red").attr("pointer-events","none"),t}))),(t=>t.attr("transform",(t=>`translate(${t.x},${t.y})`)).attr("fill",(t=>t.data.fill)).attr("class",(t=>t.data.cssClass)).each((function(t){d3.select(this).select(".flexdiv").style("font",(t=>t.data.fontsizepx+"px sans-serif")),d3.select(this).select(".noderect").attr("height",(function(t){if(t.data.autosize){var e=d3.select("#divid"+t.data.nodeid).node().scrollHeight,n=!1;window.isScreenSmall?e>o&&t.data.height!==e&&(n=!0):t.data.height!==e&&(n=!0),n&&(t.data.height=e,d.push(t.data))}return t.data.height})).attr("width",(t=>t.data.width)),d3.select(this).select(".nodefo").attr("height",(t=>t.data.height)).attr("width",(t=>t.data.width)),d3.select(this).select(".resizehandle").attr("cx",(t=>t.data.width)).attr("cy",(t=>t.data.height)),d3.select(this).select(".highlightRect").attr("height",(t=>t.data.height+l)).attr("width",(t=>t.data.width+l)),d3.select(this).select(".linklump").attr("cx",(t=>t.data.width/2))}))),(t=>{t.call((t=>t.transition(a).remove().attr("transform",(t=>"translate(676,4)")).attr("fill-opacity",0).attr("stroke-opacity",0)))})),d.length>0&&L(d,!0)}function lt(t,n){I.selectAll(".gpath").filter((function(t,e){return function(t,e){return 0===e.size||1===e.size&&"0"===e.$0||e.has(t.target.data.nodeid)&&e.has(t.source.data.nodeid)}(t,n)})).data(t,(t=>t)).join((function(t){var e=t.append("g").attr("id",(t=>"gpathlink-"+t.source.data.nodeid+"-"+t.target.data.nodeid)).classed("gpath",!0);e.append("path").call(linkDragListener).classed("link",!0).attr("id",(t=>"link-"+t.source.data.nodeid+"-"+t.target.data.nodeid)).attr("d",(t=>0===t.source.data.nodeid?null:a({source:t.source.data.midpointconnections[t.target.data.parentNodeConnection],target:t.target.data.midpointconnections[t.target.data.connection]}))),e.append("path").call(linkDragListener).classed("linkborder",!0).attr("id",(t=>"linkborder-"+t.source.data.nodeid+"-"+t.target.data.nodeid)).attr("d",(t=>0===t.source.data.nodeid?null:a({source:t.source.data.midpointconnections[t.target.data.parentNodeConnection],target:t.target.data.midpointconnections[t.target.data.connection]})))}),(t=>{t.attr("id",(t=>"gpathlink-"+t.source.data.nodeid+"-"+t.target.data.nodeid)),t.select(".link").attr("id",(t=>"link-"+t.source.data.nodeid+"-"+t.target.data.nodeid)).attr("d",(t=>0===t.source.data.nodeid?null:a({source:t.source.data.midpointconnections[t.target.data.parentNodeConnection],target:t.target.data.midpointconnections[t.target.data.connection]}))),t.select(".linkborder").attr("id",(t=>"linkborder-"+t.source.data.nodeid+"-"+t.target.data.nodeid)).attr("d",(t=>0===t.source.data.nodeid?null:a({source:t.source.data.midpointconnections[t.target.data.parentNodeConnection],target:t.target.data.midpointconnections[t.target.data.connection]})))}),(t=>{t.call((t=>t.remove()))})),function(t,n){var a=function(t){return 0===t.size||1===t.size&&"0"===t.$0?e.links():e.links().filter((e=>t.has(e.target.data.nodeid)&&1===e.target.depth))}(n);S.selectAll(".linklump").filter((function(t,e){return 0===n.size||n.has(t.target.data.nodeid)})).data(a.filter((t=>t.target.data.nodeid))).join((t=>t.append("image").call(linkDragListener).attr("transform",(t=>`translate(${t.target.x+t.target.data.width/2-4},${t.target.y-8})`)).attr("width",9).attr("height",9).attr("class","linklump").attr("id",(t=>"linklump"+t.target.data.nodeid)).style("color",(t=>t.target.data.fill)).attr("xlink:href","./css/open-iconic/icons/caret-top.svg")),(t=>t.attr("transform",(t=>`translate(${t.target.x+t.target.data.width/2+-4},${t.target.y-8})`))),(t=>t.remove()))}(0,n)}function ut(t,e){E.selectAll(".proximityRect").filter((function(t,n){return 0===e.size||e.has(t.data.nodeid)})).data(t.filter((t=>t.depth)),(t=>t.data.nodeid)).join((t=>t.append("rect").classed("proximityRect",!0).attr("id",(t=>"proximityrect"+t.data.nodeid)).attr("transform",(t=>`translate(${t.x-r/2},${t.y-s/2})`)).attr("width",(t=>t.data.width+r)).attr("height",(t=>t.data.height+s)).attr("opacity",0).style("fill","grey").on("mousemove",(function(t,e){!function(t,e){DotNet.invokeMethodAsync("MapMyTime","GetParentNodeIdFromProximalNodeAsync",t,d3.pointers(e,document.getElementsByTagName("g")[0])[0]).then((function(t){P(t)}))}(e.data.nodeid,t)})).on("mouseout",(function(t){t.relatedTarget&&d3.select(t.relatedTarget).classed("proximityRect")||(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1))})).on("mouseenter",(function(){d3.select(".node-menu").remove(),d3.selectAll(".asyncflag").classed("asyncflag",!1)}))),(t=>t.attr("transform",(t=>`translate(${t.x-r/2},${t.y-s/2})`)).attr("width",(t=>t.data.width+r)).attr("height",(t=>t.data.height+s))),(t=>t.remove()))}!async function(){var t=document.getElementById("svg");t&&document.getElementById("d3SVGdiv").removeChild(t);await async function(){await O("defaultwidth"),l=await O("highlightrectboundary"),c=await O("defaultfontsize"),p=await O("defaultnodetext"),s=await O("proximityrectheight"),r=await O("proximityrectwidth");let t=await W(window.mapHasChanged,"GetContextMenuItems");h=JSON.parse(t)}(),m=G().items(h),o=function(){N.append("foreignObject").attr("height",20).attr("width",60).attr("x",-1e3).attr("y",-1e3).classed("tempfo nodefo",!0).append("xhtml:div").attr("id","defaultnodeheightdiv").attr("contenteditable","true").text("temp").classed("flexdiv tempdiv",!0).style("font-size",c),document.getElementById("d3SVGdiv").appendChild(b.node());let t=d3.select("#defaultnodeheightdiv").node().scrollHeight;return d3.selectAll(".tempdiv, .tempfo").remove(),document.getElementById("d3SVGdiv").removeChild(b.node()),K(window.mapHasChanged,"SetCalculatedNodeHeight",t),t}(),window.D3TimeMapUtilities.setSmallScreen(),window.isScreenSmall&&(o*=2);d&&rt();document.getElementById("d3SVGdiv").appendChild(b.node()),b.call(C.transform,d3.zoomIdentity.translate(e.data.xTranslate,e.data.yTranslate).scale(e.data.scale)),b.append("image").attr("id","saveIcon").classed("saveicon img-responsive",!0).attr("width",(function(){return window.isScreenSmall?"35":"25"})).attr("height",(function(){return window.isScreenSmall?"35":"25"})).attr("cursor","pointer").attr("xlink:href","./css/open-iconic/icons/data-transfer-download.svg").attr("alt","download").on("click touchstart",(function(t){K(!1,"DownloadMap"),t.stopPropagation()})),window.D3TimeMapUtilities.positionIcons(),d||function(){const t=new Set;ct(e.descendants(),t),lt(e.links(),t),ut(e.descendants(),t),K(window.mapHasChanged,"ClearChangedNodeSet")}();Z(!1)}()}},window.addEventListener("resize",window.D3TimeMapUtilities.positionIcons),window.addEventListener("beforeunload",(function(t){window.mapHasChanged&&(t.preventDefault(),t.returnValue="")})),window.authUtilities={setConstants:function(){window.easyAuthInfo=null,window.functionAppBaseUrl="https://mapmytimeauth.azurewebsites.net/"},clearEasyAuth:function(t){null!==easyAuthInfo&&easyAuthInfo.provider===t&&(easyAuthInfo=null)},getEasyAuthToken:function(){return null===easyAuthInfo?null:easyAuthInfo.token},clearLog:function(){},log:function(t){alert(t)},translateAuthToken:function(t,e){this.sendRequest({method:"POST",url:`${functionAppBaseUrl}.auth/login/${t}`,headers:{accept:"application/json","content-type":"application/json"},body:e},(function(){log(`EasyAuth response (${t}): ${this.responseText}`);var e=JSON.parse(this.responseText);easyAuthInfo={provider:t,token:e.authenticationToken}}))},callIsAuthenticated:function(){window.authUtilities.sendRequest({method:"GET",url:`${functionAppBaseUrl}api/IsAuthenticated`,headers:{accept:"application/json","content-type":"application/json","X-ZUMO-AUTH":window.authUtilities.getEasyAuthToken()}},(function(){window.authUtilities.log(`Response from IsAuthenticated: ${this.responseText}`)}))},callGetClaims:function(){sendRequest({method:"GET",url:`${functionAppBaseUrl}api/GetClaims`,headers:{accept:"application/json","content-type":"application/json","X-ZUMO-AUTH":getEasyAuthToken()}},(function(){log(`Response from GetClaims: ${this.responseText}`)}))},callGetAuthInfo:function(){sendRequest({method:"GET",url:`${functionAppBaseUrl}api/GetAuthInfo`,headers:{accept:"application/json","content-type":"application/json","X-ZUMO-AUTH":getEasyAuthToken()}},(function(){log(`Response from GetAuthInfo: ${this.responseText}`)}))},callGetEmail:function(){sendRequest({method:"GET",url:`${functionAppBaseUrl}api/GetEmailClaim`,headers:{accept:"application/json","content-type":"application/json","X-ZUMO-AUTH":getEasyAuthToken()}},(function(){log(`Response from GetEmail: ${this.responseText}`)}))},callAuthMe:async function(){return await window.authUtilities.getAsync(window.functionAppBaseUrl+".auth/me",{accept:"application/json","content-type":"application/json"})},callAuthLogout:function(){sendRequest({method:"GET",url:`${functionAppBaseUrl}.auth/logout`,headers:{accept:"application/json","content-type":"application/json","X-ZUMO-AUTH":getEasyAuthToken()}},(function(){log("called .auth/logout")}))},getAsync:async function(t,e){let n=await fetch(t,{headers:e});return n.ok?await n.json():await n.status},sendRequest:function(t,e){var n=new XMLHttpRequest;for(header in n.open(t.method,t.url),t.headers)n.setRequestHeader(header,t.headers[header]);n.onload=e;var a=t.body;return null!=a&&"string"!=typeof a&&(a=JSON.stringify(a)),n.send(a),n.responseText}};