window.TimeMapUtilities={getBoundengRectOffset:function(n){const t=document.getElementById(n).getBoundingClientRect();return{left:t.left+window.scrollX,top:t.top+window.scrollY}},saveAsFile:function(n,t){var r=prompt("Please enter a file name",n),i;r&&(i=document.createElement("a"),i.download=r+".json",i.href="data:application/octet-stream;base64,"+t,document.body.appendChild(i),i.click(),document.body.removeChild(i),DotNet.invokeMethod("MapMyTime","UpdateText",0,r))},openURL:function(){return prompt("Enter a link to Json file to dowload","https://MapMyTime/MapMyTime.json")},runFileInput:function(n){n.value="";n.click()},alertMessage:function(n){alert(n)},updateURLwithoutReload:function(n){window.history.pushState("data","Map My Time",n)}};window.D3TimeMapUtilities={positionIcons:function(){var n=document.getElementById("svg");if(n){var t=n.getBoundingClientRect(),r=document.getElementById("saveIcon"),u=r.getBoundingClientRect(),i=n.createSVGPoint();if(i.y=t.top+4,i.x=t.right-u.width-4,r.setAttribute("x",i.matrixTransform(n.getScreenCTM().inverse()).x),r.setAttribute("y",i.matrixTransform(n.getScreenCTM().inverse()).y),window.touchTrigger){let i=d3.zoomTransform(n),r=i.x+window.touchedData.x0*i.k+t.width/2,u=i.y+window.touchedData.y0*i.k+t.width/2;d3.select("topGroup").transition().duration(500).attr("transform","translate("+r+","+u+") scale("+i.k+")");window.touchTrigger=!1}}window.D3TimeMapUtilities.setSmallScreen()},setSmallScreen:function(){window.isScreenSmall=document.body.clientWidth<768?!0:!1},createD3Tree:function(n){function ct(n,i){DotNet.invokeMethodAsync("MapMyTime","AddNewNodeAsync",i,n,s).then(n=>{var i=d3.hierarchy(JSON.parse(n)),r,u=d3.select("#node"+i.data.parentNodeId);r=u.empty()?t:u.datum();i.x0=i.x=i.data.xCoordinate;i.y0=i.y=i.data.yCoordinate;i.depth=i.data.nodedepth;i.parent=r;r.children||(r.children=[],r.data.children=[]);r.children.push(i);r.data.children.push(i.data);f();o();d||b(i);d=!1})}function wt(n){var t=d3.selectAll(".show");(t.size()!==1||t.datum().data.nodeid!==n)&&d3.selectAll(".asyncflag").empty()&&(t.classed("show",!1),d3.select("#highlightRect"+n).classed("show",!0))}function ai(){function s(t){d3.select(".node-menu").remove();let s=t.data.autosize;h||c(t.data.nodeid,10);var i=kt(t.data.nodeid);rt.append("g").attr("class","node-menu").on("click",function(){d3.event.stopPropagation()}).on("mouseleave",()=>{d3.select(".node-menu").remove(),d3.selectAll(".nodetobechanged").classed("nodetobechanged",!1)}).attr("transform",()=>`translate(${t.x+t.data.width-20},${t.y})`).selectAll("tmp").data(d3.entries(o).filter(function(n){return n.value.attributename==="autosize"?!s:!0}),n=>n.value.menutext).join(function(o){var s=o.append("g").attr("class","menu-entry"),h,c;s.append("rect").attr("id",n=>"menurect"+n.value.attributename).attr("y",function(t,i){return i*n}).attr("width",r+e).attr("height",n).attr("data-fillcolour",t.data.fill).attr("data-nodeid",t.data.nodeid).classed("menurect",!0);s.append("text").text(n=>n.value.menutext).attr("y",function(t,i){return i*n}).attr("dy",(n-u/2)*.75).attr("dx",u).classed("menutext",!0);h=s.append("foreignObject").attr("id",n=>n.value.attributename).on("keyup",function(n){ki(n,t.data.nodeid)}).attr("x",function(n){if(n.value.attributename!=="deletebutton")return r}).attr("y",function(t,i){return i*n}).attr("width",function(n){return n.value.attributename==="deletebutton"?r+e:e}).attr("height",n).attr("data-menuparent",n=>n.value.menuparent);c=h.append(h.attr("data-menuparent")).attr("data-menuelement",n=>n.value.menuelement).attr("class","contextmenudiv");c.append(c.attr("data-menuelement")).attr("type",n=>n.value.menutype).attr("id",n=>"menuel"+n.value.attributename).classed("menuerange",n=>n.value.menutype==="range").classed("menucheckbox",n=>n.value.menutype==="checkbox").classed("trashbutton",n=>n.value.attributename==="deletebutton").attr("width",function(n){return n.value.menutype==="color"?e:n.value.menutype==="button"?e:null}).text(function(n){return n.value.menutype==="button"?"Delete":null}).attr("value",function(n){return n.value.menutype==="checkbox"?null:n.value.menutype==="button"?"Delete":Reflect.get(t.data,n.value.attributename)}).property("checked",function(n){return n.value.menutype==="checkbox"?Reflect.get(t.data,n.value.attributename):!1}).attr("min",function(n){return n.value.menutype==="range"?n.value.minvalue:null}).attr("max",function(n){return n.value.menutype==="range"?n.value.maxvalue:null}).attr("step",function(n){return n.value.menutype==="range"?1:null}).attr("data-nodeid",()=>t.data.nodeid).on("input",function(n){d3.event.stopPropagation();n.value.menutype==="checkbox"?(DotNet.invokeMethod("MapMyTime",n.value.dotnetmethod,this.dataset.nodeid,this.checked),Reflect.set(d3.select("#node"+this.dataset.nodeid).datum().data,n.value.attributename,this.checked),i=kt(this.dataset.nodeid)):(tr(n.value.dotnetmethod,i,this.value),n.value.menutype==="color"&&di(i,this.value),n.value.attributename==="fontsizepx"?ni(i,parseInt(this.value)):(bt(),f()))}).on("keydown",function(){(d3.event.key==="ArrowUp"||d3.event.key==="ArrowDown")&&d3.event.preventDefault()}).on("mousedown",function(){d3.event.stopPropagation()}).on("change",function(n){n.value.attributename==="fontsizepx"&&ni(i,parseInt(this.value))}).on("mouseenter focus",function(n){if(d3.select("#menurect"+n.value.attributename).attr("filter","url(#makebrighterfilter)"),n.value.attributename==="deletebutton")ri(i,!0);else return null}).on("mouseleave blur",function(n){if(d3.select("#menurect"+n.value.attributename).attr("filter",null),n.value.attributename==="deletebutton")ri(i,!1);else return null}).on("mouseup",function(n){if(n.value.attributename==="deletebutton")ir(this.dataset.nodeid);else return null})})}function c(i,f){var s,c,l;u=.1;d3.select("#node"+i).selectAll("temptext").data(d3.entries(o)).enter().append("text").text(function(n){return n.value.menutext}).attr("x",-1e3).attr("y",-1e3).attr("class","temptext").style("font-size",f);s=d3.selectAll(".temptext").nodes().map(function(n){return n.getBBox()});r=d3.max(s.map(function(n){return n.width}));u=u*r;r=r+2*u;n=d3.max(s.map(function(n){return(n.height+u/2)*2}));c=d3.select("#node"+i).append("foreignObject").attr("width",r*.5).attr("height",n).attr("class","tempfo");l=c.append("xhtml:div").attr("class","contexmenuflexdiv");l.append("xhtml:input").attr("type","color").attr("value","#007BFF").attr("class","tempinput");e=d3.select(".tempinput").node().getBoundingClientRect().width/t.data.scale;d3.selectAll(".temptext,.tempfo").remove();h=!0}var n,r,u=.1,o=[],e,h=!1;return s.items=function(){if(!arguments.length)return o;for(i in arguments[0])o.push(arguments[0][i]);return rescale=!0,s},s}async function vi(){var n=document.getElementById("svg");n&&document.getElementById("d3SVGdiv").removeChild(n);await pi();pt=ai().items(c);s=yi();window.D3TimeMapUtilities.setSmallScreen();window.isScreenSmall&&(s=s*2);f();document.getElementById("d3SVGdiv").appendChild(u.node());u.call(st.transform,d3.zoomIdentity.translate(t.data.xTranslate,t.data.yTranslate).scale(t.data.scale));bi();window.D3TimeMapUtilities.positionIcons();et||f()}function yi(){var t=rt.append("foreignObject").attr("height",20).attr("width",60).attr("x",-1e3).attr("y",-1e3).classed("tempfo nodefo",!0);t.append("xhtml:div").attr("id","defaultnodeheightdiv").attr("contenteditable","true").text("temp").classed("flexdiv tempdiv",!0).style("font-size",vt);document.getElementById("d3SVGdiv").appendChild(u.node());let n=d3.select("#defaultnodeheightdiv").node().scrollHeight;return d3.selectAll(".tempdiv, .tempfo").remove(),document.getElementById("d3SVGdiv").removeChild(u.node()),DotNet.invokeMethod("MapMyTime","SetCalculatedNodeHeight",n),n}async function pi(){ei=await v("defaultwidth");k=await v("highlightrectboundary");vt=await v("defaultfontsize");ot=await v("defaultnodetext");e=await v("proximityrectheight");h=await v("proximityrectwidth");c=await v("contextmenuitems")}async function v(n){return await DotNet.invokeMethodAsync("MapMyTime","GetConstantAsync",n)}function bt(){t=d3.hierarchy(JSON.parse(DotNet.invokeMethod("MapMyTime","GetTimeMapJson")));g(t)}async function kt(n){return await DotNet.invokeMethodAsync("MapMyTime","ReturnNodesToChangeAsync",n)}function wi(n){let t=[];n.forEach(n=>{let i={nodeid:n.nodeid,height:n.height,width:n.width,autosize:n.autosize};t.push(i)});lt(t)}async function lt(n){let t=await DotNet.invokeMethodAsync("MapMyTime","UpdateNodeDimensionsAsync",n);t.forEach(n=>{var t=d3.select("#node"+n.nodeid).datum().data;t.midpointconnections=n.midpointconnections;t.parentNodeConnection=n.parentnodeconnection;t.connection=n.connection});ui()}function g(n){n.descendants().forEach(n=>{n.data.nodeid===0&&t.data.children.length===0?(n.x0=n.x=350,n.y0=n.y=255,et=!0):(n.x0=n.x=n.data.xCoordinate,n.y0=n.y=n.data.yCoordinate,n.depth=n.data.nodedepth,et=!1)})}function bi(){u.append("image").attr("id","saveIcon").classed("saveicon img-responsive",!0).attr("width",function(){return window.isScreenSmall?"35":"25"}).attr("height",function(){return window.isScreenSmall?"35":"25"}).attr("cursor","pointer").attr("xlink:href","./css/open-iconic/icons/data-transfer-download.svg").attr("alt","download").on("click",function(){DotNet.invokeMethod("MapMyTime","DownloadMap");d3.event.stopPropagation()})}function dt(n){var i=d3.select("#node"+n.data.nodeid).append("g").attr("class","nodecontextmenu").attr("id","contextmenu"+n.data.nodeid),t;i.append("rect").attr("transform",()=>`translate(${0},${-20})`).attr("width",()=>n.data.width).attr("height",20).attr("opacity",0).on("click",function(){d3.event.stopPropagation()});t=i.append("g");t.append("path").attr("id","contextmenuicon").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("fill","#a1d7ce").attr("class","contextmenuicon").attr("stroke-width","0.0").attr("d","M 3.12,8.33 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 C 17.67,6.52 17.17,6 16.55,6 H 3.12 C 2.50,6 2,6.52 2,7.17 c 0,0.64 0.5,1.17 1.12,1.17 z M 16.55,10.67 H 3.12 C 2.5,10.67 2,11.19 2,11.83 2,12.48 2.5,13 3.12,13 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 0,-0.64 -0.5,-1.17 -1.12,-1.17 z m 0,4.67 H 3.12 C 2.5,15.33 2,15.856 2,16.5 c 0,0.64 0.5,1.17 1.12,1.17 H 16.55 c 0.62,0 1.12,-0.52 1.12,-1.17 0,-0.64 -0.5,-1.17 -1.12,-1.17 z");t.append("rect").attr("transform",()=>`translate(${n.data.width-20},${-20})`).attr("width","20").attr("height","20").attr("fill","none").attr("pointer-events","visible").on("mouseenter",function(){gt(n)}).on("touchstart",function(){if(d3.select("#contextmenuicon").classed("closeicon"))o();else{const n=new Event("mouseenter");this.dispatchEvent(n)}d3.event.preventDefault();d3.event.stopPropagation()}).on("mousedown",function(){d3.select("#contextmenuicon").classed("closeicon")&&o();d3.event.stopPropagation()})}function gt(n){d3.select(".node-menu").empty()&&(d3.select("#contextmenuicon").attr("d","M 2.4803522,7.9936028 14.980252,17.295964 c 0.577062,0.429447 1.526422,0.415594 2.131407,-0.03464 0.595676,-0.4433 0.614291,-1.149809 0.03723,-1.579254 L 4.6489879,6.3797158 C 4.0719266,5.9502695 3.1225664,5.9641226 2.5175821,6.4143486 1.9219052,6.857648 1.8939827,7.5710831 2.4710447,8.0005294 Z M 15.028871,6.3866424 2.5289651,15.689003 c -0.5770619,0.429447 -0.558447,1.135955 0.046537,1.586182 0.5956768,0.443299 1.5450368,0.457152 2.1220988,0.02771 L 17.197508,8.0005294 C 17.774571,7.5710831 17.755956,6.8645746 17.150971,6.4143486 16.555294,5.9710491 15.596625,5.9502695 15.019564,6.3797158 Z"),d3.select("#contextmenuicon").classed("closeicon",!0),pt(n),document.getElementById("menuel"+c[0].attributename).focus());d3.event.stopPropagation()}function ki(n,t){if(d3.event.key==="ArrowUp"){let i=c.findIndex(t=>t.attributename===n.value.attributename);i===0?(o(),document.getElementById("divid"+t).focus()):document.getElementById("menuel"+c[i-1].attributename).focus()}if(d3.event.key==="ArrowDown"){let r=c.findIndex(t=>t.attributename===n.value.attributename),i=document.getElementById("menuel"+c[r+1].attributename);i?i.focus():(o(),document.getElementById("divid"+t).focus())}}function di(n,t){n.then(function(n){n.forEach(n=>{d3.select("#node"+n).attr("fill",t).datum().data.fill=t})})}function ni(n,t){n.then(function(n){n.forEach(n=>{var i=d3.select("#node"+n);i.datum().data.fontsizepx=t});f()})}function gi(n,t,i){let u=DotNet.invokeMethod("MapMyTime","SwitchParent",[n,t,i]),r=d3.hierarchy(JSON.parse(u));r.data.parentNodeId===i?nr(n,t,i,r):f()}function ti(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();r.children.splice(r.children.findIndex(t=>t.data.nodeid===parseInt(n)),1);r.data.children.splice(r.data.children.findIndex(t=>t.nodeid===parseInt(n)),1)}function ii(n,i){var r;r=i===0?t:d3.select("#node"+i).datum();n.parent=r;r.children||(r.children=[]);r.children.push(n);r.data.children.push(n.data)}function nr(n,t,i,r){g(r);ti(n,t);ii(r,i);f()}async function tr(n,t,i){let r=await t;await DotNet.invokeMethodAsync("MapMyTime",n,r,i)}function ri(n,t){n.then(function(n){n.forEach(n=>{t?d3.select("#node"+n).attr("filter","url(#deletenodefilter)"):d3.select("#node"+n).attr("filter",null)})})}function ir(n){let t=d3.select("#node"+n).datum().data.parentNodeId,i=DotNet.invokeMethod("MapMyTime","DeleteNode",n);ti(n,t);i.length>0&&i.forEach(n=>{let i=d3.hierarchy(JSON.parse(n));g(i);ii(i,t)});o();f()}function o(){d3.selectAll(".node-menu").remove();d3.selectAll(".nodecontextmenu").remove()}function rr(n){if(n.data.name.startsWith(ot)){b(n);return}let t,i,u,f,r;if(document.caretPositionFromPoint?(t=document.caretPositionFromPoint(d3.event.clientX,d3.event.clientY),i=t.offsetNode,u=t.offset):document.caretRangeFromPoint&&(t=document.caretRangeFromPoint(d3.event.clientX,d3.event.clientY),i=t.startContainer,u=t.startOffset),i)r=document.createRange(),f=window.getSelection(),r.setStart(i,u),r.collapse(!0),f.removeAllRanges(),f.addRange(r);else{b(n);document.getElementById("divid"+n.data.nodeid).focus();return}}function b(n){var t=document.getElementById("divid"+n.data.nodeid),r=window.getSelection(),i=document.createRange(),u=1;n.data.name.startsWith(ot)&&(u=0);i.setStart(t,u);i.setEnd(t,1);r.removeAllRanges();r.addRange(i);t.focus()}function ur(n){if(d3.event.altKey&&d3.event.shiftKey&&d3.event.key.startsWith("Arrow")){let t=DotNet.invokeMethod("MapMyTime","ProcessArrowEvent",d3.event.key,n.data.nodeid);if(t.navigatetoid>0){let n=d3.select("#node"+t.navigatetoid).datum();b(n)}else if(t.navigatetoid===0&&t.newnodeparentid!=0){let n=[t.x,t.y];ct(t.newnodeparentid,n)}}d3.event.altKey&&d3.event.key==="m"&&gt(n)}function f(){const i=t.descendants(),r=l.transition().duration(fi);var n=[];rt.selectAll(".standardNode").data(i.filter(n=>n.depth),n=>n.data.nodeid).join(function(t){var i=t.append("g").call(nodeDragListener).attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill-opacity",1).attr("stroke-opacity",1).attr("id",n=>"node"+n.data.nodeid).attr("fill",n=>n.data.fill).attr("cursor","pointer").classed("standardNode",!0).on("mouseenter",function(n){d3.select("#contextmenu"+n.data.nodeid).empty()&&!p&&(o(),dt(n),document.activeElement!==document.getElementById("divid"+n.data.nodeid)&&b(n))}).on("mouseleave",function(){d3.selectAll(".nodecontextmenu").remove()}).on("touchend",function(n){window.touchTrigger=!0;window.touchedData=n}).on("click",function(n){d3.event.srcElement.id.startsWith("divid")||b(n);d3.event.stopPropagation()}),r;i.append("rect").attr("id",n=>"rectid"+n.data.nodeid).attr("class","noderect").attr("width",n=>n.data.width).attr("height",n=>n.data.height).attr("rx",2).attr("ry",2).attr("stroke","#cce9e5");r=i.append("foreignObject").attr("id",n=>"foid"+n.data.nodeid).attr("class","nodefo").attr("width",n=>n.data.width).attr("height",n=>n.data.height);r.append("xhtml:div").attr("id",n=>"divid"+n.data.nodeid).attr("tabindex",n=>n.data.nodeid).attr("contenteditable","true").attr("class","flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif").html(n=>n.data.name).on("touchend",function(n){window.touchTrigger=!0;window.touchedData=n}).on("mousedown",function(){y===this.id&&d3.event.stopPropagation()}).on("click",function(n){!y===this.id&&rr(n);y=this.id}).on("blur",function(n){y="";n.data.name!==this.innerHTML&&(n.data.name=this.innerHTML,DotNet.invokeMethod("MapMyTime","UpdateText",n.data.nodeid,this.innerHTML))}).on("keydown",function(n){ur(n);d3.event.stopPropagation()}).on("keyup",function(n){if(n.data.autosize){var t=this.scrollHeight,i=!1;window.isScreenSmall?t>s&&n.data.height!==t&&(i=!0):n.data.height!==t&&(i=!0);i&&(n.data.height=t,lt([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}]),d3.select("#rectid"+n.data.nodeid).attr("height",n.data.height),d3.select("#foid"+n.data.nodeid).attr("height",n.data.height),d3.select("#highlightRect"+n.data.nodeid).attr("height",n.data.height+k),d3.select("#resizehandle"+n.data.nodeid).attr("cy",n.data.height),d3.select("#proximityrect"+n.data.nodeid).attr("height",n.data.height+e))}}).on("paste",function(n){if(n.data.autosize){var t=this;setTimeout(function(){t.dispatchEvent(new Event("keyup"))})}});return i.append("circle").attr("id",n=>"resizehandle"+n.data.nodeid).attr("cx",n=>n.data.width).attr("cy",n=>n.data.height).attr("class","resizehandle").attr("r",7).attr("fill",n=>n.data.fill).call(hi),i.append("rect").attr("class","highlightRect").attr("id",n=>"highlightRect"+n.data.nodeid).attr("transform","translate(-3,-3)").attr("width",n=>n.data.width+6).attr("height",function(t){if(t.data.autosize&&d3.select("#divid"+t.data.nodeid).node()){var i=d3.select("#divid"+t.data.nodeid).node().scrollHeight,r=!1;window.isScreenSmall?i>s&&t.data.height!==i&&(r=!0):t.data.height!==i&&(r=!0);r&&(t.data.height=i,n.push(t.data),d3.select("#rectid"+t.data.nodeid).attr("height",t.data.height),d3.select("#resizehandle"+t.data.nodeid).attr("cy",t.data.height),d3.select("#foid"+t.data.nodeid).attr("height",t.data.height))}return t.data.height+k}).attr("rx",2).attr("ry",2).attr("opacity",.2).style("fill","red").attr("pointer-events","none"),i},function(t){t.attr("transform",n=>`translate(${n.x},${n.y})`).attr("fill",n=>n.data.fill).attr("class",n=>n.data.cssClass);t.select(".flexdiv").style("font",n=>n.data.fontsizepx+"px sans-serif");t.select(".noderect").attr("height",function(t){if(t.data.autosize){var i=d3.select("#divid"+t.data.nodeid).node().scrollHeight,r=!1;window.isScreenSmall?i>s&&t.data.height!==i&&(r=!0):t.data.height!==i&&(r=!0);r&&(t.data.height=i,n.push(t.data))}return t.data.height}).attr("width",n=>n.data.width);t.select(".nodefo").attr("height",n=>n.data.height).attr("width",n=>n.data.width);t.select(".resizehandle").attr("cx",n=>n.data.width).attr("cy",n=>n.data.height);t.select(".highlightRect").attr("height",n=>n.data.height+k).attr("width",n=>n.data.width+k);t.select(".linklump").attr("cx",n=>n.data.width/2)},n=>n.call(n=>n.transition(r).remove().attr("transform",()=>`translate(${at-24},${4})`).attr("fill-opacity",0).attr("stroke-opacity",0)));n.length>0&&wi(n);ui();er(i)}function fr(n){si.selectAll(".linklump").data(n.filter(n=>n.target.depth===1),n=>n.target.data.nodeid).join(function(n){n.append("image").call(linkDragListener).attr("transform",n=>`translate(${n.target.x+n.target.data.width/2-4},${n.target.y-8})`).attr("width",9).attr("height",9).attr("class","linklump").attr("id",n=>"linklump"+n.target.data.nodeid).style("color",n=>n.target.data.fill).attr("xlink:href","./css/open-iconic/icons/caret-top.svg")},function(n){n.attr("transform",n=>`translate(${n.target.x+n.target.data.width/2+-4},${n.target.y-8})`)},function(n){n.remove()})}function ui(){const n=t.links();ht.selectAll("path").data(n,n=>n.target.id).join(function(n){n.append("path").call(linkDragListener).classed("link",!0).attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));n.append("path").call(linkDragListener).classed("linkborder",!0).attr("id",n=>"linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},function(n){n.attr("id",n=>"link-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",n=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}))},n=>n.call(n=>n.attr("d",n=>{const t={x:n.source.x,y:n.source.y};return r({source:t,target:t})}).remove()));fr(n)}function er(n){oi.selectAll(".proximityRect").data(n.filter(n=>n.depth),n=>n.data.nodeid).join(function(n){n.append("rect").classed("proximityRect",!0).attr("id",n=>"proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-h/2},${n.y-e/2})`).attr("width",n=>n.data.width+h).attr("height",n=>n.data.height+e).attr("opacity",0).style("fill","grey").on("mousemove",function(n){ci(n.data.nodeid)}).on("mouseout",function(){d3.event.relatedTarget?d3.select(d3.event.relatedTarget).classed("proximityRect")||(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1)):(d3.selectAll(".show").classed("asyncflag",!0),d3.selectAll(".highlightRect").classed("show",!1))}).on("mouseenter",function(){d3.select(".node-menu").remove();d3.selectAll(".asyncflag").classed("asyncflag",!1)})},function(n){n.attr("transform",n=>`translate(${n.x-h/2},${n.y-e/2})`).attr("width",n=>n.data.width+h).attr("height",n=>n.data.height+e)},function(n){n.remove()})}var t=d3.hierarchy(JSON.parse(n)),r,st,a;const fi=d3.event&&d3.event.altKey?2500:250;r=d3.linkHorizontal().x(function(n){return n.x}).y(function(n){return n.y});const at=700;g(t);var et,s,ei,h,e,vt,k,d=!1,y="",yt,ot,c,pt,nt=!1,p=!1,w=!1,tt,it;const u=d3.create("svg").attr("id","svg").attr("viewBox",[0,0,at,700]).style("font",t.data.fontsizepx+"px sans-serif").style("user-select","none").on("click",function(){var t,n;if(y!==""){document.getElementById(y).blur();return}t=d3.mouse(document.getElementsByTagName("g")[0]);d3.event.stopPropagation();let i=d3.select(".show");n=0;i.empty()||(n=i.datum().data.nodeid);ct(n,t)}).on("touchstart",function(){d3.event.touches.length===1&&(d3.event.touches[0].target.id.includes("svg")||d3.event.touches[0].target.id.includes("proximityrect"))&&(d=!0,yt=d3.mouse(document.getElementsByTagName("g")[0]))}).on("touchmove",function(){d=!1}).on("touchend",function(){if(d){var n=0;if(d3.event.changedTouches[0].target.id.includes("proximityrect")){let t=d3.select(d3.event.changedTouches[0].target).datum().data.nodeid;n=DotNet.invokeMethod("MapMyTime","GetParentNodeIdFromProximalNode",t,d3.mouse(document.getElementsByTagName("g")[0]))}ct(n,yt);d3.event.preventDefault()}});u.append("filter").attr("id","deletenodefilter").append("feGaussianBlur").attr("stdDeviation","5");u.append("filter").attr("id","makebrighterfilter").append("feColorMatrix").attr("type","matrix").attr("values","1.2 0 0 0 0 0 1.2 0 0 0 0 0 1.2 0 0 0 0 0 1 0");const l=u.append("g").attr("fill","none").attr("width","100%").attr("height","100%").attr("id","topGroup").attr("class","topGroup").on("mouseleave",function(){var n=d3.selectAll(".show");n.empty()||n.classed("show",!1)});st=d3.zoom().clickDistance(10).on("zoom",function(){w||d3.event.target.nodeName!=="PATH"&&l.attr("transform",d3.event.transform)}).on("end",function(){w||d3.event.target.nodeName!=="PATH"&&(d3.event.transform.k===1&&d3.event.transform.x===0&&d3.event.transform.y===0||(DotNet.invokeMethod("MapMyTime","UpdateTranslation",d3.event.transform),t.data.scale=d3.event.transform.k))});u.call(st).on("dblclick.zoom",null);const oi=l.append("g").attr("id","proximityrect"),ht=l.append("g").attr("id","linkgroup").attr("class","glink"),rt=l.append("g").attr("id","nodegroup"),si=l.append("g").attr("id","lumpgroup");nodeDragListener=d3.drag().on("start",function(n){var t,i,r;w=!0;p=!1;t=!1;d3.touches(this).length>1&&(t=!0,d3.event.sourceEvent.preventDefault());(d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey||t)&&(nt=!0,tt=0,it=0,i=l.append("g").attr("id","draggroup"),r=i.append("g").attr("id","linkdraggroup").attr("class","glink"),n.descendants().forEach(t=>{n.data.nodeid!=t.data.nodeid&&(i.append(function(){return d3.select("#node"+t.data.nodeid).remove().node()}),r.append(function(){return d3.select("#link-"+t.data.parentNodeId+"-"+t.data.nodeid).remove().node()}),r.append(function(){return d3.select("#linkborder-"+t.data.parentNodeId+"-"+t.data.nodeid).remove().node()}))}));d3.event.sourceEvent.stopPropagation()}).on("drag",function(n){if(window.touchTrigger=!1,w){p||(o(),p=!0);n.x+=d3.event.dx;n.y+=d3.event.dy;var t=d3.select("#node"+n.data.nodeid);if(t.attr("transform","translate("+n.x+","+n.y+")"),nt){if(n.data.parentNodeId!==0){let t=DotNet.invokeMethod("MapMyTime","UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0);d3.select("#link-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>r({source:t.linkendpoints[1],target:t.linkendpoints[0]}))}tt+=d3.event.dx;it+=d3.event.dy;d3.select("#draggroup").attr("transform","translate("+tt+","+it+")")}else{let t=DotNet.invokeMethod("MapMyTime","RecalculateMovedNodeLinks",n.data.nodeid,n.x,n.y);t.forEach(t=>{t.nodeid!==n.data.nodeid?d3.select("#link-"+n.data.nodeid+"-"+t.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]})):n.data.parentNodeId!==0&&d3.select("#link-"+n.data.parentNodeId+"-"+t.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]}))})}}}).on("end",function(n){var i,u;if(w&&(w=!1,p)){p=!1;n.data.xCoordinate=n.x0=n.x;n.data.yCoordinate=n.y0=n.y;let t=DotNet.invokeMethod("MapMyTime","UpdateImpactedNode",n.data.nodeid,n.x,n.y,!0);n.data.midpointconnections=JSON.parse(JSON.stringify(t.midpointconnections));n.data.parentNodeConnection=t.parentnodeconnection;n.data.connection=t.connection;n.data.parentNodeId===0?d3.select("#linklump"+n.data.nodeid).attr("transform",()=>`translate(${n.x+n.data.width/2-4}, ${n.y-8})`):d3.select("#linkborder-"+n.data.parentNodeId+"-"+n.data.nodeid).attr("d",()=>r({source:t.linkendpoints[0],target:t.linkendpoints[1]}));nt?(i=[],n.descendants().forEach(t=>{if(i.push(t.data.nodeid),n.data.nodeid!=t.data.nodeid){t.x=t.data.xCoordinate+=tt;t.y=t.data.yCoordinate+=it;let n=DotNet.invokeMethod("MapMyTime","UpdateImpactedNode",t.data.nodeid,t.x,t.y,!0);t.data.midpointconnections=JSON.parse(JSON.stringify(n.midpointconnections));t.data.parentNodeConnection=n.parentnodeconnection;t.data.connection=n.connection;ht.append(function(){var i=d3.select("#link-"+t.data.parentNodeId+"-"+t.data.nodeid);return i.attr("d",r({source:n.linkendpoints[0],target:n.linkendpoints[1]})),i.remove().node()});ht.append(function(){var i=d3.select("#linkborder-"+t.data.parentNodeId+"-"+t.data.nodeid);return i.attr("d",r({source:n.linkendpoints[0],target:n.linkendpoints[1]})),i.remove().node()});rt.append(function(){var n=d3.select("#node"+t.data.nodeid);return n.attr("transform","translate("+t.x+","+t.y+")"),n.remove().node()})}DotNet.invokeMethodAsync("MapMyTime","UpdateProximityMapAsync",i).then();d3.select("#proximityrect"+t.data.nodeid).attr("transform",()=>`translate(${t.x-h/2},${t.y-e/2})`)}),d3.select("#draggroup").remove(),nt=!1):(u=d3.selectAll("path").filter('[id^="link-'+n.data.nodeid+'-"]'),u.attr("d",n=>{let t=DotNet.invokeMethod("MapMyTime","UpdateImpactedNode",n.target.data.nodeid,n.target.x,n.target.y,!1);n.target.data.parentNodeConnection=t.parentnodeconnection;n.target.data.connection=t.connection;var i=r({source:t.linkendpoints[0],target:t.linkendpoints[1]});return d3.select("#linkborder-"+n.source.data.nodeid+"-"+n.target.data.nodeid).attr("d",i),i}),DotNet.invokeMethodAsync("MapMyTime","UpdateProximityMapAsync",[n.data.nodeid]).then(),d3.select("#proximityrect"+n.data.nodeid).attr("transform",n=>`translate(${n.x-h/2},${n.y-e/2})`));dt(n)}});a=-1;linkDragListener=d3.drag().on("start",function(n){d3.event.sourceEvent.type==="touchstart"&&d3.event.sourceEvent.preventDefault();const t=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid),i=n.target.data.midpointconnections[n.target.data.connection];t.classed("linkdragging",!0).attr("d",()=>{const n={x:d3.event.x,y:d3.event.y};return r({source:n,target:i})}).attr("pointer-events","none")}).on("drag",function(n){const u=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid);u.attr("d",()=>{const t={x:d3.event.x,y:d3.event.y};return r({source:t,target:n.target.data.midpointconnections[n.target.data.connection]})});var i=d3.mouse(d3.select("body").node()),t=document.elementFromPoint(i[0],i[1]);t&&t.id.includes("proximityrect")&&li(d3.select(t).datum().data.nodeid,n.target.data.nodeid)}).on("end",function(n){const i=d3.select("#link-"+n.source.data.nodeid+"-"+n.target.data.nodeid);i.classed("linkdragging",!1).attr("pointer-events","auto").attr("d",()=>{const t={x:d3.event.x,y:d3.event.y};return r({source:t,target:n.target.data.midpointconnections[n.target.data.connection]})});var t=d3.select(".show");if(t.empty()&&(t=d3.select(".nodecontextmenu")),a=t.empty()?0:t.datum().data.nodeid,a===n.target.data.nodeid&&(a=0),d3.selectAll(".show").classed("show",!1),a===n.source.data.nodeid){i.attr("d",()=>n.source.data.nodeid===0?null:r({source:n.source.data.midpointconnections[n.target.data.parentNodeConnection],target:n.target.data.midpointconnections[n.target.data.connection]}));return}gi(n.target.data.nodeid,n.source.data.nodeid,a)});var ut,ft,hi=d3.drag().on("start",function(n){d3.event.sourceEvent.stopPropagation();n.data.autosize=!1;ut=n.data.height;ft=n.data.width}).on("drag",function(n){ut+=d3.event.dy;ft+=d3.event.dx;let t=!1;ut>1&&(n.data.height=ut,t=!0);ft>1&&(n.data.width=ft,t=!0);t&&(lt([{nodeid:n.data.nodeid,height:n.data.height,width:n.data.width,autosize:n.data.autosize}]),d3.select("#foid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height),d3.select("#rectid"+n.data.nodeid).attr("width",n.data.width).attr("height",n.data.height))}).on("end",function(){bt();f()}),ci=function(n){DotNet.invokeMethodAsync("MapMyTime","GetParentNodeIdFromProximalNodeAsync",n,d3.mouse(document.getElementsByTagName("g")[0])).then(function(n){wt(n)})},li=function(n,t){DotNet.invokeMethodAsync("MapMyTime","GetConnectionNodeId",n,d3.mouse(document.getElementsByTagName("g")[0]),t).then(function(n){wt(n)})};vi()}};window.addEventListener("resize",window.D3TimeMapUtilities.positionIcons);